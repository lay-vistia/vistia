# Vistia 仕様書（SOT）
Version: 2026-01-31
Status: FIX + TBD 混在（TBDは明示）

この文書は「何をするか（プロダクト仕様）」を定義する。
実装方法は `DESIGN.md` に記載する。

---

## 0. 環境前提（FIX）

### 開発環境（FIX）
- GitHub Codespaces
- Amazon RDS（開発用DB）
  - 開発は直開放OK（ユーザー判断）

### 本番環境（FIX）
- AWS Amplify（Public / Manage / Admin のホスティング）
- Amazon RDS（本番DB）
- Amazon S3（画像保存：original + display + thumb）
- CloudFront（画像配信用）
- API Gateway + Lambda（API）
- SES（メール送信）
- リージョン：大阪（ap-northeast-3）

---

## 1. ドメイン（FIX）
- Public：`vistia.studio`
- Manage：`manage.vistia.studio`
- Admin：`admin.vistia.studio`
- API：`api.vistia.studio`
- 画像配信：`img.vistia.studio`

---

## 2. 認証（FIX）

### 2.1 Manage（FIX）
- ログイン方式：Email（Magic Link） / Google / X
- セッション：DBセッション（HttpOnly Cookie）
  - Cookie名：`manage_session`
  - SameSite=Lax
  - Secure本番ON

### 2.2 Admin（FIX）
- Manageと完全分離（別アプリ・別認証境界）
- ログイン方式：Email + Password + 2FA必須（TOTPのみ）
- バックアップコード：10個（初回のみ表示、再発行で旧無効）
- セッション：DBセッション（HttpOnly Cookie）
  - Cookie名：`admin_session`
  - SameSite=Strict
  - Secure本番ON
  - 有効期限：12時間
  - 無操作30分タイムアウト

---

## 3. セキュリティ（FIX）

### 3.1 CORS（FIX）
- 許可オリジン（本番）
  - `vistia.studio`
  - `manage.vistia.studio`
  - `admin.vistia.studio`

### 3.2 CSRF（FIX）
- Cookieセッション前提でCSRF対策を必須化
- 方式：Originチェック + Double Submit（詳細はDESIGNで規定）

---

## 4. 公開範囲（FIX）

### 4.1 Visibility（FIX）
- 作品（Work）：PUBLIC / UNLISTED / PRIVATE
- コレクション（Collection）：PUBLIC / UNLISTED / PRIVATE

### 4.2 UNLISTED（FIX）
- 作品/コレクション単位で限定URL tokenを自動発行
  - 無期限OK
- UNLISTED → PUBLIC/PRIVATE に戻したら token無効化（revoked）
- UNLISTEDの広告：通常公開と同じ扱い
- ページ全体（プロフィール）には限定URLを発行しない（作品/コレクション単位のみ）
- UNLISTED閲覧は「閉じた閲覧」
  - 通常のギャラリー導線/一覧導線は出さない
  - ユーザー名/アイコンは表示してOK

---

## 5. 表示UI（FIX）

### 5.1 プロフィール表示順（FIX）
1. アイコン
2. 表示名
3. bio
4. ピン（Proのみ）
5. YouTube（任意・1つ）
6. ギャラリーボタン（別ページ遷移）
7. Links（6件表示＋「もっと見る」）

### 5.2 ギャラリー（FIX）
- `@handle` → 「ギャラリーを見る」→ `@handle/gallery`
- 無限スクロール
- 作品詳細：モーダル、スワイプで次/前、ルール表記なし
- コレクション導線：ギャラリー上部に「コレクション」ボタン
  - `@handle/gallery?c={collectionId(UUID)}`

### 5.3 YouTube（FIX）
- 埋め込み再生：1つだけ

### 5.4 並び順（FIX）
- Publicギャラリーの並び順：新着順のみ
- Public検索：しない（見せたいものはコレクション方針）
- Manage検索：タグ検索のみ（後述）

### 5.5 handle / display_name ルール（FIX）
- handle
  - 文字：`a-z 0-9 _` のみ（小文字のみ）
  - 長さ：3〜20
  - 先頭：英字必須（数字開始不可）
  - 予約語禁止：`admin, manage, api, img, support, help, terms, privacy, about, pricing`
  - handle変更：30日に1回まで、年2回まで、旧handleは90日予約
- display_name
  - Unicode可（絵文字OK）
  - 長さ：1〜30文字
  - 正規化：前後トリム、連続空白は1つ

### 5.6 Links仕様（FIX：無制限・ラベル自由・説明文あり）
- Linksは無制限
- Publicプロフィール上は6件表示＋「もっと見る」（表示順仕様は維持）
- 各Linkは以下を持つ
  - `url`（必須）
  - `label`（必須・自由入力）
  - `description`（任意・自由入力）
  - `order_index`（並び順。ユーザーが並び替え可能）

#### 入力制約（FIX）
- `url`
  - httpsのみ許可（`http://` は拒否）
  - 前後トリム
  - URLとしてパースできないものは拒否
- `label`
  - 1〜30文字（Unicode可、絵文字OK）
  - 前後トリム、連続空白は1つ
- `description`
  - 0〜80文字（Unicode可）
  - 前後トリム、連続空白は1つ
- 重複
  - 同一URLの重複登録は禁止（ユーザー単位）

#### 表示・セキュリティ（FIX）
- 新規タブで開く（`noopener,noreferrer`）
- `label` / `description` はHTMLとして解釈しない（常にテキスト表示）

---

## 6. 作品（FIX）
- 1作品＝画像1枚
- タイトルなし
- タグ：最大3、各10文字
- 画像差し替え不可（削除→新規）
- 削除：論理削除 → 30日後パージ（ゴミ箱UI/復元UIなし）

---

## 7. ピン（FIX）
- Free：ピン無し
- Pro：ピン3つ
- ピン対象：作品のみ
- PUBLIC作品のみピン可
- ピンはモーダル表示なし、横スワイプで閲覧

---

## 8. コレクション（FIX）
- Proのみ
- コレクション数：無制限
- 作品の重複追加不可（collection_id, work_id unique）
- コレクション削除：作品は残る、紐づけだけ消す

### 8.1 混在ルール（FIX）
- PUBLICコレクション：PUBLIC作品のみ
- UNLISTEDコレクション：PUBLIC + UNLISTED作品
- PRIVATEコレクション：PUBLIC + UNLISTED + PRIVATE作品

### 8.2 整合ルール（FIX）
- コレクション側 visibility 変更で不整合が出る場合：ブロック
- 作品側 visibility 変更で不整合が出る場合：自動で該当コレクションから外す
  - in-app技術通知は出してOK

---

## 9. タグ・検索（FIX）
- Public検索：なし
- Manage検索：タグ完全一致のみ（AND）
  - サジェストなし
  - 正規化：前後トリム、連続空白1つ、case-insensitive重複統合

---

## 10. 広告（FIX）
- Free：広告あり / Pro：広告なし
- 追従固定バナー（ページ下部）
- UIにかぶってOK、モーダル中も表示

---

## 11. 保存抑止（FIX）
- 右クリック/長押し/ドラッグ等：サムネ含め全面抑止方針（ベストエフォート）
- 透かし：無し
- originalは絶対に表示しない（display/thumbのみ配信）

---

## 12. 画像仕様（FIX）

### 12.1 制約（FIX）
- 最大：50MB
- 同時アップロード：5枚まで（＝最大5作品作成）

### 12.2 許可形式（FIX：静止画のみ）
- 許可MIME/拡張子
  - image/jpeg（.jpg/.jpeg）
  - image/png（.png）
  - image/webp（.webp）
  - image/heic, image/heif（.heic/.heif）
- 不許可
  - image/gif：全面拒否（静止GIF含む）
  - その他（AVIF等）拒否
- 最大解像度：長辺12000pxまで（超過は拒否）

### 12.3 生成物（FIX）
- display：長辺1280px、WebP、メタデータ除去、Orientation正規化
- thumb：正方形、JPEG、メタデータ除去、Orientation正規化
- 透過PNGのthumb合成：白（#FFFFFF）

### 12.4 非同期処理（FIX）
- SQS + Lambda
- リトライ：5回
- 失敗時：再生成ボタン
- thumb再生成：thumbだけ再生成（入力はdisplay）

### 12.5 thumbトリミング（FIX）
- 中央固定ではなくフォーカス点指定
  - Manageで画像をタップしてフォーカス点設定（ドラッグ不要）
  - 未指定は中央

---

## 13. ストレージ（FIX）

### 13.1 バケット（FIX）
- `vistia-media-public`：display/thumb（配信用。CloudFront Origin）
- `vistia-media-private`：original（非配信用）

### 13.2 キー（FIX）
- original（private）
  - `original/work/{userId}/{workId}/{assetId}.{ext}`
  - `original/avatar/{userId}/{assetId}.{ext}`
- display（public）
  - `display/work/{userId}/{workId}/{assetId}.webp`
  - `display/avatar/{userId}/{assetId}.webp`
- thumb（public）
  - `thumb/work/{userId}/{workId}/{assetId}.jpg`
  - `thumb/avatar/{userId}/{assetId}.jpg`

### 13.3 originalライフサイクル（FIX）
- originalは1日後にコールドへ移行
- 自動削除はしない
- 作品パージ/ユーザーパージ時に関連オブジェクトを削除

---

## 14. 画像配信（FIX）
- 画像URL：`img.vistia.studio`（CloudFront）
- CloudFront → S3：OAC（S3公開OFF）
- Cache：不変URL前提で長期キャッシュ（immutable）
- 署名付きURL/Cookieは採用しない

---

## 15. チケット運用（FIX）
- 通報・自動検知：すべてチケット化
- 自動削除/自動BANなし（人が判断）
- 公開側は理由非表示（404等）
- 復旧/異議申立：同一チケットに `ticket_events` で積む
- 優先度：全部High

### 15.1 ticket_type（FIX）
- report
- nsfw_alert
- violence_gore_alert
- selfharm_alert
- abuse_storage_alert
- substance_alert（薬物のみ。タバコ/アルコールは対象外）
- manual

---

## 16. 自動検知の明記（AIという単語は禁止 / FIX）
規約・PP・ガイドラインにのみ記載（UIには出さない）：

> サービスの安全性維持のため、投稿されたコンテンツは自動的に検知・評価される場合があります。  
> ただし、これらの検知結果のみをもとに、コンテンツの削除やアカウントの停止が行われることはありません。  
> 最終的な判断は、運営が行います。

---

## 17. Rekognition → チケット起票（FIX）
- サブタイプはVistia側で持たない（L2/L3はpayload保存のみ）
- 実行タイミング：display生成成功後に1回だけ（thumb再生成では実行しない）
- 自動検知失敗時：画像はREADYでOK、manualチケット起票
- 起票マッピング：nsfw/violence/selfharm/substance（薬物のみ、タバコ/アルコール除外）
- 閾値は運用パラメータとして調整可能

---

## 18. ユーザー通知（FIX）
- in-app通知：必須（OFF不可）
- メール通知：任意メールのみOFF可
- アカウント系・運営重大操作・支払い失敗：強制メール

---

## 19. 通知テンプレ（FIX：DB管理＋Admin編集）
- reason_codeごとにテンプレをDB管理、Admin画面で編集可能
- テンプレの「無効化」＝メール送信OFF（in-appは常に出る）

### 19.1 権限（FIX）
- 編集：Ownerのみ
- 閲覧：Owner/Moderator/Support
- 送信：Support/Moderator（テンプレ＋追記）

### 19.2 プレースホルダ（FIX：最小）
- `{{display_name}}`, `{{handle}}`, `{{action}}`, `{{effective_at}}`

### 19.3 強制メール（テンプレのメールOFF不可 reason_code）（FIX）
- ACCOUNT_SUSPENDED
- ACCOUNT_RESTORED
- WORK_HIDDEN_BY_ADMIN
- WORK_DELETED_BY_ADMIN
- COLLECTION_HIDDEN_BY_ADMIN
- COLLECTION_DELETED_BY_ADMIN
- TOKEN_REVOKED
- PRO_GRANTED_MANUAL
- PRO_REVOKED_MANUAL
- SUBSCRIPTION_PAYMENT_FAILED

### 19.4 ユーザー側メール設定（FIX）
- `users.email_optional_enabled`（任意メールのみ）
- 判定
  - 強制メール：必ず送る（テンプレOFF不可、ユーザーOFF無視、バウンス抑止も無視）
  - 任意メール：テンプレON AND ユーザーON AND バウンスしてない

---

## 20. Admin RBAC（FIX）
- Owner：全権、Adminユーザー作成/権限変更はOwnerのみ
- Moderator：チケット対応、非公開/削除/token無効、ユーザー停止権限あり
- Designer：デザインマスタ管理のみ（デザインマスタは後回し）
- Support：閲覧中心＋通知送信（テンプレ＋追記）
- 重大操作（停止/解除、削除、Pro剥奪、token無効）：入力確認必須（スマホ前提）

---

## 21. Stripe（FIX）
- 課金手段：Stripeのみ
- Checkout/Portal/Webhook
- Admin：Stripe無しでPro付与/剥奪可能
- Webhook：署名検証、event_id冪等
- 手動Pro優先（実効 pro_until = max(stripe, manual)）

---

## 22. 削除/パージ（FIX）
- 作品：論理削除→token即revoked→collection_items即削除→30日後S3/DB削除
- コレクション：論理削除→token即revoked→30日後DB削除
- ユーザー退会：取り消し可
  - 退会：deleted_at, is_suspended, 全セッション破棄, Publicは404
  - 取り消し：30日以内OK（reactivateリンク、token 24h、最新のみ有効、発行上限1時間3回）
  - パージ時：Stripe購読が残ってたら必ず解約→S3全削除→DB物理削除
  - audit/ticketsは保持

---

## 23. SES運用（FIX）
- From：`noreply@vistia.studio`
- Reply-To：`support@vistia.studio`（認証系はnoreply）
- バウンス/苦情：SNS→SQS→Lambda→DB反映
- 任意メール：バウンス時停止
- 強制メール：送る（deliveryに結果記録）

---

## 24. 監査ログ（FIX）
- audit_logs：Admin重大操作、画像処理、パージ、Stripe webhook、退会/取消 等
- meta最低限：request_id、before/after（ロール/テンプレ変更）、reason_code（通知系）
- 保持：DB90日、S3 1年、以降コールド

---

## 25. 運用ポリシー（FIX）

### 25.1 Webhook失敗運用（FIX：Stripe / SES）
#### 共通方針（FIX）
- 失敗は握りつぶさない
- 自動復旧できない/一定回数超えたら `manual` チケット化（運営判断）
- 再試行は指数バックオフ、重複実行は冪等で吸収

#### Stripe（FIX）
- 受信：署名検証必須、`event_id` 冪等
- 再試行：最大10回、合計最大24h程度（指数バックオフ）
- 24h経過 or 最大10回失敗で `ticket_type=manual` 起票
- ユーザー状態が変わるイベントは「成功するまで確定しない」

#### SES（FIX）
- 受信：SNS→SQS→Lambda
- 再試行：最大5回（指数バックオフ）
- 最大5回失敗で `ticket_type=manual` 起票

### 25.2 RDSバックアップ・復旧（FIX）
- 自動バックアップ（PITR）：ON、保持35日
- 手動スナップショット：月次12世代、リリース前は直近3回保持
- クロスリージョン：初期は無し
- 復旧：新規RDSへリストア→RDS Proxyの向き先切替
- DRY RUN：四半期1回
- 責任者：Owner（実行ログはaudit_logsへ）
- 開発：保持7日（推奨）

### 25.3 ログ保持（監査以外）（FIX）
- 目的別に短期（30日）/中期（180日）で分ける
- 収集先：CloudWatch Logs + S3
- IP：
  - S3保存時はHMAC-SHA256でハッシュ化
  - CloudWatchの生IPが含まれる可能性があるため保持30日に固定

#### 保持期間（FIX）
- WAF：CW 30日 / S3 180日
- CloudFront(img)：S3 180日
- API Gateway：CW 30日 / S3 180日
- Lambda：CW 30日（重要障害時のみS3へ退避して180日）
- RDS：CW 30日（初期はS3退避なし）

### 25.4 Admin操作ガード追加（FIX）
- 重大操作：停止/解除、削除、hide、token revoke、Pro付与/剥奪、通知テンプレ編集
- 二段階：確認モーダル + 確認入力（CONFIRM もしくは対象ID末尾6桁）
- クールダウン：
  - 同一重大操作の連打：5秒
  - 同一リソースへの重大操作：30秒
- 再認証（TOTP再入力）：
  - ログインから15分経過 or IP/UA変化等で要求、猶予5分
- 重大操作はaudit_logsへ記録

### 25.5 アップロード悪用対策（FIX）
- 方針：ソフト制御中心、必要時に短時間ブロック
- 表示文言は固定（理由の詳細は出さない）
- 上限（FIX）
  - 1日：200作品
  - 1時間：60作品
  - 5分：15作品
  - 1日容量：5GB（original合計）
  - 超過時は429
- キュー保護（FIX）
  - WARN：バックログ10,000
  - HARD：バックログ30,000（HARD中はcommit一律429）
- チケット化（FIX）
  - 日次上限（作品数 or バイト）3日連続到達
  - 5分上限に1日5回以上到達
  - HARD中に繰り返しcommit
  - `abuse_storage_alert` を自動起票（自動停止はしない）
- Proでも上限は同じ（初期FIX）

---

## ✅FIX：Manage 認証フロー（ログインと新規作成を完全分離）

### 1) 画面構成（仕様）

* **ログイン画面**：ログインのみ（既存ユーザー専用）
* **新規作成画面**：新規作成のみ（ユーザー作成専用）
* ユーザー作成は必ず **「新規作成」ボタン**から入る

---

## ✅FIX：Magic Link（Email）

### ログイン（既存ユーザー）

* 送信リクエスト時に **登録有無を判定して返す**

  * 未登録：`未登録です` を返す
  * 登録済み：Magic Link を送信した旨を返す

### 新規作成（ユーザー作成）

* 新規作成画面でのみ実行可能（ログイン画面では作らない）
* 新規作成時にユーザーを作成し、メールを紐付ける

> ※トークンの仕様（有効期限/ワンタイム/DBハッシュ保存）はこのまま維持してOK（別FIXにして良い）

---

## ✅FIX：OAuth（Google / X）

### ログイン（既存ユーザー）

* `provider + provider_user_id` が **既に連携済みのユーザーのみ**ログイン可能
* 未連携の場合は **「未登録です（または未連携です）」を返す**
* **ログイン経路で新規ユーザーを作成しない**

### 新規作成（ユーザー作成）

* 新規作成画面から開始した場合のみ

  * OAuth完了 → **新規ユーザー作成** → providerを紐付け

### 連携（アカウント統合）

* **勝手に連携しない（自動統合なし）**
* “同じメール”でも自動で既存ユーザーに紐付けない
* 既存ユーザーが連携したい場合は **ログイン後の「連携」操作**でのみ可能（※この連携UI自体は後でFIXでもOK）

---

## ✅FIX：Magic Link（Manage / Emailログイン）

### 1) 適用範囲（FIX）

* **ログイン画面のみ**で使用する（＝Magic Link経由でユーザー新規作成しない）
* 新規ユーザー作成は **新規作成ボタン → 新規作成フロー**のみ（別仕様）

---

### 2) 送信リクエスト（FIX）

* 入力：`email`
* 応答は **登録有無で分岐**する

  * **未登録**：`未登録です` を返す（メール送信しない）
  * **登録済み**：`送信しました` を返す（メール送信する）
* 送信済みメッセージは、送信先・有効期限などの詳細は書かない（固定文言）

---

### 3) トークン仕様（FIX）

* 有効期限：**15分**
* 使用回数：**ワンタイム（1回使用で即無効）**
* 競合：**最新のみ有効**

  * 同じユーザーに対して新しいMagic Linkを発行したら、**過去の未使用トークンは全て無効化**
* 保存：

  * DBには **トークン平文は保存しない**
  * `sha256(token)`（または同等）で保存する
* URL形式（例）：`https://manage.vistia.studio/auth/magic?token=...`

---

### 4) 再送・レート制限（FIX）

#### 4.1 再送クールダウン（FIX）

* 同一emailへの再送：**60秒に1回まで**

#### 4.2 レート制限（FIX）

超過時は **429**（文言固定）

* email単位：**1時間に5回まで**
* IP単位：**1時間に20回まで**

#### 4.3 超過時の表示（FIX）

* 固定文言：`現在ログインを制限しています。時間をおいてお試しください。`
* 詳細理由（IP超過・メール超過など）は出さない

---

### 5) 消費（ログイン確定）仕様（FIX）

* 入力：`token`
* 成功条件：

  * tokenが存在
  * 期限内
  * 未使用
  * 最新である
* 成功時：

  * `manage_session` を発行（既FIXのDBセッション）
* 失敗時（期限切れ/使用済み/不正/無効化済みはすべて同じ）：

  * エラー文言固定：`リンクが無効です。もう一度ログインしてください。`

---

### 6) メール送信内容（FIX）

* From：`noreply@vistia.studio`（既FIX）
* Reply-To：認証系は `noreply`（既FIX）
* 本文に含める情報（最低限）

  * ログイン用リンク
  * 有効期限：15分
  * 心当たりがない場合の案内（無視すればOK）
* セキュリティ注意（FIX）

  * メール本文に「あなたのアカウント情報」や「機微情報」は載せない
  * トークンはURLにのみ含める（本文に平文コードを別途載せない）

---

### 7) 監査・ログ（FIX）

* Magic Link発行・消費・失敗はログに残す（監査ログとは別でもOK）
* **トークン平文はログに出さない**（ハッシュも出さない）

---

## ✅FIX：OAuth（Google / X）ログイン・新規作成・連携

### 1) 適用範囲（FIX）

* OAuthは **ログイン** と **新規作成** を完全に分離する
* **ログイン経路ではユーザーを作成しない**
* **自動連携（メール一致など）もしない**
* ユーザー作成は必ず **「新規作成」ボタン**から開始する

---

## 2) ログイン（既存ユーザー）仕様（FIX）

### 2.1 開始

* ログイン画面に `Googleでログイン` / `Xでログイン` ボタンを表示
* ボタン押下でOAuth開始

### 2.2 成功条件

* `provider + provider_user_id` が **既存ユーザーに紐付いている場合のみ**ログイン成功

### 2.3 未連携の場合（FIX）

* OAuth自体は成功しても、サービス側ではログイン不可
* 応答/表示文言：**`未登録です`**

  * ※メールが取れた/取れないに関わらず統一（列挙よりも運用優先）

### 2.4 セッション

* 成功時のみ `manage_session` を発行（既FIX）
* 失敗時はセッション発行しない

---

## 3) 新規作成（ユーザー作成）仕様（FIX）

### 3.1 開始（FIX）

* ログイン画面から `新規作成` ボタン → 新規作成画面へ
* 新規作成画面で `Googleで新規作成` / `Xで新規作成` ボタンを表示

### 3.2 作成条件（FIX）

* OAuth成功後、**新規ユーザーを作成**
* そのユーザーに `provider + provider_user_id` を紐付ける
* 既に同じ `provider + provider_user_id` が存在する場合

  * 作成不可（既存ユーザーがあるため）
  * 文言：`すでに登録されています`

### 3.3 メールの扱い（FIX）

* providerからメールが取得できても

  * **既存ユーザーとの自動統合はしない**
* 新規作成後にメールを追加する仕様は **TBD**（必要なら別途FIX）

---

## 4) 連携（ログイン後のアカウント連携）仕様（FIX）

### 4.1 開始（FIX）

* Manageログイン後の設定画面に「連携」メニューを用意
* 連携は **ユーザー操作でのみ**行う（勝手にやらない）

### 4.2 連携条件（FIX）

* 連携したいproviderでOAuthを実施
* 取得した `provider + provider_user_id` が未使用なら連携成功
* 既に別ユーザーに紐付いている場合

  * 連携不可
  * 文言：`このアカウントは別のユーザーで使用されています`

### 4.3 解除（FIX）

* 初期は **解除不可**（TBDにしない、仕様として「提供しない」でFIX）

  * 理由：サポートコストと事故防止を優先

---

## 5) 共通：レート制限（FIX）

* OAuth開始ボタンは乱用対策としてレート制限する

  * IP単位：**1時間に60回まで**
* 超過時は 429、文言固定：

  * `現在ログインを制限しています。時間をおいてお試しください。`

---

## ✅FIX：Admin パスワード規約・初回2FAセットアップ・バックアップコード

前提（既FIX）：Adminは Email + Password + TOTP必須、バックアップコード10個、セッション12h/無操作30m、別認証境界。

---

## ✅更新FIX：Adminパスワード最小長

* **最小長：8文字**（FIX）
* 最大長：72文字（FIXのまま）
* 文字種要件：要求しない（FIXのまま）
* 禁止：email同一、またはemailローカル部を含むものは禁止（FIXのまま）
* 変更時：全セッション破棄（FIXのまま）

---

## 2) Adminユーザー作成と初回ログイン（FIX）

* Adminユーザー作成/権限変更は **Ownerのみ**（既FIX）
* OwnerがAdminユーザーを作成するときに設定するもの

  * email（必須）
  * 初期パスワード（必須）
  * role（必須）

### 初回ログイン時の必須フロー（FIX）

* 初回ログインでは **TOTP登録が完了するまでAdmin機能を使えない**
* フロー

  1. email+passwordで認証
  2. TOTP未登録なら「2FAセットアップ画面」へ強制遷移
  3. QR/シークレット表示 → ユーザーが認証アプリに登録
  4. TOTPコード入力で検証成功したら登録完了
  5. **バックアップコード10個を1回だけ表示**

     * ユーザーが「保存しました」チェック（または同等）しないと完了できない

---

## 3) TOTP（2FA）仕様（FIX）

* TOTPのみ（SMS/Email 2FAは無し）
* 許容ドリフト：**±1ステップ**
* 連続失敗制限（FIX）

  * 10分間に **10回失敗**で、以後 **10分ロック**
  * 表示文言は固定：`しばらくしてからお試しください。`

---

## 4) バックアップコード（FIX）

* 10個発行
* 表示：**初回のみ**
* 保存：DBには **ハッシュのみ**保存（平文は保存しない）
* 使用：

  * 1回使ったコードは即無効
  * 使用成功時はログに残す（どのコードかは残さない）

### 再発行（FIX）

* 再発行できるのは **本人（ログイン中のAdmin）**のみ
* 再発行は **TOTP再入力必須**
* 再発行した瞬間に

  * 旧バックアップコードは全て無効
  * 新しい10個を発行し、**その場で1回だけ表示**

---

## 5) 失念/復旧（FIX）

* TOTPとバックアップコードを両方失った場合

  * **Ownerのみ**が当該Adminに対して「2FAリセット」を実行できる
  * 2FAリセット後、当該Adminは次回ログインで必ず初回セットアップに戻る
* 2FAリセットは重大操作として扱い

  * 確認入力必須（既FIXの重大操作ガード適用）
  * audit_logsに記録必須

---

## ✅FIX：Public側のレスポンス統一ルール（理由非表示 / 404統一）

### 1) 基本方針（FIX）

* Public閲覧（`vistia.studio` 側）では、**非公開・削除・停止等の理由を一切表示しない**
* Public API/画面は、対象が見えない場合 **原則404で統一**する（“存在しない”扱い）

---

### 2) 404に統一するケース（FIX）

以下は **すべて404**（同じ見え方）にする：

#### プロフィール（handle）

* ユーザーが退会（deleted）している
* ユーザーが停止（suspended）している
* handleが存在しない

#### 作品（work）

* PRIVATE
* UNLISTEDで token が無効 / revoked / 不正 / 見つからない
* 論理削除済み（deleted）
* 運営により非公開（hide）
* 作品が存在しない

#### コレクション（collection）

* PRIVATE
* UNLISTEDで token が無効 / revoked / 不正 / 見つからない
* 論理削除済み（deleted）
* 運営により非公開（hide）
* コレクションが存在しない

---

### 3) 例外（FIX）

* Publicで「レート制限」に該当する場合のみ **429** を返してよい
  （文言は固定で理由の詳細は出さない）
* 入力が明らかに壊れている場合（例：UUID形式でない等）も **404** に寄せてよい
  （400にすると存在推測の材料になり得るため）

---

### 4) UNLISTED閲覧の「閉じた閲覧」補足（FIX）

* UNLISTED閲覧ページでは、通常のギャラリー導線・一覧導線は出さない
* 表示してよい情報は **ユーザー名/アイコン**のみ
* tokenが無効になった場合は **404**（理由表示なし）

## ✅FIX：hide / delete の定義（Work / Collection / User）

目的：Adminの「非公開（hide）」と「削除（delete）」の意味を統一して、通知・パージ・Public挙動を迷わないようにする。

---

## 1) Work（作品）

### 1.1 hide（運営非公開）（FIX）

* 意味：**運営による表示停止（復旧可能）**
* Public挙動：**404**（理由非表示・既FIXに従う）
* Manage挙動：

  * 作品は一覧に残す（ステータス表示：`HIDDEN_BY_ADMIN`）
  * 編集は不可（visibility変更も不可）
  * 削除（ユーザー自身の論理削除）は可
* 通知：

  * in-app：必須
  * メール：テンプレ設定に従う（ただし強制メール reason_code があれば必ず送る）
  * reason_code：`WORK_HIDDEN_BY_ADMIN`（既FIXの強制メール対象）

### 1.2 delete（運営削除）（FIX）

* 意味：**運営による削除（復旧不可）**
* Public挙動：**404**
* Manage挙動：

  * 作品は一覧から消える（ユーザーから見えない）
* データ処理：

  * 論理削除としてマークし、**30日後にパージ**（既FIXのパージフローに統合）
  * 削除時点で token は即時 revoked、collection_items は即時削除
* 通知：

  * reason_code：`WORK_DELETED_BY_ADMIN`（既FIXの強制メール対象）

---

## 2) Collection（コレクション）

### 2.1 hide（運営非公開）（FIX）

* 意味：**運営による表示停止（復旧可能）**
* Public挙動：**404**
* Manage挙動：

  * コレクションは一覧に残す（ステータス：`HIDDEN_BY_ADMIN`）
  * 編集不可（visibility変更、アイテム追加/削除不可）
  * ユーザー自身の削除（論理削除）は可
* 通知：

  * reason_code：`COLLECTION_HIDDEN_BY_ADMIN`（強制メール対象）

### 2.2 delete（運営削除）（FIX）

* 意味：**運営による削除（復旧不可）**
* Public挙動：**404**
* Manage挙動：

  * 一覧から消える
* データ処理：

  * 論理削除 → **30日後DB削除**（既FIX）
  * token即revoked
* 通知：

  * reason_code：`COLLECTION_DELETED_BY_ADMIN`（強制メール対象）

---

## 3) User（ユーザー）

### 3.1 suspend（停止）（FIX補足）

* 意味：**ユーザーの利用停止（復旧可能）**
* Public挙動：**プロフィール含め404**
* Manage挙動：

  * ログイン不可（セッション全破棄）
* 通知：

  * reason_code：`ACCOUNT_SUSPENDED`（強制メール対象）

### 3.2 delete（退会）（既FIX補足）

* 意味：ユーザーが退会（30日以内は取消可、パージあり）
* Public挙動：**404**
* Manage挙動：ログイン不可
* 通知：必要に応じて（既FIXの通知ポリシーに従う）

---

## ✅FIX：Pro失効時の挙動（コレクション / ピン / 広告）

前提（既FIX）

* Free：広告あり、ピン無し、コレクション不可
* Pro：広告なし、ピン3、コレクション可
* 手動Pro優先：`pro_until = max(stripe, manual)`（既FIX）

---

## 1) Pro判定（FIX）

* `now < pro_until` の間は Pro
* `pro_until` が `NULL` または `now >= pro_until` なら Free
* 基準時刻：**UTC**（保存はUTC、表示はクライアント側で変換してOK）

---

## 2) Pro失効時の即時挙動（FIX）

Pro → Free に変わった瞬間、以下を即時適用する：

### 2.1 広告（FIX）

* Public/Manageともに **広告あり**に切り替える（Free扱い）

### 2.2 ピン（FIX）

* 既存ピンは **全解除**

  * 解除は自動（ユーザー操作不要）
  * ピン対象はPUBLIC作品のみ、という既FIXは維持

### 2.3 コレクション（FIX）

* 既存コレクションは **削除しない**（データは保持）
* ただし Free中は以下の制限：

  * **Publicには一切表示しない**（コレクション導線も出さない）
  * Manageでも **閲覧のみ可**（編集不可：作成/削除/visibility変更/アイテム追加削除不可）
* Proに戻ったら

  * 既存コレクションは復活（再表示・編集可能に戻る）

---

## 3) UNLISTED token の扱い（FIX）

* Pro失効で token を自動revoked **しない**

  * 理由：勝手に共有URLを壊すとトラブルになるため
* ただし Free中はコレクションがPublic側に出ないため

  * コレクションUNLISTEDの閲覧は **token直アクセスのみ**（閉じた閲覧ルールは維持）

---

## 4) 新規操作の制限（FIX）

Free中は以下を禁止：

* コレクション新規作成
* コレクション編集（visibility変更、並び替え、追加/削除）
* ピン設定

---

次は、仕様漏れとして残ってる可能性が高い **in-app通知の既読/保持/上限** をFIXするか、**Linksの“もっと見る”表示方式**をFIXするか、どっちで行く？

了解、**限定URL（UNLISTED token）の上限**が仕様に抜けてたね。ここは既存のFIX（「Pro失効でtokenは自動revokedしない」）と矛盾するので、**矛盾→解消**してFIXを更新する。

---

## 矛盾点 → 解消

* **矛盾（旧FIX）**：Pro失効で token を自動revoked しない
* **新FIX**：Freeは限定URL **3つまで**、Proは**無制限**
  → **解消**：Pro→Free移行時に **上限超過分は自動でrevoked** する（= tokenを壊さない方針は撤回）

---

## ✅追記FIX：限定URL（UNLISTED token）上限

### 1) 上限（FIX）

* **Free：有効な限定URL token は合計3つまで**
* **Pro：無制限**
* “合計”の範囲：**作品UNLISTED + コレクションUNLISTED を合算**して数える

### 2) 作成/変更時の挙動（FIX）

* Freeで、すでに有効tokenが3つある状態で

  * 作品/コレクションを UNLISTED に変更しようとした場合：**ブロック（失敗）**
  * 文言（固定）：`限定URLの上限に達しています。不要な限定URLを解除してください。`

### 3) Pro → Free 失効時の挙動（FIX）

* 失効時点で有効tokenが **3つを超えている場合**

  * **最新の3つを残す**
  * **それ以外は自動で revoked**
* revoked された対象は Public 側では既存ルール通り **404**（理由非表示）

### 4) 通知（FIX）

* 上限超過による自動revoked が発生した場合、対象ごとに通知

  * reason_code：`TOKEN_REVOKED`（既FIXの強制メール対象に含まれる）

---

## ✅既存FIXの更新点（差し替え）

* 「Pro失効で token を自動revoked **しない**」は **撤回**
* 代わりに上の「Pro→Freeで上限超過分revoked」を採用

---

## ✅FIX：限定URL（UNLISTED token）上限管理の細目（残す3つの定義 / 管理UI / 解除）

前提（既FIX）：Freeは有効token合計3つまで、Proは無制限。上限超過時はブロック。Pro→Free失効時は超過分revoked。

---

## 1) 「最新の3つ」の定義（FIX）

* “最新”は **tokenの `issued_at`（発行時刻）降順**で判定する
* 同一時刻があり得る場合のタイブレークは **token_idの降順**
* Pro→Free失効時は

  * `issued_at` が新しい順に **3つを残す**
  * それ以外を **revoked** にする

---

## 2) tokenの一覧・解除UI（Manage）（FIX）

### 2.1 一覧（FIX）

Manageに「限定URL」管理ページを用意し、以下を一覧表示する

* 対象種別：Work / Collection
* 対象ID（短縮表示可）
* visibility（UNLISTED）
* issued_at
* 状態：ACTIVE / REVOKED
* 操作：`解除（revoke）` ボタン（ACTIVEのみ）

### 2.2 解除（FIX）

* `解除（revoke）` は即時反映

  * tokenは `revoked_at` を設定し無効化
  * 以後そのURLはPublic側で **404**
* 解除理由はユーザーUIでは表示しない（単に解除されたことだけ）

### 2.3 Free上限の表示（FIX）

* Freeユーザーには管理ページに上限を表示

  * `有効な限定URL：{active_count}/3`
* 追加でUNLISTED化しようとして上限に達している場合の文言は既FIXの固定文言

---

## 3) UNLISTED化（token発行）の操作仕様（FIX）

* Work/Collectionを UNLISTED に変更した瞬間に token を **自動発行**
* UNLISTED → PUBLIC/PRIVATE に戻すと tokenは **即時revoked**（既FIX）
* token再発行（FIX）

  * UNLISTEDのまま `再発行` ができる
  * 再発行すると旧tokenは即revoked、新tokenを発行（issued_at更新）
  * Freeで上限3に達している場合：

    * **同一対象の再発行は許可**（総数は増えないため）
    * ただし実装上は「旧をrevoked→新をissued」なので、処理は同一トランザクションで行い、active_countが一瞬でも4にならないようにする

---

## 4) 通知（FIX）

* Pro→Free失効で超過tokenが自動revokedされた場合

  * まとめ通知ではなく **対象ごとに通知**（既FIXに合わせる）
  * reason_code：`TOKEN_REVOKED`（強制メール）

---
了解。**本番表示（UI文言）だけ**を置き換える方針でFIXするね。内部実装・DB値（`PUBLIC/UNLISTED/PRIVATE`）はそのままでもOK、という扱いにする。

## ✅FIX：Visibility の本番UI文言

### 1) 表示名（FIX）

本番UIでは以下の名称を使う（ユーザー向け表記）：

* `PUBLIC` → **公開**
* `UNLISTED` → **限定**
* `PRIVATE` → **非公開**

### 2) 適用範囲（FIX）

* Manage（作成/編集/一覧/設定）
* Public（表示が必要な箇所）
* Admin（チケット/対象情報表示）

### 3) 内部値（FIX）

* DB・API・内部ロジックの値は **変更しない**

  * `PUBLIC / UNLISTED / PRIVATE` のまま
* 画面表示のみ上記ラベルにマッピングする

---

## ✅FIX：限定URL の本番UI文言（用語統一）

前提：Visibility 表示名は「公開 / 限定 / 非公開」に変更済み。

---

## 1) 用語（FIX）

* 本番UIでは `token` / `UNLISTED URL` という表現を出さない
* ユーザー向けの名称は以下で統一する

### 表示名（FIX）

* “UNLISTEDのURL” → **限定リンク**
* “token revoke” → **限定リンクを解除**
* “token issued” → **限定リンクを発行**
* “token re-issue” → **限定リンクを再発行**

---

## 2) 管理画面（Manage）の文言（FIX）

### 2.1 一覧ページ

* ページ名：**限定リンク**
* カウンタ表示（Free）：`有効な限定リンク：{active_count}/3`
* 状態表示：`有効` / `解除済み`

### 2.2 操作ボタン

* `解除（revoke）` → **解除する**
* `再発行` → **再発行する**
* 上限超過の文言：

  * `限定リンクの上限に達しています。不要な限定リンクを解除してください。`

---

## 3) Public側の文言（FIX）

* 限定リンクが無効/見つからない場合は **404**（理由表示なし）※既FIX
  → Publicでは文言自体を出さない（存在しない扱い）

---

## ✅FIX：in-app通知（既読 / 保持 / 最大件数 / 表示）

前提（既FIX）：in-app通知は必須（OFF不可）。メール通知は任意メールのみOFF可。強制メールは必ず送る。

---

## 1) 通知の状態（FIX）

* 通知はユーザーごとに以下の状態を持つ

  * `UNREAD`（未読）
  * `READ`（既読）
* ユーザーは通知を **既読にできる**
* ユーザーは通知を **削除できない**（初期FIX：運用・証跡を優先）

---

## 2) 保持期間（FIX）

* in-app通知は **180日保持**
* 180日を過ぎた通知は自動削除（物理削除でOK）

---

## 3) 最大件数（FIX）

* 1ユーザーあたりの通知は **最大1万件**
* 1万件を超える場合

  * 古い順に削除して上限内に収める（FIFO）

---

## 4) 表示（Manage）（FIX）

* 通知一覧は **新着順（created_at desc）**
* ページング方式：**カーソルページング**

  * 1ページ：50件
* 未読バッジ

  * 未読が1件以上なら表示
  * 数字表示は **最大99+**

---

## 5) 生成・配信の扱い（FIX）

* in-app通知は **必ず生成される**
* メールはテンプレ設定とユーザー設定に従う（強制メールは例外）

---

## ✅FIX：タグ仕様（文字種 / 禁止 / 正規化 / 付与・検索の扱い）

前提（既FIX）：作品タグは最大3、各10文字。Manage検索はタグ完全一致AND、正規化は「前後トリム・連続空白1つ・case-insensitive重複統合」。

---

## 1) タグの入力ルール（FIX）

### 1.1 文字数（FIX）

* 1タグあたり **1〜10文字**
* 1作品あたり **最大3タグ**

### 1.2 許可文字（FIX）

* Unicode可（日本語OK）
* **絵文字OK**
* 記号はOK（ただし制御文字は不可）

### 1.3 禁止（FIX）

* 改行・タブなどの制御文字は禁止
* 先頭が `#` の入力は許可するが、保存時に `#` は除去（後述の正規化で処理）

---

## 2) 正規化（FIX）

タグの保存前に以下を必ず適用する：

* 前後トリム
* 連続する空白は1つに圧縮
* 先頭の `#` は除去（`###tag` → `tag` まで除去）
* 大文字小文字は区別しない（case-insensitive）

  * 保存時は **入力の見た目を維持して良い**が、比較は case-insensitive
* 同一作品内での重複タグは禁止

  * 正規化後に重複していたら **重複分を削除**して3つ以内に収める

---

## 3) 禁止語（FIX：初期はやらない）

* タグの禁止語リスト判定は **初期は実施しない（FIX）**

  * 理由：運用コスト増と誤検知を避ける
* ただし、運営判断で作品を `hide/delete` する運用はチケット経由で行う（既FIXのTicket-Centric）

---

## 4) Manage検索（FIXの補強）

* 検索は **タグ完全一致のみ（AND）**
* 検索入力にも正規化を適用（上記と同じ）
* サジェストなし（既FIX）
* 検索タグ数は **1〜3**（空は不可）

---

## 5) Public側（FIX）

* Publicにはタグ検索を提供しない（既FIX）
* Public表示でタグを見せるかどうかは **初期は表示しない（FIX）**

  * 理由：導線はコレクション方針を優先

---

## ✅FIX：Links「もっと見る」表示方式（無制限対応）

前提（既FIX）：Linksは無制限、Publicプロフィールは6件表示＋「もっと見る」。`label`必須、`description`任意、`order_index`で並び替え。

---

## 1) 表示場所（FIX）

* PublicプロフィールのLinksブロック

  * 先頭6件のみ表示
  * 7件以上ある場合だけ「もっと見る」を表示
* 「もっと見る」押下で **Links専用ページ**へ遷移する

  * URL：`/@handle/links`

---

## 2) Links専用ページ（FIX）

* 表示内容：全Links（無制限）
* 並び順：`order_index` 昇順（同値は `created_at` 昇順）
* 表示項目：

  * `label`（必須）
  * `description`（ある場合のみ表示）
* ページング：**無限スクロール**

  * 1回の取得：50件
  * カーソルページング（最後の `order_index + created_at` をカーソルにする）
* 検索：**なし（初期FIX）**
* リンク押下：新規タブ（`noopener,noreferrer`）

---

## 3) 表示の省略ルール（FIX）

* `label` は30文字を超える場合 **末尾…で省略**（全文はツールチップ等は無し）
* `description` は80文字を超える場合 **末尾…で省略**

---

## 4) Manage側（編集UI）への影響（FIX）

* ManageのLinks編集は **並び替え前提**

  * 並び替え結果は `order_index` に反映
* Public表示は常に `order_index` を正とする（作成順ではない）

---

## ✅FIX：一般APIレート制限（全体方針）

目的：乱用・スパム・DoSの足回りを抑える（アップロード悪用対策とは別枠）

---

## 1) 方針（FIX）

* Public/Manage/Admin すべてのAPIにレート制限を適用する
* 単位は **IP** を基本にし、可能な範囲で **ユーザーID** でも追加制限する
* 超過時は **HTTP 429**
* 超過時の表示文言は固定（理由の詳細は出さない）

固定文言（FIX）
`現在アクセスを制限しています。時間をおいてお試しください。`

---

## 2) ルール（FIX：初期値）

### 2.1 Public API（閲覧系）

* IP単位：**1分 120リクエスト**
* IP単位：**1時間 5,000リクエスト**

### 2.2 Manage API（ログイン以外）

* ユーザーID単位：**1分 60リクエスト**
* IP単位：**1分 120リクエスト**

### 2.3 Admin API

* admin_user_id単位：**1分 60リクエスト**
* IP単位：**1分 120リクエスト**

---

## 3) 認証系の例外（FIX）

* Magic Link送信・消費は **別FIXの専用制限**を優先（1時間5回等）
* AdminのTOTP失敗ロックも **別FIX**を優先

---

## 4) 除外（FIX）

* 画像配信（CloudFront `img.vistia.studio`）はレート制限対象外（CDN側に任せる）

---

## ✅更新FIX：時間・タイムゾーンの統一（JST固定）

### 1) 基準（FIX）

* サービス全体の基準タイムゾーンは **日本時間（JST / Asia/Tokyo）**
* 期限判定・日次集計・上限カウントなど、**すべてJST基準**で行う

### 2) 判定ルール（FIX）

* 有効/無効、期限切れ、パージ対象などの判定は **JSTの now** で行う
* “30日後パージ” は

  * `deleted_at（JST） + 30日` を超えたら対象
* “1日上限” “1時間上限” などの時間窓は **JST** で区切る（0:00〜23:59）

### 3) 保存（FIX）

* DBに保存する時刻は **JSTとして解釈できる形で統一**する
  （実装都合で `timestamptz` を使う場合でも、**意味・判定基準はJST**で固定）

### 4) 表示（FIX）

* UI表示も **JSTで表示**する（変換不要）

---

## ✅FIX：APIバージョニング（/v1）と互換ポリシー

### 1) URL構造（FIX）

* 公開APIは **バージョンをURLに含める**

  * 例：`https://api.vistia.studio/v1/...`
* Public/Manage/Admin すべてのAPIで `/v1` を付与する（内部の呼び分けは設計側）

---

### 2) 互換ポリシー（FIX）

* **breaking change（互換性破壊）** は `/v1` では行わない
  → 必要になったら `/v2` を新設する
* `/v1` 内で許可する変更

  * レスポンスにフィールド追加（既存フィールドの意味は変えない）
  * 新しいエンドポイント追加
  * バリデーションの強化（ただし既存の正当入力を壊さない範囲）

---

### 3) 廃止ポリシー（FIX）

* `/v2` を出した場合の `/v1` の扱い

  * **最低12か月は維持**
  * 廃止の90日前までに告知（Manage内通知でOK）
* 廃止後は `/v1` は **404** でよい（理由表示なしの方針に合わせる）

---

### 4) クライアント識別（FIX）

* すべてのAPIリクエストに `X-Request-Id` を付与（無ければサーバー生成）
* 可能なら `X-Client`（例：`public|manage|admin`）を付ける（TBDにせず **初期から付けてOK**）

---

## ✅FIX：エラー応答・メッセージ方針（理由を出さない / 固定文言）

目的：悪用者に情報を渡さず、UIとAPIの挙動を統一する。

---

## 1) 基本方針（FIX）

* Public側は「見えない＝404」で統一（既FIX）
* Manage/Admin/APIのエラーは **原因の詳細を出しすぎない**
* UIに出す文言は **原則固定**（ケースで出し分けしない）
* ただし、仕様で明示的に許可したもの（例：`未登録です`）は例外として出す

---

## 2) HTTPステータスの使い分け（FIX）

* 400：入力が不正（ただしPublicは404に寄せてよい）
* 401：未認証（セッション無し/無効）
* 403：権限不足（Admin RBACなど）
* 404：対象なし/非公開/削除/停止（Publicは原則これ）
* 409：競合（重複作成、すでに登録、同一URL重複など）
* 429：レート制限・一時制限（アップロード制限含む）
* 500：サーバー内部エラー

---

## 3) 固定文言（FIX）

### 3.1 共通

* 400：`入力が正しくありません。`
* 401：`ログインが必要です。`
* 403：`権限がありません。`
* 404：`見つかりません。`
* 409：`すでに存在します。`
* 429：`現在アクセスを制限しています。時間をおいてお試しください。`
* 500：`エラーが発生しました。時間をおいてお試しください。`

### 3.2 認証・登録（仕様例外）

* Manageログイン（Magic Link送信 / OAuthログイン）で未登録のとき：`未登録です`
* OAuth新規作成で既に登録されているとき：`すでに登録されています`
* Magic Link消費失敗：`リンクが無効です。もう一度ログインしてください。`

---

## 4) エラー詳細の扱い（FIX）

* クライアント（ユーザー）には詳細理由を出さない
* サーバー側ログには以下を残す

  * request_id
  * error_code（内部用）
  * stacktrace（必要なら）
  * actor（user_id/admin_user_id）とresource_id

---

## 5) 国際化（FIX）

* 本番UIの文言は **日本語固定**（初期FIX）
* 将来多言語化する場合のみ、設計側で対応する（仕様ではTBDにしない）

---

## ✅FIX：通知テンプレ `{{action}}` の固定辞書（文言統一）

目的：通知テンプレの `{{action}}` を人によってブレさせず、常に同じ言い回しにする。

---

## 1) `{{action}}` は固定値のみ（FIX）

* `{{action}}` に入る値は **固定辞書から選ぶ**
* Admin/運営が自由文で `{{action}}` を書き換えることはしない

  * 自由文は「追記メモ」（後述）に入れる

---

## 2) action 辞書（FIX）

以下のキー → 表示文言（JST表記前提）

### アカウント

* `ACCOUNT_SUSPENDED` → `アカウントを停止しました`
* `ACCOUNT_RESTORED` → `アカウントの停止を解除しました`

### 作品

* `WORK_HIDDEN_BY_ADMIN` → `作品を非公開にしました`
* `WORK_DELETED_BY_ADMIN` → `作品を削除しました`

### コレクション

* `COLLECTION_HIDDEN_BY_ADMIN` → `コレクションを非公開にしました`
* `COLLECTION_DELETED_BY_ADMIN` → `コレクションを削除しました`

### 限定リンク

* `TOKEN_REVOKED` → `限定リンクを解除しました`

### Pro

* `PRO_GRANTED_MANUAL` → `Proを付与しました`
* `PRO_REVOKED_MANUAL` → `Proを解除しました`

### 支払い

* `SUBSCRIPTION_PAYMENT_FAILED` → `お支払いに失敗しました`

---

## 3) テンプレ内の `{{effective_at}}`（FIX）

* `{{effective_at}}` は **JST** で表示（既FIX）
* 表示フォーマットは固定：`YYYY/MM/DD HH:mm`

---

## ✅FIX：通知の「追記メモ」（Support/Moderator追記）仕様

目的：テンプレ本文は統一しつつ、個別事情だけ最小限追記できるようにする。

---

## 1) 追記メモの基本（FIX）

* 追記メモは **Support / Moderator が通知送信時に任意で追加**できる
* 追記メモはテンプレ本文の末尾に追加される（上書きしない）
* 追記メモは **メール・in-appの両方に同じ内容を付与**する

---

## 2) 入力ルール（FIX）

* 文字数：**0〜300文字**
* 改行：可（最大5行まで）
* URL：可（ただし httpsのみ。httpは弾く）
* 禁止：HTMLタグ（`<...>`）はすべて無効化（テキストとして扱う）
* 正規化：

  * 前後トリム
  * 連続空白は1つ（改行は保持）
* 空の追記は付けない（完全に省略）

---

## 3) 表示（FIX）

### in-app

* テンプレ本文の後に区切り線を出して表示
* 例：`---` の下に追記メモ

### メール

* テンプレ本文の後に区切りを入れて追記
* 件名（subject）は追記で変えない

---

## 4) 監査・履歴（FIX）

* 送信した通知の本文は **送信時点の全文を保存**する

  * テンプレ本文（その時点のversion）
  * 追記メモ
  * 合成後の最終本文
* audit_logs に以下を記録

  * actor（admin_user_id）
  * reason_code
  * template_version
  * 追記メモの有無（本文自体はauditに入れない）

---

## 5) 送信制御（FIX）

* 強制メール reason_code は、テンプレがメールOFFでも **必ず送る**（既FIX）
* 追記メモは強制/任意どちらでも付与可能

---

## ✅FIX：メール送信判定ロジック（テンプレON/OFF・ユーザー設定・バウンス）

前提（既FIX）

* in-app通知：必須（OFF不可）
* メール通知：任意メールのみOFF可
* 強制メール reason_code：必ず送る（テンプレOFF不可、ユーザーOFF無視、バウンス抑止も無視）

---

## 1) 送信判定の入力（FIX）

判定に使うフラグは以下のみ：

* `reason_code`（通知種別）
* テンプレ側：`notification_templates.email_enabled`
* ユーザー側：`users.email_optional_enabled`
* バウンス状態：`users.email_bounced`（true/false）
* ユーザーのメールアドレス有無：`users.email`（null可）

---

## 2) 強制メール（FIX）

### 対象 reason_code（既FIX）

* ACCOUNT_SUSPENDED
* ACCOUNT_RESTORED
* WORK_HIDDEN_BY_ADMIN
* WORK_DELETED_BY_ADMIN
* COLLECTION_HIDDEN_BY_ADMIN
* COLLECTION_DELETED_BY_ADMIN
* TOKEN_REVOKED
* PRO_GRANTED_MANUAL
* PRO_REVOKED_MANUAL
* SUBSCRIPTION_PAYMENT_FAILED

### 判定（FIX）

強制メールは **以下をすべて無視して送信**

* テンプレの `email_enabled`
* ユーザーの `email_optional_enabled`
* `email_bounced`

ただし、**送信先メールが存在しない場合のみ送れない**（当たり前の例外）

* `users.email` が `NULL` の場合：メールは送れない
  → in-appのみ送る（必須）

---

## 3) 任意メール（FIX）

任意メールは、以下の全条件を満たす場合のみ送信する：

* テンプレ `email_enabled = true`
* ユーザー `email_optional_enabled = true`
* `users.email` が存在する（NULLではない）
* `users.email_bounced = false`

ひとつでも欠けたら **送らない**（in-appは必ず送る）

---

## 4) delivery記録（FIX）

メール送信の成否に関わらず、通知は必ず記録する：

* 通知レコード（in-app用）は必ず作る
* メールについては deliveryログを残す

  * `SENT` / `SKIPPED` / `FAILED`
  * `SKIPPED` の理由は内部コードで保持（UIには出さない）

---

## ✅FIX：SES complaint（苦情）と強制メールの扱い

前提：強制メールは「テンプレOFF不可・ユーザーOFF無視・バウンス無視」で送る（既FIX）。
ただし complaint を無視し続けると送信ドメインの健全性が壊れるため、ここだけは別扱いにする。

---

## 1) complaint フラグ（FIX）

* `users.email_complained`（true/false）を持つ
* SESのcomplaint受信で `true` にする
* `true` になったら **自動で false に戻さない**（解除は運営操作のみ）

---

## 2) 送信判定への影響（FIX）

### 2.1 任意メール（FIX）

* `email_complained = true` の場合は **必ず送らない**

  * （テンプレON / ユーザーONでも送らない）

### 2.2 強制メール（FIX：例外追加）

* `email_complained = true` の場合は **強制メールでも送らない**
* 代替：in-app通知は必ず送る（必須）

> つまり、強制メールが「送らない」唯一の条件は
>
> * `users.email` が無い
> * `email_complained = true`
>   のどちらか。

---

## 3) 記録（FIX）

* 強制メールが complaint により送れなかった場合も deliveryログを残す

  * status：`SKIPPED`
  * reason：`COMPLAINT_SUPPRESSION`

---

## 4) 運営操作（FIX）

* `email_complained` の解除は **Ownerのみ**
* 解除時は audit_logs に記録（重大操作扱い）

---

## ✅FIX：退会の「取り消しリンク」運用（UI/文言/発行制限/有効性）

前提（既FIX）：退会は取り消し可。30日以内OK。reactivateリンクは token 24h、最新のみ有効、発行上限は「1時間に3回」。

---

### 1) 退会状態（FIX）

* 退会実行時：

  * `users.deleted_at` を設定
  * `users.is_suspended = true`（Publicは404）
  * **全セッション破棄**
* 退会中ユーザーは

  * Public：404（既FIXの理由非表示）
  * Manage：ログイン不可

---

### 2) 取り消しリンクの発行（FIX）

* 発行できるのは **退会から30日以内**のみ
* 発行の入口（FIX）

  * Manageログイン画面に「退会を取り消す」リンクを設置
  * クリック → **メール入力フォーム**（Magic Linkとは別機能）
* 発行リクエストの返答（FIX）

  * emailが退会ユーザーとして存在しない場合：`未登録です`
  * 対象が退会ユーザーの場合：`送信しました`

---

### 3) 取り消しリンク token（FIX）

* 有効期限：**24時間**
* 性質：**最新のみ有効**

  * 再発行した時点で、過去に発行された未使用tokenは全て無効化
* 保存：DBには **token平文を保存しない**（ハッシュのみ）
* URL例：`https://manage.vistia.studio/reactivate?token=...`

---

### 4) 発行上限（FIX）

* email単位：**1時間に3回まで**
* IP単位：**1時間に20回まで**
* 超過時：

  * HTTP 429
  * 文言固定：`現在アクセスを制限しています。時間をおいてお試しください。`

---

### 5) token消費（取り消し確定）フロー（FIX）

* tokenが有効なら「退会取り消し確認画面」を表示

  * 表示文言（FIX）：

    * タイトル：`退会を取り消しますか？`
    * 説明：`取り消すとアカウントが再開されます。`
    * ボタン：`取り消す` / `キャンセル`
* 「取り消す」確定時に行う処理（FIX）

  * `deleted_at` をクリア
  * `is_suspended` を false
  * 全セッションはまだ無い状態（= 再ログインが必要）
  * tokenは即無効化（ワンタイム扱い）
* 失敗（期限切れ/使用済み/不正/無効化済み）はすべて同じ（FIX）

  * 表示文言：`リンクが無効です。もう一度お試しください。`

---

### 6) 通知（FIX）

* 退会取り消しが成功したら in-app通知を作成

  * reason_code：`ACCOUNT_RESTORED` を流用してOK（文面はテンプレで調整）
* メールは `ACCOUNT_RESTORED` が強制メールなので、**メールアドレスがある限り送る**（complaint抑止は既FIXに従う）

---

## ✅FIX：退会の実行確認（誤操作防止）

目的：誤タップで退会を発生させない。スマホ前提のガード。

---

### 1) 退会の入口（FIX）

* Manageの設定画面に「退会」セクションを置く
* 退会は **通常の設定項目と分離**して、危険操作として扱う

---

### 2) 二段階確認（FIX）

退会は必ず二段階で実行する：

1. 確認画面（影響説明）
2. 確認入力 + 最終ボタン

---

### 3) 表示文言（FIX）

#### 確認画面に必ず表示

* `退会するとプロフィールと作品は表示されなくなります。`
* `30日以内であれば取り消しできます。`
* `30日を過ぎるとデータは削除されます。`

---

### 4) 確認入力（FIX）

* 入力文字列：**`TAIKAI`**（固定）
* 入力が一致したら「退会する」ボタンが有効化される

---

### 5) クールダウン（FIX）

* 確認入力が通った後、最終ボタン押下まで **5秒カウントダウン**
* カウント中はボタン無効（誤タップ防止）

---

### 6) 実行後（FIX）

* 退会が完了したら即時ログアウト（セッション破棄）
* 表示文言：`退会しました。`

  * 以後はログイン不可（取り消しリンク経由のみ）

---

## ✅FIX：限定リンクの解除（revoke）確認（誤操作防止）

目的：Free上限3の運用もあるので、誤って解除して共有リンクを壊さないようにする。

---

## 1) 解除の基本（FIX）

* 対象：Manageの「限定リンク」一覧ページの `解除する`
* 解除は **即時反映**（解除後はPublicで404）
* 解除は取り消し不可（再発行はできるがURLは変わる）

---

## 2) 確認モーダル（FIX）

`解除する` 押下で必ず確認モーダルを出す

### 表示内容（FIX）

* タイトル：`限定リンクを解除しますか？`
* 説明：

  * `解除すると、このリンクは使えなくなります。`
  * `共有している相手は閲覧できなくなります。`
* ボタン：

  * `解除する`（危険ボタン）
  * `キャンセル`

---

## 3) 二段階確認入力（FIX：強すぎないガード）

* モーダル内でチェックボックス必須：

  * `解除すると元に戻せないことを理解しました`
* チェックが入るまで `解除する` ボタンは無効

---

## 4) 連打防止（FIX）

* 同一対象の解除は **30秒クールダウン**
* 解除ボタンは押下後ローディング表示にして二重送信防止

---

## ✅FIX：Visibility変更時の確認（限定 → 公開/非公開）

対象：作品/コレクションの visibility を **限定（UNLISTED）→ 公開 / 非公開** に戻す操作
前提：戻すと限定リンクは即時「解除」される（revoked）（既FIX）

---

## 1) 確認が必要な変更（FIX）

以下の変更は **確認モーダル必須**：

* **限定 → 公開**
* **限定 → 非公開**

※ 公開↔非公開、公開→限定、非公開→限定 は通常の確認なし（初期FIX）

---

## 2) 確認モーダル（FIX）

### 表示内容

* タイトル：`公開範囲を変更しますか？`
* 説明（必ず表示）：

  * `限定を解除すると、限定リンクは使えなくなります。`
  * `共有している相手は閲覧できなくなります。`

### ボタン

* `変更する`
* `キャンセル`

---

## 3) “理解チェック” （FIX）

* チェックボックス必須：

  * `限定リンクが解除されることを理解しました`
* チェックが入るまで `変更する` は無効

---

## 4) 実行時の処理（FIX）

* 変更が確定した瞬間に

  * 対象の限定リンクを即時解除（revoked）
  * Public側は既FIX通り **404**（理由表示なし）

---

## ✅FIX：限定リンクの再発行（リンク変更）確認

前提（既FIX）：再発行すると旧リンクは即時解除、新リンクを発行。Freeの上限3に達していても“同一対象の再発行”は許可。

---

## 1) 再発行の基本（FIX）

* 対象：Manageの限定リンク一覧、または作品/コレクション設定内の `再発行する`
* 再発行は **即時反映**
* 旧リンクは **即時解除（revoked）**
* 新リンクは **その場で表示/コピー可能**

---

## 2) 確認モーダル（FIX）

### 表示内容

* タイトル：`限定リンクを再発行しますか？`
* 説明（必ず表示）：

  * `再発行すると、今のリンクは使えなくなります。`
  * `共有している相手は閲覧できなくなります。`
* ボタン：

  * `再発行する`
  * `キャンセル`

---

## 3) “理解チェック” （FIX）

* チェックボックス必須：

  * `現在の限定リンクが無効になることを理解しました`
* チェックが入るまで `再発行する` は無効

---

## 4) 再発行後の表示（FIX）

* 再発行完了後、完了トースト：

  * `限定リンクを再発行しました`
* 新リンクは

  * `コピー` ボタンでコピーできる
  * URLは画面に表示してよい（ユーザーが共有するため）

---

次は、限定リンクの“共有”が絡むので、**OGP（リンクカード）をどうするか**を仕様でFIXする（限定リンクでサムネ/タイトルを出すか、出さないか）。


## ✅FIX：限定リンクのOGP（リンクカード）表示方針

目的：X/Discord/LINE等で共有したときのカード表示の扱いを統一する。

## ✅更新FIX：限定リンクのOGP（画像はアイコンのみ）

### 1) OGP基本方針（FIX）

* 限定リンクでもOGPは出す（共有用途）
* ただし「閉じた閲覧」方針を優先し、情報は最小

### 2) OGPに含める情報（FIX）

* `display_name`
* `handle`
* サイト名：`Vistia`
* 種別ラベル：`限定`
* **OGP画像：ユーザーのアイコン（avatar）のみ**

  * 作品画像・コレクション画像は **OGPに使わない**
  * 画像URLは必ず `img.vistia.studio` の `display/avatar/...` を使用（original禁止は既方針どおり）

### 3) token無効時（FIX）

* 無効ならOGP含めて404（理由表示なし）

次は、限定リンクページ自体の表示でも「作品画像は見える」ので、**限定リンクページで表示して良い要素（タイトル無し前提で何を出すか）**をFIXする。


## 4) クローラ判定（FIX）

* 特定UAだけ特別扱いはしない（初期FIX）
* 通常のHTMLレスポンスでOGPを返す

---

## ✅FIX：限定リンクページの表示範囲（閉じた閲覧の具体）

対象：

* 作品の限定リンク（限定=UNLISTEDの作品）
* コレクションの限定リンク（限定=UNLISTEDのコレクション）

目的：共有で見せたいものだけ見せて、導線で広げない。

---

## 1) 共通（作品/コレクション）（FIX）

限定リンクページで表示してよいのは以下のみ：

* ユーザーアイコン
* ユーザー表示名
* `@handle`
* コンテンツ本体（作品画像 / コレクション内作品）
* 戻る導線：**なし**（ギャラリーへ戻る等は出さない）
* 作品/コレクションのメタ情報

  * タグ：**表示しない**
  * 作品タイトル：そもそも無し（既FIX）

---

## 2) 作品の限定リンクページ（FIX）

* 表示：

  * その作品の画像（display）
* 操作：

  * 次/前スワイプ：**無し**（単体閲覧のみ）
  * 共有ボタン：**無し**（共有はURLコピーで足りる想定）
  * 保存抑止：既FIXの全面抑止を適用

---

## 3) コレクションの限定リンクページ（FIX）

* 表示：

  * コレクションに含まれる作品を一覧表示（thumbグリッド）
  * タップでモーダル表示（display）
* 操作：

  * 作品モーダルは次/前スワイプOK（既FIXのギャラリー詳細と同等）
* 導線：

  * 「他のコレクション」「ギャラリーを見る」などの導線は **出さない**

---

## 4) 表示できないもの（FIX）

* Links
* YouTube
* ピン
* コレクション一覧ボタン
* 検索

---

## ✅FIX：限定リンクページの広告表示（公開と同じ扱い）

前提（既FIX）：Freeは広告あり / Proは広告なし。UNLISTED（限定）の広告は通常公開と同じ扱い。

---

## 1) 広告の基本（FIX）

* 限定リンクページでも広告は **通常公開ページと同じルール**で表示する

  * Free：広告あり
  * Pro：広告なし

---

## 2) 表示形式（FIX）

* 広告は既FIXの **追従固定バナー（ページ下部）**
* UIにかぶってOK、モーダル中も表示（既FIX）

---

## 3) 例外（FIX）

* なし（限定だから広告を消す等はしない）

---

## ✅FIX：限定リンクの無効化条件（ユーザー停止/退会/運営操作）とPublic挙動

前提（既FIX）：Publicは理由非表示、原則404。限定リンクも無効なら404。

---

## 1) 限定リンクが“閲覧不可”になる条件（FIX）

以下のいずれかに該当したら、限定リンクは閲覧できない（= Publicは404）：

### 1.1 対象リソースが無効（FIX）

* 作品/コレクションが **削除**された（論理削除含む）
* 作品/コレクションが **運営非公開（hide）**になった
* 作品/コレクションの公開範囲が **限定以外（公開/非公開）に変更**された
  → 限定リンクは即時解除（revoked）（既FIX）

### 1.2 tokenが無効（FIX）

* tokenが `revoked`
* tokenが存在しない/不正
* Pro→Free失効で上限超過となり自動解除された（既FIX）

### 1.3 ユーザー状態が無効（FIX）

* ユーザーが **停止（suspend）**された
* ユーザーが **退会（deleted）**状態になった

---

## 2) Public側の挙動（FIX）

* 上記いずれの理由でも **すべて404**
* 理由表示はしない（既FIX）

---

## 3) Manage側の挙動（FIX）

* ユーザー自身が限定リンクを持つ対象が無効化された場合でも

  * 限定リンク管理画面では状態が `解除済み` になる（revoked）
  * 解除理由は表示しない（初期FIX）
* ただし運営によるhide/deleteは対象にステータス表示（HIDDEN_BY_ADMIN等）は維持

---

## ✅FIX：Free「有効な限定リンク3つまで」の数え方（厳密定義）

前提（既FIX）

* 表示名：限定（UNLISTED）
* Free：有効な限定リンクは合計3つまで
* Pro：無制限
* 上限超過時：新規の限定化はブロック、Pro→Free失効時は超過分を自動解除（revoked）

---

## 1) カウント対象（FIX）

“有効な限定リンク数（active_count）” は、ユーザー単位で次を合算して数える：

* **作品の限定リンク（Work UNLISTED token）**
* **コレクションの限定リンク（Collection UNLISTED token）**

---

## 2) 「有効（ACTIVE）」の定義（FIX）

以下をすべて満たすものだけを **ACTIVEとしてカウント**する：

* tokenが `revoked_at = NULL`（解除されていない）
* 対象リソースが

  * 論理削除されていない
  * 運営非公開（hide）されていない
  * 公開範囲が「限定」のまま
* 所有ユーザーが

  * 退会していない
  * 停止していない

---

## 3) カウント除外（FIX）

次は **カウントしない（0扱い）**：

* `REVOKED`（revoked_atあり）
* 対象が削除済み/運営非公開/限定以外へ変更
* ユーザーが停止/退会中（この間はactive_count=0として扱う）

---

## 4) 上限チェックを行うタイミング（FIX）

* Work/Collection を **限定に変更する瞬間**にチェックする
* Freeで `active_count >= 3` の場合：

  * 変更を拒否（ブロック）
  * 文言：`限定リンクの上限に達しています。不要な限定リンクを解除してください。`

---

## 5) Pro → Free 失効時の処理（FIX）

* 失効時点で `active_count > 3` の場合

  * `issued_at` 降順で **最新3つを残す**
  * それ以外は `revoked_at` を設定して解除
  * 通知：`TOKEN_REVOKED`（強制メール）

---

## ✅FIX：新規作成（サインアップ）フロー（Manage）

前提（既FIX）

* ログインと新規作成は完全分離
* ユーザー作成は **「新規作成」ボタンからのみ**
* OAuthは **ログイン経路でユーザーを作らない**／**自動連携しない**

---

## 1) 新規作成の入口（FIX）

* ログイン画面に **「新規作成」ボタン**を設置
* 押下で `新規作成ページ` に遷移
* 新規作成ページには以下の方法を表示

  * `メールで新規作成`
  * `Googleで新規作成`
  * `Xで新規作成`

---

## 2) 新規作成で必須入力する項目（FIX）

新規作成完了に必要な必須項目は以下：

* `handle`（必須）
* `display_name`（必須）
* 認証手段（メール or OAuth のどれか1つ必須）

※bio / YouTube / Links は後から設定

---

## 3) メールで新規作成（FIX）

### 3.1 フロー（FIX）

1. 新規作成ページでメール入力
2. 送信 → **新規作成用 Magic Link** を送る
3. リンクを開くと「ユーザー情報入力（handle / display_name）」画面
4. 確定でユーザー作成

### 3.2 送信時の応答（FIX）

* 既にそのメールが登録済みなら：`すでに登録されています`（メール送らない）
* 未登録なら：`送信しました`

### 3.3 新規作成用Magic Link（FIX）

* 有効期限：15分
* ワンタイム
* 最新のみ有効
* DB保存はハッシュのみ
* レート制限：

  * email単位：1時間5回
  * IP単位：1時間20回
* 失敗文言（固定）：`リンクが無効です。もう一度お試しください。`

---

## 4) OAuthで新規作成（Google / X）（FIX）

### 4.1 フロー（FIX）

1. 新規作成ページで OAuth を開始
2. OAuth成功後、「ユーザー情報入力（handle / display_name）」画面へ
3. 確定でユーザー作成＋provider連携を作成

### 4.2 既存連携がある場合（FIX）

* 同じ `provider + provider_user_id` が既に存在する場合：`すでに登録されています`（作成不可）

### 4.3 メールの扱い（FIX）

* OAuthからメールが取れても **自動統合はしない**
* ただし「新規作成したユーザーの連絡先メール」として保存してよい（verifiedの有無は設計側）
* Xでメールが取れない場合：ユーザーは **メール無しでも作成可**

---

## 5) handle / display_name 入力時のバリデーション（FIX）

* 既存の handle ルール（文字種/長さ/予約語/変更制限など）に従う
* handleが既に使われている場合：`すでに存在します`（409相当）
* display_name は 1〜30（Unicode可）

---

## 6) 作成完了時（FIX）

* ユーザー作成成功 → `manage_session` を発行してログイン状態にする
* 初期状態

  * Proではない（Free）
  * ピンなし
  * コレクションなし
  * Linksなし
  * YouTube未設定

---

## 7) レート制限（FIX）

* 新規作成ページからの作成試行（メール送信・OAuth開始含む）

  * IP単位：1時間60回まで
* 超過時：429（固定文言）

---

## ✅FIX：メールアドレスの追加・変更（Manage）

目的：OAuthで作ったユーザー（メール無し含む）も、後からメールを持てるようにする。
前提：任意メール通知OFFは `users.email_optional_enabled`（既FIX）。

---

## 1) メールの位置づけ（FIX）

* Manageユーザーは `email` を **持っても持たなくてもよい**
* ただし **強制メール reason_code** を確実に届けたいので、

  * メール未登録ユーザーには Manage内で「メール追加」を促してよい（強制ではない）

---

## 2) メール追加（FIX）

### 2.1 入口

* Manage設定に「メールアドレス」セクションを設ける
* `メールを追加` ボタンを表示（未登録の場合）

### 2.2 フロー

* 入力：email
* 検証：**確認メール（Magic Link）で所有確認**してから登録

  * 有効期限：15分
  * ワンタイム
  * 最新のみ有効
  * DB保存はハッシュのみ

### 2.3 既存メールとの重複（FIX）

* すでに他ユーザーがそのメールを使っている場合：`すでに存在します`（409）

### 2.4 完了

* 確認リンク消費成功で `users.email` に反映

---

## 3) メール変更（FIX）

### 3.1 入口

* 既にメールがある場合は `メールを変更` を表示

### 3.2 フロー（FIX）

* 新しいメールを入力 → 確認メール（Magic Link）で所有確認 → 反映
* 反映時の処理（FIX）

  * `users.email` を更新
  * `users.email_bounced = false` にリセット
  * `users.email_complained = false` は **リセットしない**（運用で解除する）

    * ※complaintは受信者の意思なので自動解除しない方針を維持

---

## 4) メール削除（FIX：提供しない）

* 初期はメールの「削除」機能は提供しない（事故防止）

  * どうしても消したい場合は「変更」で別アドレスに変更する

---

## 5) レート制限（FIX）

* メール追加/変更の確認メール送信

  * email単位：1時間5回
  * IP単位：1時間20回
* 超過時：429（固定文言）

---

## 6) 任意メール通知スイッチ（FIX補足）

* メール未登録の場合でも `email_optional_enabled` は保持してよい
* 任意メール送信条件は既FIXの判定ロジックに従う

  * メールがNULLなら送れない（in-appのみ）

---

## ✅FIX：Emailログイン（Magic Link）とメール変更後のログイン整合

目的：メール追加/変更した後に、Emailログインが確実に動くようにする。

---

## 1) Emailログインの対象（FIX）

* Emailログイン（Magic Link）は **`users.email` に登録済みのメールだけ**を対象にする
* 未登録メールでログインを試みた場合は **`未登録です`** を返す（既FIX）

---

## 2) メール変更後のログイン（FIX）

* `users.email` を変更したら、以後 Emailログインの対象は **新メールのみ**
* 旧メールではログインできない

  * 応答：`未登録です`
* メール変更が確定したタイミングで

  * **旧メール宛に発行済みのMagic Linkトークンは全て無効化**する（最新のみ有効ルールに含める）

---

## 3) Magic Linkの「ユーザー特定」方法（FIX）

* Magic Link発行時は、必ず

  * email → user_id を解決してから発行する
* token消費時は

  * token→発行レコード→user_id を特定してセッション発行
* tokenは常に「特定ユーザーに紐付く」前提（汎用トークンにはしない）

---

## 4) セキュリティ（FIX）

* token平文は保存しない（既FIX）
* tokenをログに出さない（既FIX）
* 無効リンクのエラーは固定：`リンクが無効です。もう一度ログインしてください。`（既FIX）

---

## ✅FIX：ログイン手段の連携管理UI（Email / Google / X）

前提（既FIX）

* 自動連携しない
* ログイン経路でユーザー作成しない
* 連携は **ログイン後のユーザー操作でのみ**行う
* 初期は連携解除を提供しない（FIX）

---

## 1) 設置場所（FIX）

* Manage設定に「ログイン方法」ページを追加する

---

## 2) 表示内容（FIX）

「ログイン方法」ページには以下を表示する：

### 2.1 Email

* 状態：

  * 登録済みなら `登録済み（xxxx@***）` のようにマスク表示
  * 未登録なら `未登録`
* 操作：

  * 未登録の場合：`メールを追加`（別FIXのメール追加フローへ）
  * 登録済みの場合：`メールを変更`（別FIXのメール変更フローへ）

### 2.2 Google / X

* 状態：

  * 連携済み：`連携済み`
  * 未連携：`未連携`
* 操作：

  * 未連携の場合のみ `連携する` ボタンを表示
  * 連携済みは操作なし（解除不可のため）

---

## 3) 連携フロー（FIX）

* `連携する` 押下 → OAuth開始
* OAuth成功後の判定

  * その `provider + provider_user_id` が未使用なら：連携成功
  * 既に別ユーザーで使用中なら：連携不可

    * 文言：`このアカウントは別のユーザーで使用されています`

---

## 4) 連携の安全ガード（FIX）

* 連携操作は **TOTPや追加認証は不要（初期FIX）**

  * ただし、セッションが有効なことは前提
* 連携成功/失敗は監査ログに残す（audit_logsでなくても可、設計側で）

---

## 5) 解除（FIX：提供しない）

* 初期は解除機能を提供しない
* どうしても解除が必要な場合は運営対応（チケット運用に乗せる）※必要なら後でFIX

---

## ✅FIX：新規ログイン検知の通知（セキュリティ通知）

目的：アカウント乗っ取りに気づけるようにする（ただし騒がしすぎない）。

---

## 1) 何を“新規ログイン”とみなすか（FIX）

以下のどれかが変わったログインを「新規ログイン」とする：

* 端末識別（device_id相当：Cookieベースの端末ID）
* IPの大きな変化（同一/近傍判定はしない。単純に前回と違えば変化扱い）
* User-Agent（ブラウザ種別）が前回と違う

※判定は **厳密でなくてよい**（誤検知は許容、ただし頻発させない）

---

## 2) 通知するか（FIX）

* **in-app通知：送る**
* **メール：送らない（初期FIX）**

  * 理由：メール通知が多いと鬱陶しい＆complaintリスク

reason_code（FIX）

* `SECURITY_NEW_LOGIN`（新規追加）

---

## 3) 通知内容（FIX）

テンプレに入れる情報（最小）：

* `{{effective_at}}`（JST）
* ログイン方法（Email / Google / X）
* だいたいの環境（例：`Chrome / Windows` くらい）
* IPは **表示しない**（個人情報寄り・誤差もあるため）

文言例（テンプレ用の方向性）

* `新しい環境からログインがありました。心当たりがなければパスワード変更やログイン方法の確認を行ってください。`

---

## 4) 送信の抑制（FIX）

* 同一ユーザーに対して、新規ログイン通知は **24時間に1回まで**

  * 24時間以内に複数回ログインがあっても追加通知しない

---

## 5) 管理（FIX）

* in-app通知は既FIXの保持/上限に従う（180日、最大1万件）

---

## ✅FIX：Adminの新規ログイン検知（通知は出さず監査のみ）

前提：Adminは2FA必須。in-app通知の概念はManage側。メールを増やすと運用が重くなる。

---

## 1) 新規ログイン検知の扱い（FIX）

* Adminで「新規ログイン相当」を検知しても **ユーザー（Admin）への通知はしない**
* 代わりに **監査ログ（audit_logs）に必ず記録**する

---

## 2) “新規ログイン相当” の判定（FIX）

以下のどれかが変わったら新規扱いとして記録する：

* IP
* User-Agent
* 端末識識別（可能ならcookieベースのdevice_id）

---

## 3) 記録内容（FIX）

audit_logs に最低限記録：

* actor：admin_user_id
* action：`ADMIN_LOGIN_NEW_ENV`
* request_id
* meta：

  * ip（保存はハッシュでOK）
  * user_agent
  * provider（password+totp固定）

---

## 4) 例外（FIX）

* 連続失敗/ロック発生も監査ログに記録する（通知はしない）

---

## ✅FIX：Adminのパスワード変更ガード（TOTP再入力必須）

目的：セッション乗っ取り時にパスワードを変えられる事故を防ぐ。

---

## 1) 対象（FIX）

* Admin設定での「パスワード変更」

---

## 2) 必須要件（FIX）

パスワード変更時は以下をすべて必須にする：

1. 現在のパスワード入力
2. 新パスワード入力（最小8文字、最大72文字）
3. **TOTPコード入力（再認証）**

---

## 3) 変更完了時の処理（FIX）

* パスワード変更が成功したら

  * **全セッション破棄**（当該Adminのadmin_sessionsを全失効）
  * 現在操作中のセッションも失効 → 再ログインが必要

---

## 4) 失敗時（FIX）

* 文言は固定：`入力が正しくありません。`
* 連続失敗は既FIXのロック（10分で10回失敗→10分ロック）を適用してよい

---

## ✅FIX：Adminの2FA再セットアップ（端末変更・紛失対応）

前提（既FIX）

* 2FAはTOTPのみ
* バックアップコード10個（再発行で旧無効）
* 両方失った場合はOwnerが2FAリセット可能

---

## 1) 2FA再セットアップの入口（FIX）

Admin設定に以下を用意：

* `2FAを再設定` ボタン

---

## 2) 再セットアップの方法（FIX）

再セットアップ（新しいTOTPシークレット発行）は、次のどちらかで許可する：

### A) TOTPで再認証できる場合（FIX）

* 入力必須：

  * 現在のパスワード
  * **現在のTOTPコード**
* 成功したら：

  * 新しいTOTPシークレットを発行
  * 新QR/シークレットで登録
  * 新TOTPで検証して完了
  * **バックアップコードを新しく10個再発行（旧は全無効）**
  * バックアップコードはその場で1回だけ表示

### B) TOTPが使えないがバックアップコードがある場合（FIX）

* 入力必須：

  * 現在のパスワード
  * **バックアップコード1つ**
* 成功したら：

  * 上と同じく新TOTP発行→検証→バックアップコード再発行

---

## 3) 再セットアップ完了時の処理（FIX）

* 完了したら当該Adminの **全セッション破棄**
* 再ログイン必須

---

## 4) どちらも無い場合（FIX）

* TOTPもバックアップコードも無い場合は

  * 本人では再セットアップ不可
  * Ownerによる `2FAリセット` のみ（既FIX）
  * 表示文言：`運営にお問い合わせください。`（固定）

---

## 5) 監査（FIX）

* 以下はすべて audit_logs に記録

  * 2FA再セットアップ成功/失敗（回数のみ、コード内容は保存しない）
  * バックアップコード再発行
  * Ownerによる2FAリセット

---

## ✅FIX：Admin重大操作の確認入力（方式を統一）

前提（既FIX）：重大操作（停止/解除、削除、Pro剥奪、限定リンク解除など）は入力確認必須（スマホ前提）。

---

## 1) 確認方式（FIX）

* 重大操作の最終確定は **確認入力必須**とする
* 方式は **対象ID末尾6桁** を入力する方式に統一する
  （`CONFIRM`固定文字は使わない）

---

## 2) 対象IDの定義（FIX）

* 対象IDはリソース種別ごとに以下を使う：

  * ユーザー：`user_id`
  * 作品：`work_id`
  * コレクション：`collection_id`
  * Adminユーザー：`admin_user_id`
  * 通知テンプレ：`reason_code` ではなく **template_id**（ID末尾6桁）

※UUIDの場合はハイフンを除去した文字列の末尾6桁を表示して入力させる

---

## 3) UI表示（FIX）

* 確認モーダルに次を表示

  * 影響説明（理由は出さない方針は維持）
  * `次の6文字を入力してください：XXXXXX`
  * 入力欄
  * `実行する`（危険ボタン）

* 入力が一致するまで `実行する` は無効

---

## 4) 連打・誤操作防止（FIX）

* 同一対象への重大操作：30秒クールダウン（既FIXと整合）
* 実行後はトースト：`実行しました`

---

## 5) 監査（FIX）

* audit_logsに必ず記録

  * actor, action, target_id, request_id
  * before/after（可能な範囲）
  * reason_code（通知を伴う場合）

---

## ✅FIX：Admin重大操作の「理由」入力（reason_code必須 / 自由文は追記のみ）

目的：通知テンプレ・監査ログ・チケット運用をブレさせない。

---

## 1) reason_code（FIX）

* ユーザーに通知が発生する重大操作は **reason_code必須**
* reason_codeは **固定リストから選択**（自由入力不可）

対象例（代表）

* `ACCOUNT_SUSPENDED`
* `ACCOUNT_RESTORED`
* `WORK_HIDDEN_BY_ADMIN`
* `WORK_DELETED_BY_ADMIN`
* `COLLECTION_HIDDEN_BY_ADMIN`
* `COLLECTION_DELETED_BY_ADMIN`
* `TOKEN_REVOKED`
* `PRO_GRANTED_MANUAL`
* `PRO_REVOKED_MANUAL`
* `SUBSCRIPTION_PAYMENT_FAILED`

---

## 2) 自由文（FIX）

* 自由文で入力できるのは **追記メモのみ**
* 追記メモの仕様は既FIX（0〜300文字、httpsのみ、HTML無効化、改行最大5行）

---

## 3) 画面UI（FIX）

重大操作の確認画面には以下を必ず出す：

1. reason_code選択（必須）
2. 追記メモ入力（任意）
3. 対象ID末尾6桁の確認入力（既FIX）
4. 実行ボタン

---

## 4) 監査ログ（FIX）

audit_logsに必ず入れる：

* actor（admin_user_id）
* action
* target_id
* reason_code
* template_version（通知を送った場合）
* 追記メモ有無（本文は入れない）

---

## 5) チケットとの整合（FIX）

* 重大操作がチケット起因の場合は

  * `ticket_id` を監査ログに紐付ける（metaに保持）
* チケットが無い手動操作（manual）でも

  * reason_codeは必須（運用の一貫性）

---

## ✅FIX：reason_code の日本語ラベル紐づけ

### 1) 方針（FIX）

* `reason_code` は **内部キー**として固定（例：`WORK_HIDDEN_BY_ADMIN`）
* UI表示では `reason_label_ja`（日本語名）を併記/表示する
* ユーザー向け文面はテンプレ本文で制御（labelは管理者の選択補助）

---

### 2) 日本語ラベル（FIX：辞書）

* `ACCOUNT_SUSPENDED`：アカウント停止
* `ACCOUNT_RESTORED`：アカウント停止解除
* `WORK_HIDDEN_BY_ADMIN`：作品の非公開（運営）
* `WORK_DELETED_BY_ADMIN`：作品の削除（運営）
* `COLLECTION_HIDDEN_BY_ADMIN`：コレクションの非公開（運営）
* `COLLECTION_DELETED_BY_ADMIN`：コレクションの削除（運営）
* `TOKEN_REVOKED`：限定リンク解除
* `PRO_GRANTED_MANUAL`：Pro付与（手動）
* `PRO_REVOKED_MANUAL`：Pro解除（手動）
* `SUBSCRIPTION_PAYMENT_FAILED`：支払い失敗

（今後reason_codeが増えたらこの辞書に追加する運用）

---

### 3) DB/設計の持ち方（FIX）

以下どちらでもOK。初期は軽い方で。

**A. アプリ側の静的辞書（推奨 / FIX）**

* Adminフロントに `reason_code -> 日本語ラベル` の辞書を持つ
* DB変更不要

**B. DBマスタ（将来拡張向け / TBDにせず後回し）**

* `reason_codes` テーブル等で `code, label_ja, description` を管理

---

### 4) UI（FIX）

* reason_code選択UIは

  * `日本語ラベル` を主表示
  * 補助で `reason_code` を小さく表示（誤選択防止）

---

## ✅FIX：ticket_events の event_type（同一チケットに履歴を積む）

前提（既FIX）

* 通報/自動検知はすべてチケット化
* 自動削除/自動BANなし（人が判断）
* 復旧/異議申立は別チケットにせず **同一チケットに ticket_events で積む**
* 優先度は全部High

---

## 1) ticket の状態（FIX）

チケットの `status` は以下に固定する：

* `OPEN`：未対応
* `IN_PROGRESS`：対応中
* `NEED_USER`：ユーザー返信待ち（異議申立/追加情報待ち）
* `RESOLVED`：対応完了
* `CLOSED`：クローズ（再開しない）

---

## 2) ticket_events の event_type（FIX）

`ticket_events.event_type` は固定リストにする（自由入力しない）

### A) 生成・検知

* `TICKET_CREATED`：チケット作成
* `AUTO_FLAGGED`：自動検知により起票（nsfw/violence/selfharm/substance/manual）
* `AUTO_FLAG_FAILED`：自動検知失敗→manual起票（既FIXのケース）

### B) ステータス・担当

* `STATUS_CHANGED`：status変更
* `ASSIGNEE_CHANGED`：担当変更

### C) ユーザー申立・通信

* `USER_APPEAL_SUBMITTED`：ユーザー異議申立
* `USER_MESSAGE`：ユーザーからの追加メッセージ（自由文）
* `ADMIN_MESSAGE`：運営からの返信（自由文）
* `EVIDENCE_ATTACHED`：証跡添付（リンク/参照ID）

### D) 実施アクション（実体操作）

* `ACTION_WORK_HIDDEN`：作品非公開
* `ACTION_WORK_DELETED`：作品削除
* `ACTION_COLLECTION_HIDDEN`：コレクション非公開
* `ACTION_COLLECTION_DELETED`：コレクション削除
* `ACTION_USER_SUSPENDED`：ユーザー停止
* `ACTION_USER_RESTORED`：ユーザー停止解除
* `ACTION_TOKEN_REVOKED`：限定リンク解除
* `ACTION_PRO_GRANTED`：Pro付与
* `ACTION_PRO_REVOKED`：Pro解除

### E) 通知

* `NOTIFICATION_SENT`：通知送信（reason_code/テンプレversion/追記有無）

### F) 監査・メモ

* `INTERNAL_NOTE`：内部メモ（ユーザーには非表示）
* `AUDIT_REF`：監査ログ参照（request_id等）

---

## 3) event payload（FIX）

eventごとに `meta` に最低限これを入れる（可能な範囲で）：

* actor（admin_user_id / system）
* target（work_id / user_id / collection_id）
* reason_code（通知/アクションに紐づく場合）
* request_id
* before/after（status変更など）

---

## 4) 表示（Admin）（FIX）

* ticket_eventsは時系列で表示
* `INTERNAL_NOTE` は Owner/Moderator/Supportのみ閲覧可（ユーザーには出さない）

---

## ✅FIX：ticket_type → 初期イベント必須セット（抜け防止）

目的：ticket_typeごとに「最低限これが入っていないと困る」を固定して、運用の穴を無くす。

---

## 1) ticket_type（既FIXの再掲）

* `report`
* `nsfw_alert`
* `violence_gore_alert`
* `selfharm_alert`
* `abuse_storage_alert`
* `substance_alert`（薬物のみ）
* `manual`

---

## 2) 全ticket共通の必須初期イベント（FIX）

チケット作成時に必ず ticket_events を2つ積む：

1. `TICKET_CREATED`

   * meta：`ticket_type`, `created_by`（system / admin_user_id）
2. `STATUS_CHANGED`

   * `OPEN` で開始
   * meta：`before=null`, `after=OPEN`

---

## 3) type別の追加必須イベント（FIX）

### 3.1 `report`（通報）

* 必須：

  * `EVIDENCE_ATTACHED`（通報対象の参照：work_id/collection_id/user_id いずれか必須）
  * `USER_MESSAGE`（通報本文。空は不可）
* 任意：

  * `ADMIN_MESSAGE`（受領返信）

### 3.2 `nsfw_alert` / `violence_gore_alert` / `selfharm_alert` / `substance_alert`

* 必須：

  * `AUTO_FLAGGED`

    * metaに **payloadの参照（S3 key など）** を必ず入れる
    * L2/L3はVistia側で持たない（既FIX）なので「中身」はmetaに参照だけ
  * `EVIDENCE_ATTACHED`（対象 work_id 必須）
* 例外（既FIX）：

  * 自動検知失敗の場合は `AUTO_FLAG_FAILED` を積み、ticket_typeは `manual` にする

### 3.3 `abuse_storage_alert`（ストレージ悪用）

* 必須：

  * `AUTO_FLAGGED`（キュー溢れ/大量失敗/容量などの検知理由をmetaに）
  * `EVIDENCE_ATTACHED`（user_id必須、可能なら直近work_idも添付）
* 任意：

  * `ASSIGNEE_CHANGED`（初期担当を付ける場合）

### 3.4 `manual`

* 必須：

  * `INTERNAL_NOTE`（作成理由。空は不可）
  * `EVIDENCE_ATTACHED`（対象参照があれば必ず）

---

## 4) 起票時の優先度（FIX）

* 全て **High**（既FIX）

---

## ✅FIX：チケットから実行できるアクション（許可マトリクス）

目的：ticket_typeごとに「何をやっていいか」を固定して、対応のばらつきを防ぐ。

---

## 1) 共通ルール（FIX）

* すべての実体操作（hide/delete/suspend/token revoke/pro付与等）は

  * **チケットを開いた状態で実行**できる
  * 実行すると `ticket_events` に `ACTION_*` と `NOTIFICATION_SENT` を必ず積む
* 自動アクション（自動削除/自動BAN）はしない（既FIX）
* 重大操作ガード（確認入力・クールダウン）はチケット経由でも必須（既FIX）

---

## 2) アクション許可マトリクス（FIX）

### A) `report`

許可：

* `ACTION_WORK_HIDDEN` / `ACTION_WORK_DELETED`
* `ACTION_COLLECTION_HIDDEN` / `ACTION_COLLECTION_DELETED`
* `ACTION_USER_SUSPENDED` / `ACTION_USER_RESTORED`
* `ACTION_TOKEN_REVOKED`
* `ACTION_PRO_GRANTED` / `ACTION_PRO_REVOKED`（必要な場合のみ）

---

### B) `nsfw_alert`

許可（原則：対象作品への対応）：

* `ACTION_WORK_HIDDEN` / `ACTION_WORK_DELETED`
* `ACTION_USER_SUSPENDED`（繰り返し等で必要な場合）
* `ACTION_TOKEN_REVOKED`（対象が限定リンクの場合）

禁止（FIX）：

* コレクション削除/非公開は **nsfw_alert単体ではしない**

  * 必要なら `manual` で根拠を追記して対応

---

### C) `violence_gore_alert`

許可：

* `ACTION_WORK_HIDDEN` / `ACTION_WORK_DELETED`
* `ACTION_USER_SUSPENDED`（悪質/反復の場合）
* `ACTION_TOKEN_REVOKED`

禁止（FIX）：

* コレクション対応は `manual` へ寄せる（同上）

---

### D) `selfharm_alert`

許可（慎重運用）：

* `ACTION_WORK_HIDDEN`（基本はまず非公開）
* `ACTION_WORK_DELETED`（明確な危険・違反の場合のみ）
* `ACTION_USER_SUSPENDED`（危険度が高い場合）

禁止（FIX）：

* Pro剥奪はしない（このticket_typeの範囲外）

---

### E) `substance_alert`（薬物のみ）

許可：

* `ACTION_WORK_HIDDEN` / `ACTION_WORK_DELETED`
* `ACTION_USER_SUSPENDED`（悪質/反復）
* `ACTION_TOKEN_REVOKED`

---

### F) `abuse_storage_alert`

許可（対象はユーザー）：

* `ACTION_USER_SUSPENDED`（まず停止で被害拡大を止める）
* `ACTION_USER_RESTORED`
* `ACTION_WORK_DELETED`（大量スパム等で必要なら）
* `ACTION_TOKEN_REVOKED`（必要なら）

---

### G) `manual`

許可：

* 全アクション可（運営判断のため）

  * `ACTION_*` 全種

---

## 3) 実行時の通知（FIX）

* アクションを実行したら必ず

  * reason_codeを選択（日本語ラベルつき）
  * 追記メモ（任意）
  * 送信 → `NOTIFICATION_SENT` を積む

---

## ✅FIX：チケットを RESOLVED / CLOSED にする条件（完了定義）

目的：対応完了の判断を統一して、放置ややりっぱなしを防ぐ。

---

## 1) ステータス遷移の基本（FIX）

* `OPEN → IN_PROGRESS → RESOLVED → CLOSED` を基本フローとする
* 例外的に `OPEN → RESOLVED` は許可（軽微で即完了の場合）
* `CLOSED` は最終（原則再オープンしない）

---

## 2) RESOLVED の条件（FIX）

`RESOLVED` にするには、以下のいずれかを満たす必要がある：

### A) アクション実施で解決（FIX）

* `ACTION_*` が実行され、必要な通知（`NOTIFICATION_SENT`）も積まれている
  例：作品非公開/削除、ユーザー停止、限定リンク解除など

### B) “対応不要”の判断（FIX）

* 運営判断で「違反なし/対応不要」とした場合

  * `INTERNAL_NOTE` に判断理由を必ず記録（空不可）
  * ユーザーへの通知は **送らない**（初期FIX：不要な刺激を避ける）

### C) 申立が取り下げられた（FIX）

* reportの場合のみ

  * `USER_MESSAGE` で取り下げが確認できる
  * `INTERNAL_NOTE` に「取り下げ」記録を残す

---

## 3) NEED_USER の条件（FIX）

* 異議申立や追加情報が必要な場合は `NEED_USER`
* `NEED_USER` にしたら

  * `ADMIN_MESSAGE` で必要事項を送る（テンプレでOK）
* ユーザー返信が来たら `IN_PROGRESS` に戻す

---

## 4) CLOSED の条件（FIX）

`CLOSED` にできるのは `RESOLVED` の後だけ。

* `RESOLVED` から **7日経過**したら `CLOSED` にしてよい（自動でも手動でもOK）
* ただし、以下の場合は `CLOSED` を遅らせる

  * ユーザー側の異議申立が継続している
  * 復旧や追加対応が予定されている

---

## 5) 監査（FIX）

* `STATUS_CHANGED` を必ず積む（before/after）
* `RESOLVED` / `CLOSED` へ変更した理由は `INTERNAL_NOTE` に残してよい（推奨）

---

## ✅FIX：チケットの再開（REOPEN）の扱い

前提（既FIX）：復旧/異議申立は同一チケットに ticket_events で積む。CLOSEDは原則再開しない。

---

## 1) 方針（FIX）

* `CLOSED` のチケットは **原則として再オープンしない**
* ただし例外として、**同一事案の継続**が明らかな場合のみ「再開」を許可する

---

## 2) 再開を許可する条件（FIX）

`CLOSED` から再開できるのは、以下すべてを満たす場合：

* 同一の対象（work_id / collection_id / user_id）
* 同一の論点（例：同じ通報理由、同じ自動検知カテゴリ）
* `CLOSED` から **30日以内**

---

## 3) 再開の方法（FIX）

* `CLOSED → IN_PROGRESS` に直接戻す（OPENには戻さない）
* ticket_events に必ず追加：

  * `STATUS_CHANGED`（before=CLOSED, after=IN_PROGRESS）
  * `INTERNAL_NOTE`（再開理由。空不可）
  * `AUDIT_REF`（関連する監査ログがあれば）

---

## 4) 再開を許可しない場合（FIX）

上の条件を満たさない場合は **新チケットを作る**

* ticket_typeは状況に応じて（report/alert/manual）
* 新チケットの先頭に `AUDIT_REF` / `EVIDENCE_ATTACHED` で旧ticket_idを参照する

---

## 5) ユーザーへの見え方（FIX）

* 再開/新規いずれでも、Public側の表示方針（理由非表示）に影響なし
* ユーザーへの通知が必要なアクションをした場合のみ通知する（既FIX）

---

## ✅FIX：チケット操作のRBAC（誰が何をできるか）

前提（既FIX）

* Owner：全権（Adminユーザー作成/権限変更はOwnerのみ）
* Moderator：チケット対応、非公開/削除/token無効、ユーザー停止権限あり
* Support：閲覧中心＋通知送信（テンプレ＋追記）
* 優先度は全てHigh

---

## 1) チケットの閲覧（FIX）

* Owner / Moderator / Support：閲覧可
* Designer：チケット閲覧不可（デザインマスタのみ）

---

## 2) ticket status 操作（FIX）

### Owner

* 全ステータスに変更可（OPEN/IN_PROGRESS/NEED_USER/RESOLVED/CLOSED）
* CLOSED→再開も可（既FIXの条件に従う）

### Moderator

* 変更可：OPEN / IN_PROGRESS / NEED_USER / RESOLVED
* 変更不可：CLOSED（クローズはOwnerのみ）
* CLOSED→再開：不可

### Support

* 変更可：OPEN → IN_PROGRESS / NEED_USER（対応着手・ユーザー待ちへの切替のみ）
* 変更不可：RESOLVED / CLOSED（完了判断はしない）

---

## 3) ticket_events の投稿（FIX）

### INTERNAL_NOTE

* Owner / Moderator：投稿可
* Support：投稿可（ただし「運用メモ」用途。判断理由の確定はしない）

### ADMIN_MESSAGE（ユーザーへの返信）

* Owner / Moderator / Support：投稿可

### EVIDENCE_ATTACHED

* Owner / Moderator / Support：投稿可

---

## 4) 実体アクション（ACTION_*）権限（FIX）

### Owner

* 全アクション可

### Moderator

* 可：

  * 作品/コレクション：hide/delete
  * 限定リンク解除（token revoke）
  * ユーザー停止/解除
  * Pro付与/剥奪（手動）
* （重大操作ガード適用は必須）

### Support

* 不可（閲覧＋通知送信のみ）

---

## 5) 通知送信（NOTIFICATION_SENT）権限（FIX）

* Support / Moderator：送信可（テンプレ＋追記）
* Owner：送信可
* Designer：不可

---

## 6) 監査（FIX）

* status変更、ACTION_*, NOTIFICATION_SENT は全て audit_logs に記録
* 重要操作は確認入力必須（既FIX）

---

## ✅FIX：ユーザーからの返答窓口（NEED_USER時の追加情報/異議申立）

前提（既FIX）

* 復旧/異議申立は同一チケットに `ticket_events` で積む
* メールは任意OFF可、in-app通知は必須

---

## 1) 返答チャネル（FIX）

ユーザーが運営へ返答できる窓口は **Manage内フォームのみ**とする。

* **メール返信は受け付けない**（運用を複雑にしない）
* メール内には「返信しても届きません」を明記する（テンプレ側で）

---

## 2) 返答の入口（FIX）

* in-app通知に「詳細を見る」リンクを付ける
* Manage内の「通知詳細」から

  * 対象チケットの詳細画面へ遷移できる

---

## 3) チケット詳細（ユーザー側）表示（FIX）

ユーザーに見せるのは最小限：

* ステータス（OPEN/IN_PROGRESS/NEED_USER/RESOLVED）を日本語表示

  * OPEN：受付
  * IN_PROGRESS：確認中
  * NEED_USER：追加情報が必要です
  * RESOLVED：対応しました
* 運営からのメッセージ（ADMIN_MESSAGE）
* ユーザーが送ったメッセージ履歴（USER_MESSAGE）
* **内部メモ（INTERNAL_NOTE）は見せない**
* 自動検知payload等も見せない

---

## 4) ユーザー返答（FIX）

* ユーザーは `NEED_USER` のときのみ返信できる
* 返信は `USER_MESSAGE` として ticket_events に積む
* 入力ルール（FIX）

  * 0〜1000文字
  * 改行可（最大20行）
  * URL可（httpsのみ）
  * 画像添付は **不可（初期FIX）**
* 送信後：

  * ステータスを自動で `IN_PROGRESS` に戻してよい（FIX）
  * event：`STATUS_CHANGED` を積む

---

## 5) 異議申立（FIX）

* 「異議申立」ボタンを用意
* 押下すると `USER_APPEAL_SUBMITTED` を積み、入力フォームを出す
* 送信後は `NEED_USER` → `IN_PROGRESS` に戻す（同上）

---

## ✅FIX：Manage内でユーザーに見せる「理由」の粒度（Publicは理由非表示のまま）

目的：Publicは404で隠す一方、Manage内ではユーザーが納得できる最小限の説明を出す。

---

## 1) 基本方針（FIX）

* Public：理由非表示（404統一）※既FIX
* Manage：ユーザー本人に限り、**通知テンプレ本文**で理由を伝える
* ただし、検知ロジックや内部判断（自動検知payload、閾値等）は見せない

---

## 2) ユーザーに見せる情報（FIX）

Manageの通知詳細／チケット詳細で見せてよいのは：

* `{{action}}`（固定辞書の文言）
* `{{effective_at}}`（JST）
* テンプレ本文（運営の説明）
* 追記メモ（Support/Moderatorの任意追記）
* 対象（作品/コレクション）の識別情報

  * 作品：サムネ（thumb）と作成日時
  * コレクション：名前（※名称が無いなら「コレクション」とだけ表示）と作成日時

---

## 3) 見せない情報（FIX）

* ticket_type（report/nsfw_alert等）は表示しない
* 自動検知の結果（スコア/カテゴリ詳細）は表示しない
* 通報者情報は表示しない
* 運営内部メモ（INTERNAL_NOTE）は表示しない
* 監査ログID/request_id は表示しない

---

## 4) 表示の日本語統一（FIX）

* reason_code自体はユーザーに出さない
* ユーザー向けには

  * action辞書（日本語）
  * テンプレ本文（日本語）
    で統一する

---

## 5) 「異議申立」の導線（FIX）

* `WORK_HIDDEN_BY_ADMIN` / `WORK_DELETED_BY_ADMIN` などの運営操作通知には

  * 「異議申立」ボタンを表示してよい
* 押下→既FIXの `USER_APPEAL_SUBMITTED` フローへ

---

## ✅FIX：復旧（restore）仕様（作品/コレクション/ユーザー）

目的：異議申立などで「戻す」時の挙動を統一する。
前提（既FIX）：hideは復旧可能、deleteは復旧不可。Publicは404統一。

---

# 1) Work（作品）

## 1.1 hide の解除（復旧）（FIX）

* 運営が `hide` を解除できる（復旧可能）
* 解除後の挙動：

  * 作品は元の visibility（公開/限定/非公開）を **そのまま保持**して復帰する
  * Public表示もそれに従う

### 限定リンクの扱い（FIX）

* hide中に token は **維持**する（解除しない）
* 復旧後、visibilityが限定のままなら

  * 限定リンクはそのまま有効（ただしFree上限3は別途ルールで管理）
* 復旧後に Free上限3を超過する場合：

  * 失効時と同じく「最新3つ残す・超過分解除」を適用してよい（整合優先）

### 通知（FIX）

* 復旧に伴う通知は **任意**（初期FIX：通知しない）

  * 理由：不要な再燃を避ける
    ※必要になったら reason_code を追加して運用で対応（後回し）

---

## 1.2 delete の復旧（FIX）

* 運営 delete は **復旧不可**
* 30日パージ前でも復旧しない

---

# 2) Collection（コレクション）

## 2.1 hide の解除（復旧）（FIX）

* 運営が解除できる
* visibilityは元の値を保持して復帰
* 限定リンクも維持（Workと同じ）
* 編集制限も解除（通常に戻る）

## 2.2 delete の復旧（FIX）

* 運営 delete は復旧不可（Workと同じ）

---

# 3) User（ユーザー）

## 3.1 suspend 解除（復旧）（FIX）

* 停止解除は可能（既FIX）
* 解除時の挙動：

  * Publicが復帰
  * Manageログインが可能になる
  * ただし過去セッションは破棄済みなので再ログインが必要

---

# 4) チケットへの積み方（FIX）

復旧操作をしたら ticket_events に必ず積む：

* `ACTION_USER_RESTORED`（ユーザーの場合）
* または `STATUS_CHANGED`＋`INTERNAL_NOTE`（hide解除理由）
* 必要なら `NOTIFICATION_SENT`（送る場合のみ）

---

## ✅FIX：復旧時のユーザーへの伝え方（通知は出さず、Manage内表示のみ）

前提：復旧（hide解除 / suspend解除）は可能。Publicは404統一。チケット詳細はManageで見える。

---

## 1) 基本方針（FIX）

* 復旧（復帰）した場合でも、**ユーザーへの通知は送らない**

  * in-app通知：送らない
  * メール：送らない
* 代わりに、Manage内のチケット詳細に「対応完了」として表示する

---

## 2) Manage内の表示（FIX）

* チケットが `RESOLVED` になったら、ユーザー側表示を以下にする

  * ステータス：`対応しました`
  * 運営メッセージ（ADMIN_MESSAGE）があれば表示
  * なければ固定文言を表示：

    * `確認のうえ、現在は閲覧できる状態に戻しました。`

---

## 3) Publicの見え方（FIX）

* 復旧後は通常の公開範囲（公開/限定/非公開）に従う
* Public側では理由は一切表示しない（既FIX）

---

## 4) 監査（FIX）

* 復旧操作は audit_logs に必ず記録
* ticket_events に `INTERNAL_NOTE`（復旧理由）を必ず残す（ユーザーには非表示）

---

## ✅FIX：ユーザー側チケット一覧（Manage）表示仕様

目的：ユーザーが自分の問い合わせ/異議申立の状況を追えるようにする（見せすぎない）。

---

## 1) 一覧の入口（FIX）

* Manageのメニューに `お知らせ`（通知）とは別に `サポート` を置く
* `サポート` に入ると `チケット一覧` を表示

---

## 2) 表示対象（FIX）

* ユーザー本人が関係するチケットのみ表示する

  * 自分が通報した `report`
  * 自分のコンテンツ/アカウントに関するチケット（運営起票含む）
* 他人の通報・他人のチケットは見えない

---

## 3) 一覧の並び順（FIX）

* `updated_at`（JST）降順（最新更新が上）

---

## 4) 一覧の表示項目（FIX）

* 状態（受付/確認中/追加情報が必要/対応しました）
* 対象種別（アカウント / 作品 / コレクション）
* 更新日時
* タイトルは固定（自由タイトルは持たない）：

  * `アカウントに関するお知らせ`
  * `作品に関するお知らせ`
  * `コレクションに関するお知らせ`

---

## 5) ページング（FIX）

* 無限スクロール
* 1回の取得：20件
* カーソルページング（`updated_at + ticket_id`）

---

## 6) 検索（FIX）

* 検索は提供しない（初期FIX）

---

## 7) 詳細画面（FIX）

* タップでチケット詳細へ
* 詳細の表示内容は既FIX（ADMIN_MESSAGE/USER_MESSAGEのみ、内部情報は見せない）
* `NEED_USER` のときのみ返信フォームを表示（既FIX）

---

あるようにできるし、**設計として入れた方が運用が楽**。ただし Public 側は 404 統一だから、チケット内リンクは **Manage/Admin の“認証付きビュー”**に限定するのが安全。

## ✅FIX：チケット内「対象を見る」URL（Manage/Admin）

### 1) 基本方針（FIX）

* チケットには必ず **対象リソース参照（work / collection / user）** を持つ
* UIでは「対象を見る」ボタンを出す
* リンク先は **Public URLではなく、Manage/Admin の認証必須ページ**にする

  * Public 404統一・限定閲覧方針を崩さないため

---

## 2) Admin 側（運営用）リンク（FIX）

* `対象を見る` →

  * 作品：`admin.vistia.studio/works/{workId}`
  * コレクション：`admin.vistia.studio/collections/{collectionId}`
  * ユーザー：`admin.vistia.studio/users/{userId}`
* Adminは対象が hide/delete/限定 でも **閲覧できる（運営権限）**

  * originalは絶対出さない（display/thumbのみ）

---

## 3) Manage 側（ユーザー用）リンク（FIX）

ユーザーが見れるのは「自分のもの」だけ：

* `対象を見る` →

  * 作品：`manage.vistia.studio/works/{workId}`
  * コレクション：`manage.vistia.studio/collections/{collectionId}`
* もし運営が非公開/削除していてユーザーに見せたくない場合でも

  * **チケット詳細からは対象サムネだけ**表示してOK（既FIXの範囲）
  * フル表示は 404 でもいい（理由は出さない）

---

## 4) チケットデータの持ち方（FIX）

* ticket に以下のどれかを必須で持つ（複数可）

  * `work_id`
  * `collection_id`
  * `user_id`
* ticket_events の `EVIDENCE_ATTACHED` にも同じ参照を積む（既FIXの抜け防止）

---

## 5) 例外（FIX）

* report で対象が外部URL（例：SNS投稿）しか無い場合は

  * ticketに `external_url` を持たせて表示してよい（httpsのみ）
  * ただしクリックは新規タブ、`noopener,noreferrer`

---

## ✅FIX：チケット内「対象を見る」リンクの閲覧範囲（運営非公開中の扱い）

結論：**ユーザー（Manage）には運営非公開中の中身は見せない**。運営（Admin）は見れる。

---

## 1) Admin（運営）側（FIX）

* チケットの `対象を見る` からは常に閲覧可能

  * 作品/コレクション/ユーザーを **管理画面でフル閲覧**
* ただし **originalは絶対に表示しない**（display/thumbのみ）※既FIX

---

## 2) Manage（ユーザー）側（FIX）

### 2.1 対象が「通常状態」の場合

* `対象を見る` で通常どおり表示

  * 作品：画像（display）
  * コレクション：一覧＋モーダル（display）

### 2.2 対象が「運営非公開（hide）」の場合

* `対象を見る` では **中身は表示しない**
* 代替表示（固定）：

  * `このコンテンツは現在表示できません。`
* チケット詳細にはサムネ（thumb）だけ表示してよい（既FIXの範囲）

### 2.3 対象が「運営削除（delete）」または「ユーザー削除」済み

* `対象を見る` は **404**（理由非表示の方針に寄せる）
* チケット詳細には何も出さない（または「削除済み」も出さない）

---

## 3) 限定（UNLISTED/限定）との関係（FIX）

* ユーザー本人のManage閲覧は、限定/公開/非公開に関わらず見れる（自分の作品として）
* ただし **運営非公開（hide）だけは例外で見せない**（上記2.2）

---

## 4) 実装用の判定（FIX）

Manage側で `対象を見る` を表示する条件：

* `owner_user_id == session_user_id` のときのみ表示
* それ以外は表示しない（自分以外のチケット対象を踏ませない）

---

了解。**運営非公開（hide）でも、本人（Manage）からは中身を見れる**ようにFIXし直す。目的は「どれが非公開になったか分からない」を解消するため。

---

## ✅更新FIX：運営非公開（hide）中の「対象を見る」（Manage側）

### 1) 基本方針（FIX）

* **Public**：これまで通り **404**（理由非表示）
* **Admin**：これまで通り **フル閲覧可**
* **Manage（本人）**：運営非公開（hide）でも **閲覧可**（ただし制限つき）

---

## 2) Manage（本人）での表示（FIX）

### 2.1 作品が運営非公開（hide）の場合（FIX）

* `対象を見る` で **画像（display）を表示する**
* 画面上部に固定バナー（必須）：

  * `この作品は運営により非公開になっています（公開範囲を変更しても公開されません）`
* 制限（必須）

  * **共有ボタンを出さない**
  * **限定リンクの発行/再発行/解除のUIを出さない**（誤共有防止）
  * **visibility変更UIを無効化**（hide中は編集不可の既FIX維持）

### 2.2 コレクションが運営非公開（hide）の場合（FIX）

* `対象を見る` で **コレクション一覧（thumb）＋モーダル（display）まで表示してOK**
* 画面上部バナー（必須）：

  * `このコレクションは運営により非公開になっています`
* 制限（必須）

  * 追加/削除/並び替え/公開範囲変更は不可（既FIX維持）
  * 共有系UIは出さない（同上）

---

## 3) 「どれが非公開か分かる」ための表示（FIX）

Manageの一覧でも必ず分かるようにする：

* 作品カードにステータスバッジ：`運営非公開`
* コレクション一覧にもバッジ：`運営非公開`
* フィルタ（任意だけど初期から入れてOK）：`運営非公開のみ`

---

## 4) チケット内リンクの挙動（FIX）

* チケット詳細の `対象を見る` は、対象が hide でも **本人なら遷移できて閲覧できる**
* 本人以外は表示しない（既FIXの `owner_user_id == session_user_id`）

---

## ✅FIX：運営非公開（hide）中は「限定リンク関連UI」を完全に無効化

目的：hide中に共有リンクを作って拡散される事故を防ぐ。
前提：本人（Manage）からは中身閲覧はできる（直前FIX）。

---

## 1) 対象（FIX）

* 作品（Work）
* コレクション（Collection）

---

## 2) hide中に禁止する操作（FIX）

hide中は以下を **すべて禁止**（UIも出さない）：

* 公開範囲（公開/限定/非公開）の変更
* 限定リンクの発行
* 限定リンクの再発行
* 限定リンクの解除
* 限定リンク一覧への導線（リンク自体を見せない）

---

## 3) hide中に許可すること（FIX）

* 本人は `対象を見る` で中身の閲覧のみ可能
* 削除（ユーザー自身の論理削除）は可（既FIX）

  * ただし削除後は通常の削除フロー（30日後パージ等）へ

---

## 4) UI表示（FIX）

* hide中の対象ページ上部に固定バナー（必須）

  * `このコンテンツは運営により非公開になっています`
  * `限定リンクや公開範囲の変更はできません`

---

## 5) サーバー側ガード（FIX）

* UIだけでなくAPIでもブロックする

  * hide中に visibility変更や token 操作が来たら **403**
  * 文言は固定：`権限がありません。`

---

## ✅FIX：運営hide と ユーザー削除（論理削除）の優先順位

目的：状態が重なったときに挙動がブレないようにする。

---

## 1) 優先順位（FIX）

表示・操作の優先順位は以下で固定：

1. **運営削除（admin delete）**（復旧不可）
2. **ユーザー削除（論理削除）**（30日後パージ）
3. **運営非公開（hide）**（復旧可）
4. 通常の公開範囲（公開/限定/非公開）

つまり、**ユーザーが削除した時点で hide より強い**。

---

## 2) 組み合わせ時の挙動（FIX）

### 2.1 hide中にユーザーが削除した場合（FIX）

* 状態は「ユーザー削除」が勝つ
* Manage：

  * 対象は一覧から消える（削除済み扱い）
* Public：

  * 404（既FIX）
* token：

  * 即時解除（revoked）※既FIXの削除フローに従う
* collection_items：

  * 即時削除（既FIX）

### 2.2 ユーザー削除済みの対象を運営がhide解除しても（FIX）

* 何も起きない（ユーザー削除が優先）
* 復旧（restore）対象にならない

### 2.3 運営deleteが入った場合（FIX）

* 常に最優先で復旧不可
* 以降の状態は参照しない

---

## 3) 監査・チケット（FIX）

* hide中にユーザー削除が行われた場合

  * 該当チケットに `INTERNAL_NOTE` を積む（例：ユーザーが削除したため復旧不可になった）
  * audit_logsにも記録

---

## ✅FIX：30日後パージの実行タイミング（JST）

前提（既FIX）：時間基準はJST（Asia/Tokyo）。作品は論理削除→30日後パージ。コレクションも30日後DB削除。ユーザー退会も30日後パージ。

---

## 1) 実行スケジュール（FIX）

* パージジョブは **毎日 04:00（JST）** に実行する

  * 理由：深夜帯で負荷が低い想定、日次運用として分かりやすい

---

## 2) 対象の判定（FIX）

* 作品：

  * `deleted_at <= (now_jst - 30 days)` を満たすものを対象
* コレクション：

  * `deleted_at <= (now_jst - 30 days)` を満たすものを対象
* 退会ユーザー：

  * `deleted_at <= (now_jst - 30 days)` を満たすものを対象（取り消し不可期限超過）

---

## 3) 処理順（FIX）

* ユーザー退会パージが最優先（関連オブジェクトが多いため）
* 次に作品
* 最後にコレクション（紐付けだけなので軽い）

---

## 4) 失敗時（FIX）

* 途中失敗しても翌日以降に再実行で回復できる（冪等）
* 失敗した対象は audit_logs に記録
* 重大失敗（連続3日失敗など）は `manual` チケット起票して運営対応

---

次は、パージが毎日走るなら、**「パージ対象の一覧をAdminで見れるか」**（削除予定・残り日数）をFIXすると運用が楽になる。

了解。方針を更新してFIXする：**チケットは運用（コンテンツ/ユーザー対応）のみ**。パージ等の**インフラ系は通知（チケット化）しない**。

## ✅更新FIX：パージ監視（インフラ通知なし・チケット化しない）

### 1) 方針（FIX）

* パージジョブの成否は **audit_logs に記録するだけ**
* **manualチケットは起票しない**
* ユーザー通知もしない（当然）

### 2) 記録（FIX）

* `PURGE_JOB_RUN`（成功/失敗、件数、開始/終了、ジョブID）
* `PURGE_ITEM_FAILED`（対象ID、失敗理由コード、再試行回数）

### 3) 運用（FIX）

* 失敗検知は **AWS側の監視（CloudWatch等）** で行う（アプリ仕様では扱わない）
* Vistia（アプリ）の責務は「ログを残す」まで

---

## ✅FIX：画像処理（display/thumb生成）の失敗扱い（アプリ内通知なし）

前提（既FIX）

* original(private) → SQS → Lambda(Sharp)で display/thumb生成
* リトライ5回
* 失敗時：再生成ボタン
* Rekognitionは display生成成功後に1回だけ（thumb再生成では実行しない）
* インフラ通知・チケット化はしない（直前FIX）

---

## 1) 作品の画像処理ステータス（FIX）

Workごとに画像処理状態を持つ：

* `UPLOADED`：originalアップロード完了（未処理）
* `PROCESSING`：生成中
* `READY`：display/thumb生成完了（表示可能）
* `FAILED`：生成失敗（再生成待ち）

---

## 2) リトライ（FIX）

* 自動リトライ：最大5回
* 5回失敗したら `FAILED` にする
* `FAILED` のままでも Workレコード自体は残す（削除はユーザー操作）

---

## 3) Public/Manageでの見え方（FIX）

### 3.1 Manage（本人）

* `PROCESSING`：

  * サムネ枠にローディング表示
  * 文言：`処理中です`
* `FAILED`：

  * サムネ枠にエラー表示
  * 文言：`処理に失敗しました`
  * ボタン：`再生成する`

### 3.2 Public

* `READY` のみ表示対象にする
* `UPLOADED/PROCESSING/FAILED` は **存在しない扱い（404/一覧非表示）**

  * 理由：中途半端な表示を避ける

---

## 4) 再生成ボタン（FIX）

* `FAILED` のときのみ表示
* 押下で以下を実行：

  * 状態を `PROCESSING` に戻す
  * 再生成ジョブをSQSへ投入
* 再生成は **thumbだけ** ではなく、原則 **display+thumb両方再生成**（初期FIX）

  * 例外：フォーカス点変更は thumbのみ再生成（既FIX）

---

## 5) フォーカス点変更（thumb再生成）（FIX再掲）

* 入力は display を使う
* thumb再生成は

  * `READY` のときだけ可能
  * 実行しても Rekognition は走らない（既FIX）

---

## ✅FIX：Manageの作品一覧における画像処理中/失敗の並び（新着順維持）

前提（既FIX）：Publicギャラリーは新着順のみ。作品はタイトルなし。Manage検索はタグ完全一致AND。

---

## 1) 並び順の基準（FIX）

* Manageの作品一覧の基本並び順は **作成日時（created_at）降順＝新着順**
* 画像処理ステータス（UPLOADED/PROCESSING/FAILED/READY）で並び替えは **しない**

---

## 2) 表示対象（FIX）

* Manage一覧には **全ステータスを表示**する

  * `UPLOADED / PROCESSING / READY / FAILED`
* 目的：「どれが失敗/処理中か」も新着の流れで追えるようにする

---

## 3) 見た目（FIX）

* カード左上にステータスバッジを必ず出す

  * `処理中`（PROCESSING）
  * `失敗`（FAILED）
  * `準備中`（UPLOADED）
  * READYはバッジなし（初期FIX）

---

## 4) 操作（FIX）

* `FAILED` のカードにだけ `再生成する` を表示（既FIX）
* `UPLOADED/PROCESSING` は操作なし（待つだけ）
* `READY` は通常操作（フォーカス点変更など）

---

## ✅FIX：Publicギャラリーの新着順の基準（READY時刻で並べる）

目的：処理中/失敗の作品がPublicに出ないことで「穴あき」「順番が変」に見えるのを防ぐ。

---

## 1) Publicの並び順キー（FIX）

* Publicギャラリーの新着順は **`published_at` 降順**で並べる
* `published_at` は **READYになった瞬間**にセットする（JST）

---

## 2) published_at の定義（FIX）

* 初回 display/thumb 生成が成功して `READY` になった時刻を `published_at` とする
* その後に

  * thumbフォーカス再生成
  * 再生成（FAILED→READY復帰）
    をしても **published_at は更新しない**
  * 理由：順番が入れ替わると閲覧体験が崩れる

---

## 3) Manage側の並び順（FIX）

* Manageは引き続き `created_at` 降順（新着順）で表示（既FIX）
* PublicとManageで並びの基準が違ってOK（用途が違う）

---

## 4) 既存データ移行（FIX）

* `published_at` が無い既存作品は

  * `READY` のものだけ `published_at = created_at` とみなす（初期移行ルール）

---

## ✅FIX：ピン（Proのみ）とPublic新着順の優先順位（別ブロック）

前提（既FIX）

* Pro：ピン3つ（PUBLIC作品のみ）
* ピンはモーダル表示なし、横スワイプで閲覧
* Publicギャラリーは新着順のみ（published_at降順）

---

## 1) 表示構造（FIX）

Publicプロフィール（@handle）では、ギャラリーの上に **ピン専用ブロック**を置く：

1. プロフィール基本情報（既FIX）
2. **ピン（Proのみ）ブロック**
3. 「ギャラリーを見る」ボタン → `/@handle/gallery`

---

## 2) 優先順位（FIX）

* ピンは **新着順とは別の固定枠**
* ギャラリー（/gallery）は **新着順のみ**（published_at降順）

  * ピン作品であってもギャラリー内では普通に新着順に混ざる（並び替えしない）

---

## 3) ピンの表示ルール（FIX）

* ピンはPUBLIC作品のみ（既FIX）
* ピンが0件ならブロック自体を出さない
* 最大3つを横スワイプで表示（既FIX）

---

## ✅FIX：`/@handle/gallery` ではピンを表示しない

目的：ギャラリーは「新着順だけ」のルールを守って、UIを単純にする。

---

## 1) ルール（FIX）

* ピンは **プロフィールトップ（/@handle）だけ**に表示する
* `@handle/gallery` では **ピンを表示しない**
* `@handle/gallery` は **新着順のみ（published_at desc）**に統一

---

## 2) 理由（FIX）

* ギャラリーは無限スクロール＆新着順固定（既FIX）なので、ピンを混ぜない方が一貫する
* ピンは「名刺枠」としてトップに集約する

---

## ✅FIX：ピンのタップ挙動（モーダル無しのまま閲覧専用）

前提（既FIX）：ピンはモーダル表示なし、横スワイプで閲覧。

---

## 1) タップ時の挙動（FIX）

* ピン画像は **タップしても何もしない**

  * 遷移しない
  * 拡大しない
  * モーダルを出さない
* 操作は **横スワイプのみ**で次/前を見る

---

## 2) 表示UI（FIX）

* ピンブロックには小さく説明文を出してよい（任意）

  * `ピン（Pro）`

---

## 3) 保存抑止（FIX）

* ピンも他画像と同じく保存抑止（右クリック/長押し/ドラッグ抑止）を適用

---

## ✅FIX：ギャラリー詳細モーダルの操作UI（閉じる＋スワイプ）

前提（既FIX）

* 作品詳細：モーダル
* スワイプで次/前
* ルール表記なし
* 保存抑止は全面

---

## 1) 閉じる手段（FIX）

モーダルは必ず複数の閉じ方を提供する：

* 右上に `×` ボタン（必須）
* 背景タップで閉じる（必須）
* スマホ：下スワイプで閉じる（必須）
* PC：`Esc` キーで閉じる（必須）

---

## 2) 次/前の操作（FIX）

* スマホ：左右スワイプで次/前
* PC：

  * 画像左右クリック領域で次/前（任意）
  * キーボード `← / →` で次/前（必須）

---

## 3) UI表示（FIX）

* ページインジケータ（例：`3 / 50`）は **表示しない**（ルール表記なし方針に合わせる）
* キャプション/タイトル：なし（既FIX）
* タグ：表示しない（既FIX）

---

## 4) 読み込み（FIX）

* 次/前は先読みして体験を滑らかにしてよい（設計側）

---

## ✅FIX：モーダルを開ける条件（Public / 限定リンク / Manage / Admin）

前提（既FIX）

* Publicは理由非表示（404統一）
* 限定リンクは閉じた閲覧
* Manage（本人）は運営hide中でも閲覧可（ただし編集不可・限定リンクUI不可）
* Adminは運営権限で閲覧可

---

## 1) Public（通常公開ページ）でのモーダル（FIX）

### 開ける対象（FIX）

* **PUBLICの作品のみ**
* 条件：

  * 作品が `READY`
  * ユーザーが停止/退会していない
  * 作品が削除/運営deleteでない
  * 運営hideでない

### 開けない場合（FIX）

* 上記を満たさない作品は一覧にも出さない（=存在しない扱い）

---

## 2) 限定リンクページでのモーダル（FIX）

### 作品の限定リンク（FIX）

* 単体表示のみ：モーダル概念なし（既FIXの“閉じた閲覧”を優先）

### コレクションの限定リンク（FIX）

* コレクション内の作品タップ → モーダル表示は **OK**
* ただし導線は閉じる（ギャラリー/他コレクションへは行けない）

---

## 3) Manage（本人）でのモーダル（FIX）

* 自分の作品は visibilityに関係なくモーダル表示OK

  * PUBLIC / 限定 / 非公開
* 運営hide中でも表示OK（直前FIX）
* `UPLOADED/PROCESSING/FAILED` はモーダル不可（画像がないため）

---

## 4) Admin（運営）でのモーダル（FIX）

* すべての状態で閲覧OK（監視・審査のため）
* ただし originalは出さない（display/thumbのみ）※既FIX

---

## ✅FIX：Publicの404ページ文言（固定）

前提（既FIX）：公開側は理由非表示（404等）。内部状態（停止/削除/非公開/限定解除など）を推測させない。

---

## 1) 404の文言（FIX）

Public（vistia.studio）で 404 のときは常にこの固定文言：

* タイトル：`見つかりません`
* 本文：`ページが見つかりませんでした。`
* 補助：`URLをご確認ください。`

---

## 2) 出さない情報（FIX）

* 理由（削除/停止/非公開/限定解除など）は一切出さない
* 検索導線・おすすめ導線も出さない（初期FIX）

---

## 3) ボタン（FIX）

* `トップへ戻る` のみ表示（`vistia.studio/`）
* それ以外の導線（ギャラリー検索等）は出さない

---

## ✅FIX：YouTube未設定時のPublic表示（枠は出さない）

前提（既FIX）：YouTubeは任意・1つだけ、埋め込み再生。

---

## 1) 未設定時（FIX）

* YouTubeが未設定なら **セクション自体を表示しない**

  * 空枠・プレースホルダ・「設定してね」等も出さない（Publicはシンプル優先）

---

## 2) 設定済み時（FIX）

* 1つだけ埋め込み表示
* 表示位置は既FIXのプロフィール順に従う（ピンの後、ギャラリーボタンの前）

---

## ✅FIX：YouTubeの許可URL形式（1つだけ埋め込み）

目的：入力がバラけて埋め込みが壊れるのを防ぐ。

---

## 1) 設定できるのは「動画」だけ（FIX）

* 許可するのは **YouTubeの動画URLのみ**

  * 通常動画でも、ライブアーカイブでもOK（=動画として扱う）
* チャンネルURL・プレイリストURLは **不可**

---

## 2) 許可するURL形式（FIX）

以下のいずれかのみOK（https必須）：

* `https://www.youtube.com/watch?v=VIDEO_ID`
* `https://youtu.be/VIDEO_ID`

※ `VIDEO_ID` が取れないURLは弾く

---

## 3) 正規化（FIX）

* 入力されたURLから `VIDEO_ID` を抽出して保存する（URL丸ごと保存しない）
* 埋め込みは必ず

  * `https://www.youtube.com/embed/VIDEO_ID`
    を使う

---

## 4) UI入力（FIX）

* ラベル：`YouTube（動画URL）`
* エラー文言（固定）：`URLが正しくありません。`

---

## ✅FIX：Links の禁止URLルール（危険スキーム / ローカル / IP直指定）

目的：フィッシングやローカルアクセス誘導、危険スキームを最小限で潰す（過剰なドメイン規制はしない）。

---

## 1) 許可スキーム（FIX）

* **許可：`https://` のみ**
* **禁止：それ以外すべて**

  * `http://`
  * `javascript:`
  * `data:`
  * `file:`
  * `mailto:`
  * `tel:`
  * `intent:` など

---

## 2) 禁止ホスト（FIX）

次に該当するURLはすべて禁止：

* `localhost`
* ループバック：`127.0.0.0/8`
* プライベートIP：

  * `10.0.0.0/8`
  * `172.16.0.0/12`
  * `192.168.0.0/16`
* リンクローカル：

  * `169.254.0.0/16`
* IPv6のローカル/プライベート相当（`::1`、`fc00::/7`、`fe80::/10` など）
* **IPアドレス直指定のURLは全て禁止**（公開IPでも禁止）

  * 理由：見た目で判別しにくく悪用されやすいので、初期は全面禁止で運用を軽くする

---

## 3) URL形式の禁止（FIX）

* URLに **ユーザー情報（userinfo）** が含まれるものは禁止
  例：`https://user:pass@example.com/...`
* URL全体の長さ：**最大 2048 文字**
* 制御文字・改行を含むものは禁止

---

## 4) エラー文言（FIX）

* 入力NG時は一律：`URLが正しくありません。`

---

## ✅FIX：Links の作成/更新レート制限（無制限だけど連投は止める）

前提（既FIX）

* Links：数は無制限
* ラベル自由、説明文あり
* インフラ通知やチケット化は不要（運用系のみ）

---

## 1) レート制限（FIX）

Linksの「作成・更新・削除」の合計で制限する：

* **ユーザーID単位：1分あたり 30回まで**
* **ユーザーID単位：1時間あたり 300回まで**

※ “無制限” は総数の話。短時間連投だけ止める。

---

## 2) 超過時（FIX）

* HTTP 429
* 固定文言：`現在アクセスを制限しています。時間をおいてお試しください。`

---

## 3) 監査（FIX）

* Linksの変更は audit_logs には入れない（重大操作ではない）
* ただし `updated_at` は更新される（当たり前）

---

## ✅FIX：Links の並び順（手動並び替え可能）

前提（既FIX）

* Public表示：6件＋「もっと見る」
* Linksは無制限、ラベル自由、説明文あり

---

## 1) 並び順の基本（FIX）

* Linksは **ユーザーが手動で並び替えできる**
* 保存する順序は `position`（整数）で保持する

---

## 2) 追加時の挙動（FIX）

* 新規追加したLinkは **末尾に追加**（position最大+1）
* 既存の順序は変えない

---

## 3) 並び替えUI（FIX）

* Manageでドラッグ&ドロップ（モバイルでも可）
* 並び替え確定は即時保存（明示的な保存ボタンは不要）

---

## 4) Public表示（FIX）

* Publicプロフィールでは `position` 昇順で表示
* 先頭から6件を表示し、それ以降は「もっと見る」に入る（既FIX）

---

## ✅FIX：Links の文字数上限（label / description / url）

目的：見た目崩れ・DB肥大化・悪用を防ぐ。必要最小限で固定。

---

## 1) 上限（FIX）

* `label`：**1〜30文字**
* `description`：**0〜120文字**
* `url`：**1〜2048文字**（既FIX）

※ 文字数はUnicode基準（日本語1文字=1扱い）

---

## 2) 入力ルール（FIX）

* `label`：前後トリム、空は不可
* `description`：前後トリム、空は可
* 改行：

  * `label`：不可（含まれてたら弾く）
  * `description`：不可（1行に固定。含まれてたら弾く）
* 絵文字：可

---

## 3) エラー文言（FIX）

* すべて固定：`入力が正しくありません。`

---

## ✅FIX：Links「もっと見る」ページ仕様（別ページ＋無限スクロール）

前提（既FIX）

* Publicプロフィール：Linksは6件表示＋「もっと見る」

---

## 1) 遷移先（FIX）

* 「もっと見る」押下で別ページへ遷移：

  * `/@handle/links`

---

## 2) 表示（FIX）

* `position` 昇順で表示
* 表示要素：

  * label（必須）
  * description（任意）
* URLは表示しない（既FIX）
* クリックで新規タブ（`noopener,noreferrer`）

---

## 3) 取得方式（FIX）

* 無限スクロール
* 1回の取得：20件
* カーソルページング（`position` + `link_id`）

---

## 4) 例外（FIX）

* Linksが0件ならセクション自体を出さない（プロフィール側と同じ）

---

## ✅FIX：`/@handle/links` のOGP（プロフィールと同一）

目的：共有時の見た目を揃える。個別LinkのOGP制御はしない。

---

## 1) OGP方針（FIX）

* `@handle/links` のOGPは **プロフィール（/@handle）と同じ**にする
* OGP画像は **ユーザーアイコン（avatar）のみ**

---

## 2) OGPに含める情報（FIX）

* `display_name`
* `handle`
* site_name：`Vistia`
* ページ種別：`Links`

---

## 3) 非表示・無効時（FIX）

* ユーザー停止/退会/存在しない：404（既FIXのPublic方針）
* 理由は出さない

---

了解。bioは改行ありに更新してFIXする。

## ✅更新FIX：bio は改行あり

### 1) 上限（FIX）

* `bio`：**0〜160文字**（変更なし）
* 改行：**最大3行まで**

### 2) 入力ルール（FIX）

* 前後トリム
* 連続空白は1つ（ただし改行は保持）
* 連続改行は禁止（空行は作れない）
* 1行の最大文字数：**80文字**
* URL：入っててもOK（リンク化しない）

### 3) 表示（FIX）

* Public/Manageともに改行をそのまま表示（折り返しはUI任せ）

## ✅FIX：handle ルール（文字種/長さ/変更/予約語）

目的：URLの核なので厳密に固定する。

---

## 1) 形式（FIX）

* handle は `@` なしで保存する（表示時だけ `@handle`）
* 許可文字：**英小文字・数字・アンダースコア `_`・ドット `.`**

  * 正規表現：`^[a-z0-9_\.]+$`
* 先頭文字：英小文字 or 数字（`_` や `.` 始まりは禁止）
* 末尾文字：英小文字 or 数字（`_` や `.` 終わりは禁止）
* 連続禁止：

  * `..`（ドット連続）禁止
  * `__`（アンダースコア連続）禁止
  * `._` / `_.` の連続は禁止（見た目が荒れるため）

---

## 2) 長さ（FIX）

* 最小：**3文字**
* 最大：**20文字**

---

## 3) 大文字の扱い（FIX）

* 入力で大文字が来たら **小文字に正規化**して保存する（case-insensitive）
* 重複判定も小文字で行う

---

## 4) 変更ルール（FIX）

* handle の変更は可能（初期から提供）
* 制限：

  * **30日に1回まで**
  * 変更後24時間は再変更不可（クールダウン）

---

## 5) 予約語（禁止）（FIX）

以下は handle として使用不可（代表、必要なら追加していく）：

* `admin`
* `manage`
* `api`
* `img`
* `support`
* `help`
* `terms`
* `privacy`
* `guidelines`
* `login`
* `logout`
* `signup`
* `settings`
* `gallery`
* `collections`
* `works`

---

## 6) エラー文言（FIX）

* 不正形式：`入力が正しくありません。`
* 使用済み：`すでに存在します。`

---

了解。旧handleの扱いを更新してFIXする（「即404」は維持、再利用だけ90日に変更）。

## ✅更新FIX：handle変更後の旧handle（90日で再利用可）

### 1) 旧handleの挙動（FIX）

* handle変更後、旧handleは **リダイレクトしない**
* 旧handleのPublic URLは **即404**（理由非表示）

### 2) 再利用ルール（FIX）

* 旧handleは **90日間は再利用不可**
* 90日経過後は **再利用可能**

  * ただし、再利用は誰でも可能（元の所有者に優先権は付けない）※初期FIX
  * 優先権を付けるかは後回し

### 3) 実装メモ（仕様としてFIX）

* handle変更時に「旧handleの解放予定日（released_at）」を記録する

  * `released_at = changed_at + 90 days`（JST）

## ✅FIX：display_name ルール（文字数/文字種/変更）

目的：見た目の名前。荒らしと表示崩れを防ぎつつ自由度は高め。

---

## 1) 文字数（FIX）

* 最小：**1文字**
* 最大：**30文字**

---

## 2) 許可文字（FIX）

* Unicode可（日本語・絵文字OK）
* ただし以下は不可：

  * 改行（`\n`）
  * タブ等の制御文字
  * 先頭/末尾の空白（トリム）

---

## 3) 正規化（FIX）

* 前後トリム
* 連続空白は1つに圧縮

---

## 4) 変更ルール（FIX）

* display_name はいつでも変更可（回数制限なし）
* ただし連打防止として

  * **1分に3回まで**（レート制限）
  * 超過時は429（固定文言）

---

## ✅FIX：アイコン（avatar）仕様（アップロード/形式/更新）

前提（既FIX）

* originalは配信しない（display/thumbのみ）
* display：長辺1280px WebP、thumb：正方形JPEG
* メタデータ除去、Orientation正規化
* 非同期処理（SQS + Lambda）
* 最大50MB、同時アップロード5枚（作品）※avatarは単体扱い

---

## 1) avatarの基本（FIX）

* ユーザーはアイコンを1つ設定できる
* 未設定でも利用可（デフォルトアイコンを表示）

---

## 2) アップロード制限（FIX）

* ファイルサイズ：最大 **10MB**（作品より軽く）
* 同時アップロード：1枚のみ
* 画像処理は作品と同じパイプライン（original→display/thumb）

---

## 3) 生成仕様（FIX）

* display：長辺 256px WebP（アイコン用途なので小さく固定）
* thumb：正方形 128px JPEG
* original：privateに保存（既FIXのキー規則）

---

## 4) 更新頻度（FIX）

* アイコン変更は回数制限なし
* ただしレート制限：

  * 1時間に10回まで（ユーザーID単位）
  * 超過時429

---

## 5) 削除（FIX）

* ユーザーが「アイコンを削除」できる

  * 削除するとデフォルトアイコンに戻る
* 削除してもoriginalは自動削除しない（既FIXの方針）

  * ユーザーパージ時に削除

---

## ✅FIX：デフォルトアイコンの配信方法（アプリ内アセット）

目的：S3/CloudFrontを無駄に使わず、常に高速・安定に表示する。

---

## 1) 方針（FIX）

* デフォルトアイコンは **S3/CloudFront（img.vistia.studio）では配信しない**
* Public/Manage/Admin 各フロントに **静的アセットとして同梱**する

---

## 2) 表示条件（FIX）

* `users.avatar_asset_id` が無い（未設定/削除）場合はデフォルトアイコンを表示

---

## 3) 画像仕様（FIX）

* 透過PNG（1枚）
* サイズはフロント側で可変（表示コンポーネントに合わせる）

---

## ✅FIX：avatarのURL設計（不変URL＋更新でassetId更新）

前提（既FIX）

* CloudFrontは不変URL前提で長期キャッシュ（immutable）
* 画像キーは `display/avatar/{userId}/{assetId}.webp` / `thumb/avatar/{userId}/{assetId}.jpg`

---

## 1) 方針（FIX）

* avatar画像URLは **assetIdを含む不変URL**
* アイコンを更新するたびに **新しいassetIdを発行**する
* その結果、URLが変わるので古いキャッシュ問題が起きない

---

## 2) DBの持ち方（FIX）

* usersに最新の参照だけ持つ：

  * `users.avatar_asset_id`
* 過去assetは参照を外すだけ（削除はしない）

  * ユーザーパージ時にまとめて削除（既FIX）

---

## 3) 表示で使うURL（FIX）

* Public/Manage/Admin は常に

  * `users.avatar_asset_id` からURLを組み立てる
* asset_idがNULLならデフォルトアイコン（既FIX）

---

## ✅FIX：ギャラリーボタンの文言（固定）

目的：UIをシンプルにして、プロフィールの自由度が過剰に増えるのを防ぐ。

---

## 1) 文言（FIX）

* ボタン文言は固定：`ギャラリーを見る`
* カスタム文言は提供しない

---

## 2) 遷移先（FIX）

* `/@handle/gallery`

---

## ✅FIX：Publicのコレクション一覧ページURL（専用ページを作る）

前提（既FIX）

* ギャラリー上部に「コレクション」ボタン
* `@handle/gallery?c={collectionId}` でコレクション表示もできる

---

## 1) コレクション一覧ページ（FIX）

* Publicにコレクション一覧ページを用意する：

  * `/@handle/collections`

---

## 2) 表示（FIX）

* 表示対象：**PUBLICコレクションのみ**
* 並び順：新着順（`created_at desc`）

---

## 3) クリック時（FIX）

* 一覧からコレクションを選ぶと

  * `/@handle/gallery?c={collectionId}` に遷移
  * ギャラリー側でそのコレクションを表示する（既FIX）

---

## 4) コレクションが0件（FIX）

* コレクションページ自体を出さないのではなく

  * 404ではなく空ページ表示：`コレクションはありません`
  * （プロフィールにボタンが出ないので通常は到達しないが、直打ち対策）

---

## ✅FIX：`/@handle/collections` のOGP（アイコンのみ）

前提（既FIX）

* 限定リンクのOGP画像はアイコンのみ
* PublicのLinksページOGPもアイコンのみ

---

## 1) OGP方針（FIX）

* `@handle/collections` のOGPも **アイコン（avatar）のみ**

---

## 2) OGPに含める情報（FIX）

* `display_name`
* `handle`
* site_name：`Vistia`
* ページ種別：`コレクション`

---

## 3) 404条件（FIX）

* ユーザー停止/退会/存在しない：404（理由非表示）

---

## ✅FIX：Publicコレクション一覧の新着順キー（created_at）

前提：コレクションは「作品みたいにREADY待ち」がない（画像生成の前提がない）。Publicの検索もなし。

---

## 1) 並び順（FIX）

* `@handle/collections` の並び順は **`created_at desc`**（新着順）

---

## 2) visibility変更の影響（FIX）

* PUBLIC→非公開/限定にすると一覧から消える
* 非公開/限定→PUBLICに戻しても **順番は変わらない**

  * created_atは保持、再公開で上に上げない

---

## ✅FIX：`/@handle/gallery?c={collectionId}` の無効時挙動（Publicは404統一）

前提（既FIX）

* Publicは理由非表示（404等）
* コレクションの公開範囲：公開/限定/非公開（本番表記：公開/限定/非公開）
* 限定コレクションは限定リンクからのみ閲覧（閉じた閲覧）

---

## 1) Publicでの表示条件（FIX）

`/@handle/gallery?c={collectionId}` がPublicで成立するのは：

* collection が **PUBLIC**
* 所有ユーザーが有効（停止/退会していない）
* collection が削除されていない/運営deleteでない
* collection が運営hideでない

---

## 2) それ以外（FIX）

上記を満たさない場合はすべて：

* **404**
* 理由は出さない

---

## 3) 限定（UNLISTED/限定）コレクション（FIX）

* Publicの `?c=` では表示できない（404）
* 限定コレクションは **限定リンク経由のみ**（既FIXの閉じた閲覧）

---

## ✅FIX：コレクション表示中（`?c=`）の「ギャラリーに戻る」挙動

目的：導線は最小、でも迷子にしない。

---

## 1) ボタン表示（FIX）

* `?c={collectionId}` が付いている時だけ

  * 上部に `ギャラリーに戻る` ボタンを表示する

---

## 2) 挙動（FIX）

* `ギャラリーに戻る` を押すと

  * `?c=` を外した `@handle/gallery` に遷移する（同一ページ遷移でOK）

---

## 3) スクロール位置（FIX）

* 戻ったときのスクロール位置は保持しない（初期FIX）

  * 理由：実装を簡単にし、変な復帰挙動を避ける

---

## ✅FIX：モーダル開閉とURL（workIdはURLに入れない）

目的：実装と体験をシンプルにし、共有導線を増やさない。

---

## 1) 方針（FIX）

* Publicギャラリーで作品モーダルを開いても **URLは変えない**
* `workId` をクエリやパスに入れない

---

## 2) 理由（FIX）

* 「閉じた導線」方針に合う（個別URLの拡散を増やさない）
* 無限スクロール＋モーダルでURL管理すると状態復元が重くなる

---

## 3) 例外（FIX）

* 限定リンク（作品/コレクション）だけは個別URL（token）がある（既FIX）
* Public通常閲覧では個別作品URLは作らない

---

了解。**共有（Share）と限定（visibility）を切り離してFIX**するね。
（＝共有するために勝手に「限定」に変えない）

---

## ✅更新FIX：共有リンクは visibility と別機能

### 1) 概念（FIX）

* **公開範囲（visibility）**：`公開 / 限定 / 非公開`（表示・一覧に出す/出さないの制御）
* **共有（Share）**：`共有リンク（share token）` を発行してURLをコピーする機能
  → **visibility は変更しない**

---

## 2) 共有リンク（share token）（FIX）

* 作品/コレクション単位で **共有リンクを発行できる**
* 共有リンクは **明示操作でのみ作成**（自動作成しない）
* 共有リンクは **いつでも解除（revoke）できる**

### 上限（FIX）

* **Free：有効な共有リンクは合計3つまで**
* **Pro：無制限**
* カウントは「有効（revokedでない）」のみ（作品＋コレクション合算）

---

## 3) visibility と共有リンクの関係（FIX）

* `公開`：共有リンクがあってもなくてもOK
* `限定`：共有リンクがあってもなくてもOK（＝「一覧に出さない」だけ）
* `非公開`：**共有リンクは自動で全解除（revoked）**（事故防止のため）

> つまり「限定＝共有URL」ではなく、**限定は“一覧に出さない”**、共有は“URLを配る”で分離。

---

## 4) Manageの共有UI（FIX）

* 作品詳細/コレクション詳細に `共有` ボタンを置く
* 押下時：

  * 共有リンクがあれば：URL表示＋コピー＋解除
  * 無ければ：`共有リンクを作成`（上限チェック）→URL表示＋コピー

### hide中（運営非公開）の扱い（FIX再掲）

* hide中は **共有リンクの作成/表示/解除UIを出さない**（APIでも403）

---

## 5) 共有リンクのOGP（FIX）

* 画像は **アイコンのみ**（既FIX）
* Public側の理由は出さない（無効なら404）

---

この更新で、あなたの要望どおり
**「共有したい」＝リンク発行/コピー**、**「限定」＝一覧に出す/出さない** で別物になる。

了解。**共有（Share）と限定（visibility）を切り離してFIX**するね。
（＝共有するために勝手に「限定」に変えない）

---

## ✅更新FIX：共有リンクは visibility と別機能

### 1) 概念（FIX）

* **公開範囲（visibility）**：`公開 / 限定 / 非公開`（表示・一覧に出す/出さないの制御）
* **共有（Share）**：`共有リンク（share token）` を発行してURLをコピーする機能
  → **visibility は変更しない**

---

## 2) 共有リンク（share token）（FIX）

* 作品/コレクション単位で **共有リンクを発行できる**
* 共有リンクは **明示操作でのみ作成**（自動作成しない）
* 共有リンクは **いつでも解除（revoke）できる**

### 上限（FIX）

* **Free：有効な共有リンクは合計3つまで**
* **Pro：無制限**
* カウントは「有効（revokedでない）」のみ（作品＋コレクション合算）

---

## 3) visibility と共有リンクの関係（FIX）

* `公開`：共有リンクがあってもなくてもOK
* `限定`：共有リンクがあってもなくてもOK（＝「一覧に出さない」だけ）
* `非公開`：**共有リンクは自動で全解除（revoked）**（事故防止のため）

> つまり「限定＝共有URL」ではなく、**限定は“一覧に出さない”**、共有は“URLを配る”で分離。

---

## 4) Manageの共有UI（FIX）

* 作品詳細/コレクション詳細に `共有` ボタンを置く
* 押下時：

  * 共有リンクがあれば：URL表示＋コピー＋解除
  * 無ければ：`共有リンクを作成`（上限チェック）→URL表示＋コピー

### hide中（運営非公開）の扱い（FIX再掲）

* hide中は **共有リンクの作成/表示/解除UIを出さない**（APIでも403）

---

## 5) 共有リンクのOGP（FIX）

* 画像は **アイコンのみ**（既FIX）
* Public側の理由は出さない（無効なら404）

---

この更新で、あなたの要望どおり
**「共有したい」＝リンク発行/コピー**、**「限定」＝一覧に出す/出さない** で別物になる。

## ✅FIX：共有リンクURL形式（作品/コレクション共通で `/s/{token}` に統一）

### 1) URL（FIX）

* 共有リンクは種別を分けずに **1本化**

  * `https://vistia.studio/s/{token}`

---

### 2) token の中身（FIX）

* share token はDBで管理し、必ず参照先を持つ：

  * `target_type`：`work` / `collection`
  * `target_id`：UUID
  * `created_by_user_id`
  * `revoked_at`（NULLなら有効）
  * `created_at`（JST）

---

### 3) 解決ルール（FIX）

* `/s/{token}` を開いたら

  * tokenが有効（revokedでない）かつ対象が存在する場合のみ表示
  * 無効/存在しない/ユーザー停止・退会/削除/運営delete などは **404（理由非表示）**

---

### 4) visibility との関係（FIX再確認）

* visibility を **非公開** にしたら、その対象の共有リンクは **全解除（revoked）**
* 限定（一覧に出さない）は共有リンクと独立（共有リンクはあってもなくてもよい）
* 運営hide中は共有リンクの作成/表示/解除を不可（UI非表示＋API 403）

---

## ✅FIX：共有リンクページ（`/s/{token}`）は「閉じた閲覧」（導線を出さない）

前提（既FIX）：UNLISTED（限定）は閉じた閲覧。共有リンクも同様に拡散導線を増やさない。

---

## 1) 閉じた閲覧（FIX）

`/s/{token}` では以下の導線を **出さない**：

* プロフィールへ（/@handle）リンク
* ギャラリーへ（/@handle/gallery）リンク
* コレクション一覧へリンク
* 検索・おすすめ導線

---

## 2) 表示してよい情報（FIX）

* ユーザー名/アイコン：表示してOK（既FIX方針に合わせる）
* 対象コンテンツ

  * work：画像（display）
  * collection：コレクション内の一覧＋モーダル（display）

---

## 3) UI（FIX）

* ページ上部に小さく `Vistia` ロゴ（押してもトップへは飛ばさない＝非リンク）
* 戻る導線はブラウザ任せ（閉じた閲覧のため）

---

## ✅FIX：共有リンクページ（`/s/{token}`）の広告扱い

前提（既FIX）

* Free：広告あり / Pro：広告なし
* 追従固定バナー、モーダル中も表示
* UNLISTEDの広告：通常公開と同じ扱い

---

## 1) 適用（FIX）

* 共有リンクページ（`/s/{token}`）も **通常公開と同じ広告ルール**を適用する

---

## 2) 判定（FIX）

* 共有リンク先の所有者が

  * Free → 広告あり
  * Pro → 広告なし

---

## ✅FIX：共有リンク（`/s/{token}`）のOGP（アイコン＋固定テキスト）

前提（既FIX）

* OGP画像はアイコンのみ（限定リンクも同様）
* 理由は出さない（無効なら404）

---

## 1) OGP画像（FIX）

* `og:image`：ユーザーのアイコン（avatar display）

---

## 2) OGPタイトル（FIX）

* `og:title`：`{display_name} (@{handle})`

---

## 3) OGP説明（FIX）

* `og:description`：固定文言
  `Vistiaで作品を閲覧できます。`

※ 対象が作品/コレクションどちらでも同じ（閉じた閲覧で情報を増やさない）

---

## ✅FIX：token種類（限定/共有）と失効条件（DBレベル）

前提（既FIX）

* 限定（UNLISTED/本番表記：限定）：作品/コレクション単位で限定URL token 自動発行、戻したらrevoked
* 共有リンク：`/s/{token}`、明示操作で作成、Freeも無制限
* tokenはDBに保存、無効化は `revoked_at` で管理

---

# 1) tokenの種類（FIX）

tokenは2種類に分ける：

* **限定トークン（unlisted_token）**
* **共有トークン（share_token）**

---

# 2) テーブル（FIX）

## 2.1 unlisted_tokens（FIX）

* `id`（UUID）
* `token_hash`（sha256）
* `target_type`：`work` / `collection`
* `target_id`：UUID
* `created_at`（JST）
* `revoked_at`（JST, nullable）
* unique：

  * `target_type + target_id` で **同時に有効なのは1つ**（最新のみ有効）

## 2.2 share_tokens（FIX）

* `id`（UUID）
* `token_hash`（sha256）
* `target_type`：`work` / `collection`
* `target_id`：UUID
* `created_by_user_id`（UUID）
* `created_at`（JST）
* `revoked_at`（JST, nullable）
* unique：

  * `token_hash` unique
* 制限：

  * 同一targetに複数share_token作成は **許可（無制限）**

---

# 3) 失効（revoked）条件（FIX）

## 3.1 unlisted_token（限定）

* 限定 → 公開/非公開 に戻したら **即 revoked**
* 対象を削除（ユーザー削除/運営削除）したら **即 revoked**
* ユーザー退会/停止：

  * 退会：即 revoked
  * 停止：即 revoked（Public 404方針と整合）

## 3.2 share_token（共有）

* ユーザーが解除したら revoked
* 対象を削除（ユーザー削除/運営削除）したら revoked
* **visibility が非公開になったら全 revoked**（事故防止・既FIX）
* ユーザー退会/停止：

  * 退会：即 revoked
  * 停止：即 revoked（Public 404方針と整合）

※ visibility が「限定」になっても share_token は維持（分離機能のため）

---

# 4) 表示/解決（FIX）

* tokenは平文保存しない（hashのみ）
* token入力（URLアクセス）時は

  * tokenをsha256してDB照合
* 無効はすべて404（理由非表示）

---

## ✅FIX：共有リンク一覧UI（Manage）

目的：共有リンクが無制限でも、本人が「管理（コピー/解除）」できるようにする。

---

## 1) 入口（FIX）

Manageの各詳細に `共有リンク` セクションを置く：

* 作品詳細：`共有リンク`
* コレクション詳細：`共有リンク`

※ 全体一覧（プロフィール設定など）には作らない（初期FIX：増えすぎる）

---

## 2) 表示内容（FIX）

`share_tokens` を `created_at desc` で表示：

* 作成日時（JST）
* 状態：`有効` / `解除済み`
* ボタン：

  * 有効：`コピー` / `解除`
  * 解除済み：操作なし（URLは表示しない）

---

## 3) 作成（FIX）

* `共有リンクを作成` ボタン
* 押下で新しいshare_tokenを発行し、一覧の先頭に追加
* 自動作成はしない（既FIX）

---

## 4) 解除（FIX）

* `解除` 押下で確認モーダル（入力確認は不要、二段階でOK）

  * 文言：`この共有リンクを無効にします。よろしいですか？`
* 解除後は即404になる（Public側）

---

## 5) hide中の扱い（FIX再掲）

* 運営hide中は共有リンクセクション自体を表示しない
* APIも403（既FIX）

---

## ✅FIX：共有リンクにメモ（ラベル）を付けられるようにする

目的：「どれを誰に渡したか」を本人が管理できるようにする（共有リンク無制限と相性がいい）。

---

## 1) 追加フィールド（FIX）

`share_tokens` に以下を追加：

* `label`（任意）

  * 0〜30文字
  * 改行不可
  * 前後トリム、連続空白1つ

---

## 2) UI（FIX）

* 共有リンク一覧の各行に

  * `label` を表示（未入力なら `（メモなし）`）
* 操作：

  * `メモ編集`（インライン編集でOK）
  * `コピー`
  * `解除`

---

## 3) 監査（FIX）

* share_tokenの作成/解除/ラベル変更は audit_logs には入れない（重大操作ではない）

---

## ✅FIX：限定リンク（unlisted）のURL形式（作品/コレクション共通で `/u/{token}`）

前提（既FIX）

* 限定（UNLISTED/本番表記：限定）は作品/コレクション単位でtoken
* 共有リンクは `/s/{token}`（FIX済み）
* 限定リンクは閉じた閲覧

---

## 1) URL（FIX）

* 限定リンクは種別を分けずに **1本化**

  * `https://vistia.studio/u/{token}`

---

## 2) 解決（FIX）

* `/u/{token}` → unlisted_tokens を参照して

  * target_type（work/collection）に応じて表示を分岐
* 無効/存在しない/停止/退会/削除/運営delete/運営hide などは **404（理由非表示）**

---

## 3) 閉じた閲覧（FIX）

* `/u/{token}` でも導線は出さない

  * プロフィール/ギャラリー/コレクション一覧へのリンクなし
* ユーザー名/アイコン表示はOK（既FIX）

---

## ✅FIX：token衝突を避ける生成方式（prefix分離＋種別はDBで識別）

結論：`/u/` と `/s/` で **ルーティングが分かれてるので衝突しない**。生成側は「十分長いランダム」でOK。

---

## 1) 衝突しない理由（FIX）

* 限定リンク：`/u/{token}` → `unlisted_tokens` を引く
* 共有リンク：`/s/{token}` → `share_tokens` を引く
* **パスprefixが違う**ので、同じ `{token}` 文字列が偶然出ても混線しない

---

## 2) token生成（FIX）

* tokenは **十分長いランダム文字列**（例：128bit以上相当）
* 文字種：URL安全な英数字（`[A-Za-z0-9]`）のみ
* DB保存は token平文ではなく **sha256(hash)のみ**（既FIX）

---

## 3) unique制約（FIX）

* `unlisted_tokens.token_hash`：unique
* `share_tokens.token_hash`：unique
* それぞれのテーブル内で衝突を防ぐ（再生成で回避）

---

## ✅FIX：限定（unlisted）にした時のPublic反映タイミング（即時）

前提（既FIX）

* Publicギャラリーは新着順のみ
* CloudFrontは不変URL前提で長期キャッシュ（画像）
* ページHTML/APIは別（キャッシュは短期想定）

---

## 1) 反映タイミング（FIX）

* 作品/コレクションを `限定` に変更したら

  * Publicの一覧（/@handle, /@handle/gallery, /@handle/collections）から **即時除外**
* 逆に `限定→公開` も **即時反映**（一覧に復帰）

---

## 2) キャッシュの扱い（FIX）

* 画像はimmutableキャッシュでもOK（URLは同じでも閲覧導線が消えるだけ）
* 一覧API/ページは

  * **短いキャッシュ（秒〜数十秒）** まで許容（設計側）
  * ただし“最長でも1分以内”に反映されることを目標（仕様としてFIX）

---

## ✅FIX：限定↔公開 切替時の限定token（毎回作り直す）

前提（既FIX）

* 限定（unlisted）：作品/コレクション単位で token 自動発行
* 限定→公開/非公開に戻したら token は revoked

---

## 1) ルール（FIX）

* 公開/非公開 → 限定 に変更した瞬間に

  * **新しい unlisted_token を発行**する
* 限定 → 公開/非公開 に変更した瞬間に

  * **即 revoked**
* 再度 限定 にした場合も

  * **毎回新発行**（過去tokenは復活しない）

---

## 2) “有効なのは最新のみ” （FIX）

* 同一target（work/collection）で同時に有効な unlisted_token は1つ
* 再限定で新発行したら旧が残っていても（理論上）旧は無効化する

---

## ✅FIX：限定トークン（unlisted）のFree上限3超過時の挙動（ブロック）

前提（既FIX）

* Free：限定URLは3つまで
* Pro：無制限
* 限定にすると token 自動発行、戻すと revoked

---

## 1) Free上限（FIX）

* Freeユーザーが同時に有効にできる unlisted_token は **3つまで**

  * 対象は「作品＋コレクション」合算

---

## 2) 超過時の挙動（FIX）

* 4つ目を限定にしようとしたら **変更をブロック**する（自動解除はしない）

  * 結果：visibility変更自体が失敗
* エラー文言（固定）：

  * `限定URLの上限（3件）に達しています。解除してから追加してください。`

---

## 3) Pro（FIX）

* Proは上限なし、ブロックなし

---

## ✅FIX：限定URL（unlisted）一覧・管理UI（Manage）

目的：Free上限3の運用を成立させる（解除できないと詰む）。

---

## 1) 入口（FIX）

Manageの設定に `限定URL` ページを追加する。

* パス例：`/settings/unlisted`

---

## 2) 一覧（FIX）

有効な unlisted_token を一覧表示（作品＋コレクション合算）

表示項目：

* 種別：`作品` / `コレクション`
* 対象のサムネ（thumb） or コレクション代表サムネ
* 作成日時（JST）
* ボタン：`コピー` / `解除`

並び順：

* `created_at desc`（新しい順）

---

## 3) コピー（FIX）

* `コピー` で `https://vistia.studio/u/{token}` をクリップボードにコピー

---

## 4) 解除（FIX）

* `解除` 押下で確認モーダル（必須）

  * 文言：`この限定URLを無効にします。よろしいですか？`
* 解除後：

  * tokenは即 revoked
  * その対象が「限定」だった場合でも、visibilityは **変更しない**（重要）

    * ただし、限定URLが無効になった以上、外部からは404になる

---

## 5) 上限表示（FIX）

* Freeユーザーにはページ上部に

  * `使用中：{n} / 3`
* Proユーザーには

  * `使用中：{n}（無制限）`

---

了解。**限定URLを解除したら、その対象は自動で「非公開」に落とす**でFIXに更新するね。
（＝外部到達不能＋本人も「閉じた」状態が明確になる）

---

## ✅更新FIX：限定URL解除時は対象を「非公開」に変更する

### 1) 挙動（FIX）

Manageの `限定URL解除` を実行したら、同時に以下を行う：

* unlisted_token を `revoked`
* 対象の visibility を **`非公開` に変更**

対象：

* work / collection どちらも同じ

---

### 2) 例外（FIX）

* 対象がすでに `非公開` の場合は

  * token だけ revoked（visibilityはそのまま）

---

### 3) 通知（FIX）

* ユーザー自身の操作なので

  * in-app通知：なし
  * メール：なし

---

### 4) UI文言（FIX）

解除確認モーダルに必ず表示：

* `この限定URLを無効にし、公開範囲を「非公開」に変更します。よろしいですか？`

---

## ✅FIX：公開範囲セレクタの説明文（Manage用）

前提（既FIX）

* 表記は本番：`公開 / 限定 / 非公開`
* 限定は閉じた閲覧（導線なし）
* 限定URL解除すると非公開に落ちる（直前FIX）
* 共有リンクは別機能（/s）

---

## 1) 表示する説明（FIX）

公開範囲の選択UIに、各項目の説明を固定で付ける：

### 公開

* `プロフィールやギャラリーに表示されます。誰でも閲覧できます。`

### 限定

* `ギャラリーには表示されません。限定URLを知っている人だけ閲覧できます。`

### 非公開

* `自分だけが閲覧できます。外部には公開されません。`

---

## 2) 注意文（限定の下に追加）（FIX）

* `※ 限定URLを解除すると「非公開」になります。`

---

## 3) 共有リンクとの関係の注釈（FIX）

公開範囲セレクタの下に小さく1行（任意だが入れてOK）：

* `共有リンク（/s）は公開範囲とは別に管理できます。`

---

## ✅FIX：限定URLの発行・管理UI（作品詳細/コレクション詳細 in Manage）

前提（既FIX）

* 限定に変更した瞬間に unlisted_token 自動発行
* 限定→公開/非公開に戻すと token revoked
* Free：限定URLは3つまで（作品＋コレクション合算）
* 限定URL解除＝token revoked＋対象を非公開へ（直前FIX）
* 表記：公開/限定/非公開

---

## 1) どこに出すか（FIX）

* 作品詳細・コレクション詳細に `限定URL` セクションを置く
* visibility が `限定` のときだけ表示する

---

## 2) 表示内容（FIX）

* 現在の限定URL（`https://vistia.studio/u/{token}`）
* ボタン：

  * `コピー`
  * `限定URLを解除`（危険）

---

## 3) Free上限（FIX）

* `公開/非公開 → 限定` に変更しようとした時点で上限チェック
* 上限超過なら切替をブロック（既FIX）

  * 文言：`限定URLの上限（3件）に達しています。解除してから追加してください。`

---

## 4) 解除（FIX）

* `限定URLを解除` 押下で確認モーダル（必須）

  * 文言：`限定URLを無効にし、公開範囲を「非公開」に変更します。よろしいですか？`
* 実行後：

  * token revoked
  * visibility を非公開へ
  * セクションは消える（非公開なので）

---

## 5) 上位の限定URL一覧ページ（FIX再掲）

* 設定に `限定URL` ページ（全体管理）も用意（解除/コピー用途）

---

## ✅FIX：限定 → 公開 へ戻すときの確認（確認なし）

前提（既FIX）

* 限定→公開/非公開に戻すと unlisted_token は revoked
* 解除（限定URL解除）は非公開へ落とす（別操作）

---

## 1) 動作（FIX）

* 公開範囲を `限定 → 公開` に変更したら

  * **確認ダイアログなし**
  * 即時に

    * visibility を公開へ
    * unlisted_token を revoked

---

## 2) 理由（FIX）

* 公開に戻すのは “通常操作” なので確認を挟むとUXが悪い
* tokenが無効になるのは副作用だが、限定の性質上自然

---

## 3) UI補助（FIX）

* セレクタの `限定` の説明に既に注意書きがあるので十分

  * `限定URLを解除すると「非公開」になります。`
  * （限定→公開は「解除」ではないので混同しない）

---

## ✅FIX：限定 → 非公開 へ戻すとき（確認なし）

前提（既FIX）

* 限定→非公開に戻すと unlisted_token は revoked
* 確認入力は重大操作のみ（Admin側）で、Manageの通常操作は軽くする

---

## 1) 動作（FIX）

* 公開範囲を `限定 → 非公開` に変更したら

  * **確認ダイアログなし**
  * 即時に

    * visibility を非公開へ
    * unlisted_token を revoked

---

## 2) 理由（FIX）

* ユーザー自身の公開範囲操作なので、確認を挟むよりテンポ優先
* 「限定URL解除（=非公開に落とす）」は危険操作なので別途確認あり（既FIX）

---

## ✅FIX：公開範囲（visibility）変更後のフィードバック（トースト）

目的：即時反映＆確認ダイアログ無しの代わりに、操作成功を明確にする。

---

## 1) トースト表示（FIX）

Manageで公開範囲を変更したら、成功時に必ずトーストを出す：

* 文言：`公開範囲を変更しました。`

---

## 2) 限定URLが無効化された場合（FIX）

`限定 → 公開/非公開` の変更で unlisted_token が revoked された場合も文言は増やさない（簡素化）

※ 限定URLが欲しいなら「限定」にすれば自動発行されるため

---

## 3) 失敗時（FIX）

* 上限超過などで失敗したらトースト：

  * `限定URLの上限（3件）に達しています。解除してから追加してください。`

---

## ✅FIX：限定URL一覧の解除ボタン文言（強めにする）

前提（既FIX）

* 限定URL解除＝token revoked＋対象を非公開へ変更
* 確認モーダルあり

---

## 1) ボタン文言（FIX）

限定URL一覧（設定ページ）の各行のボタンは：

* `非公開にして解除`

（「解除」だけだと軽く見えて事故るため）

---

## 2) 確認モーダル文言（FIX）

* タイトル：`限定URLを解除しますか？`
* 本文：`限定URLを無効にし、公開範囲を「非公開」に変更します。`

---

## ✅FIX：限定URL一覧に「対象へ移動」を付ける

目的：「どれを解除するか分からない」を防ぐ（あなたの要望に直結）。

---

## 1) 一覧の追加項目（FIX）

限定URL一覧（`/settings/unlisted`）の各行に以下を追加：

* `対象へ移動` リンク

---

## 2) 遷移先（FIX）

* 作品：`/works/{workId}`（Manageの作品詳細）
* コレクション：`/collections/{collectionId}`（Manageのコレクション詳細）

---

## 3) 表示（FIX）

* サムネ（thumb）＋作成日時に加えて
* 「対象へ移動」で確実に確認できる

---

## ✅FIX：Manageのサイドメニュー（最小セット）

目的：設定ページを増やしすぎず、必要な導線だけ残す。

---

## 1) メニュー構成（FIX）

Manageの左メニュー（またはモバイルのメニュー）に以下を固定で置く：

1. `作品`
2. `コレクション`（Proのみ表示）
3. `通知`
4. `サポート`（チケット一覧）
5. `設定`

---

## 2) 設定（FIX）

`設定` 配下は最小で：

* `プロフィール`

  * display_name / bio / avatar / YouTube / Links
* `限定URL`

  * `/settings/unlisted`（限定URLの管理）
* `メール設定`

  * 任意メールON/OFF（既FIX）

---

## ✅FIX：Manageのサイドメニュー（最小セット）

目的：設定ページを増やしすぎず、必要な導線だけ残す。

---

## 1) メニュー構成（FIX）

Manageの左メニュー（またはモバイルのメニュー）に以下を固定で置く：

1. `作品`
2. `コレクション`（Proのみ表示）
3. `通知`
4. `サポート`（チケット一覧）
5. `設定`

---

## 2) 設定（FIX）

`設定` 配下は最小で：

* `プロフィール`

  * display_name / bio / avatar / YouTube / Links
* `限定URL`

  * `/settings/unlisted`（限定URLの管理）
* `メール設定`

  * 任意メールON/OFF（既FIX）

---

## ✅FIX：メール設定（ユーザー側）と送信判定（最終整理）

前提（既FIX）

* in-app通知：必須（OFF不可）
* メール通知：任意メールのみOFF可
* アカウント系・運営重大操作・支払い失敗：強制メール
* `users.email_optional_enabled` を持つ
* 判定：

  * 強制メール：必ず送る（テンプレOFF不可、ユーザーOFF無視、バウンス抑止も無視）
  * 任意メール：テンプレON AND ユーザーON AND バウンスしてない

---

## 1) ユーザー設定UI（FIX）

設定 → `メール設定` にスイッチを1つだけ置く：

* `任意のお知らせメールを受け取る`（ON/OFF）

  * 初期値：ON（推奨）

注記（固定文言）：

* `重要なお知らせ（アカウント・支払い等）はOFFでも送信されます。`

---

## 2) 送信判定（FIX）

### 2.1 強制メール（FIX）

以下の reason_code は **必ず送信**（テンプレOFF不可、ユーザーOFF無視、バウンス無視）：

* `ACCOUNT_SUSPENDED`
* `ACCOUNT_RESTORED`
* `WORK_HIDDEN_BY_ADMIN`
* `WORK_DELETED_BY_ADMIN`
* `COLLECTION_HIDDEN_BY_ADMIN`
* `COLLECTION_DELETED_BY_ADMIN`
* `TOKEN_REVOKED`
* `PRO_GRANTED_MANUAL`
* `PRO_REVOKED_MANUAL`
* `SUBSCRIPTION_PAYMENT_FAILED`

### 2.2 任意メール（FIX）

それ以外は任意扱い：

* テンプレ `email_enabled = true`
* AND `users.email_optional_enabled = true`
* AND `users.email_bounced = false`（バウンスしてない）
  → これを満たした場合のみ送信

---

## 3) バウンス/苦情（complaint）の扱い（FIX）

* SESのバウンス/苦情をDBに反映する（既FIX）
* `email_bounced=true` の間は任意メールを止める
* 強制メールは送る（既FIX）

---

## ✅FIX：ManageのMagic Link（Emailログイン）詳細仕様

前提（既FIX）

* Manageログイン：Email（Magic Link）/ Google / X
* セッション：DBセッション（HttpOnly Cookie `manage_session`）
* 「メール未登録なら未登録と返す」「連携は勝手にやらない」「新規作成はボタンから」要望あり

---

# 1) 概念（FIX）

* Emailログインは **Magic Link専用**
* Magic Linkは **ログインのみ**（自動サインアップしない）

---

# 2) 画面（FIX）

ログイン画面にボタンを分ける：

* `ログイン（Magic Linkを送信）`
* `新規作成`（＝サインアップ導線）

---

# 3) Magic Link送信API（FIX）

### エンドポイント（例）

* `POST /auth/magic-link/request`

### 入力

* `email`（必須、前後トリム、case-insensitiveで正規化）

### 挙動（FIX）

* その email のユーザーが存在しない場合：

  * **200で返して良いが本文は明確に**
  * レスポンス：`未登録です`（あなたの指定どおり）
* 存在する場合：

  * Magic Linkを発行してメール送信
  * レスポンス：`送信しました`

※ セキュリティ的には“存在を隠す”設計もあるけど、あなたの方針で **未登録を明示**でFIX。

---

# 4) Magic Linkトークン（FIX）

* 1回使い切り
* 有効期限：**15分**
* DB保存：tokenは平文保存しない（sha256 hash）
* 同一ユーザーで同時に有効なMagic Linkは **最新1つのみ**

  * 新規発行したら旧は即無効

---

# 5) レート制限（FIX）

* 1メールアドレス：**1分に3回まで**
* 1IP：**1分に20回まで**
* 超過時：429
  文言：`現在アクセスを制限しています。時間をおいてお試しください。`

---

# 6) Magic Link消費（FIX）

### エンドポイント（例）

* `POST /auth/magic-link/consume`

### 入力

* `token`

### 成功時（FIX）

* `manage_sessions` にDBセッションを作成
* HttpOnly Cookie `manage_session` をセット（既FIX）
* レスポンス：`OK`

### 失敗時（FIX）

* 無効/期限切れ/使用済み：401
  文言：`リンクが無効です。`

---

# 7) 連携は勝手にやらない（FIX）

* Magic Linkでログインできるのは **既にEmailを登録済みのユーザーだけ**
* Google/Xログインをした時に

  * **同じメールが存在しても自動で紐付けしない**
  * ユーザーが設定画面から明示的に「連携」した場合のみ紐付け（※連携UIは後でFIXでもOK）

---

# 8) 新規作成（FIX）

* `新規作成` ボタンからのみ作る
* Magic Linkリクエストではユーザーを作らない

---

## ✅FIX：ManageのGoogle / X ログインの「初回ユーザー作成」と「連携」ルール

前提（直前FIX）

* 連携は勝手にやらない
* ユーザー作成は `新規作成` ボタンから
* メール未登録なら「未登録です」と返す（Magic Link）

---

# 1) ボタン（FIX）

ログイン画面に以下を置く：

* `Googleでログイン`
* `Xでログイン`
* `新規作成`（別導線）

※ Google/Xボタンは「ログイン」であり、**自動サインアップではない**。

---

# 2) Google / X ログイン時の挙動（FIX）

## 2.1 既存ユーザーが「そのプロバイダ連携済み」なら（FIX）

* 通常ログイン
* `manage_session` 発行

## 2.2 既存ユーザーが「そのプロバイダ未連携」なら（FIX）

* **ログインさせない**
* レスポンス：`未連携です`
* UI文言（例）：`このアカウントはまだ連携されていません。ログイン方法を確認してください。`

## 2.3 “同じメールアドレス” の既存ユーザーがいても（FIX）

* **自動で紐付けしない**
* つまり「メール一致＝同一人物」扱いはしない

---

# 3) 新規作成フロー（FIX）

`新規作成` から入った場合のみユーザー作成ができる。

## 3.1 新規作成の選択肢（FIX）

* `Emailで作成`（メール登録してMagic Linkログインが使える）
* `Googleで作成`
* `Xで作成`

## 3.2 作成時の注意（FIX）

* Google/Xで作成したユーザーは、そのプロバイダでのみログイン可
* Emailログインを使いたい場合は、後で **明示的にEmail追加**（後回しでOK）

---

# 4) 連携（Linking）の基本（FIX）

* 連携は **Manageの設定画面からユーザーが明示操作**したときだけ行う
* 連携操作には確認（再認証）を必須にする（例：Google再認証 / X再認証 / Email確認）

※ 連携UIの詳細（どの画面で、どんな確認、解除できるか）は次でFIXできる。

---

# 5) エラー文言（FIX）

* 未連携：`未連携です`
* 認証失敗：`ログインに失敗しました。`
* 制限（429）：`現在アクセスを制限しています。時間をおいてお試しください。`

---

## ✅更新FIX：アカウント連携は「追加/解除」両方あり

### 1) `/settings/auth`（ログイン方法）画面（FIX）

表示する項目と操作：

* Email（Magic Link）

  * 状態：`登録済み / 未登録`
  * 操作：

    * 未登録 → `メールを追加`
    * 登録済み → `メールを削除`（=Email解除）
* Google

  * 状態：`連携済み / 未連携`
  * 操作：

    * 未連携 → `連携する`
    * 連携済み → `解除する`
* X

  * 状態：`連携済み / 未連携`
  * 操作：

    * 未連携 → `連携する`
    * 連携済み → `解除する`

---

## 2) 解除の共通ガード（FIX）

### 2.1 最後のログイン手段禁止（FIX）

解除しようとして「ログイン手段が0」になる場合は **ブロック**。

* 例：Emailのみの人がEmail削除 → ❌
* 例：Googleのみの人がGoogle解除 → ❌
* 例：Email+Googleの人がGoogle解除 → ✅（Emailが残る）

エラー文言（固定）：

* `ログイン方法がなくなるため解除できません。`

### 2.2 再認証必須（FIX）

解除・追加・メール削除はすべて **再認証必須**。

* 直近ログインから **10分超** なら必ず再認証を要求（10分以内でも解除は再認証でOK）

---

## 3) Email（Magic Link）の追加/削除（FIX）

### 3.1 追加（FIX）

* `メールを追加` → email入力 → 確認リンク送信 → 確認完了で `email_verified_at` セット

制約：

* 既に他ユーザーが使っているemailは追加不可
  文言：`このメールアドレスは使用されています。`

### 3.2 削除（FIX）

* `メールを削除` → 確認モーダル → 実行

  * `users.email = NULL`
  * `users.email_verified_at = NULL`
  * 以後Magic Linkログイン不可

※「最後のログイン手段禁止」が適用される

---

## 4) Google / X の連携・解除（FIX）

### 4.1 連携（FIX）

* `連携する` → OAuth再認証 → `oauth_identities` に紐付け作成

### 4.2 解除（FIX）

* `解除する` → 確認モーダル（必須）→ 実行

  * `oauth_identities` の該当レコード削除（または revoked_at で無効化）

確認モーダル文言（固定）：

* `このログイン方法を解除します。よろしいですか？`

---

## 5) 「勝手に連携しない」ルールは維持（FIX）

* Google/Xログイン時に「同じメールが存在」しても **自動紐付けしない**
* 連携は必ず `/settings/auth` の明示操作からのみ

---

## ✅FIX：新規作成フローの最低ログイン手段保証（Email確認前も含む）

前提（既FIX）

* 新規作成は「新規作成」ボタンからのみ
* 連携は勝手にやらない
* 解除あり（ただし“最後のログイン手段”は解除不可）
* Email追加は verification（確認リンク）で有効化

---

# 1) 新規作成の方式（FIX）

`新規作成` で選べるのは3つ：

1. `Emailで作成`
2. `Googleで作成`
3. `Xで作成`

作成直後に **最低1つのログイン手段が必ず有効**になっている状態にする。

---

# 2) Emailで作成（FIX）

### 2.1 作成時点（FIX）

* email入力 → 確認メール送信（verification link）
* ユーザーは作られるが、状態は `email_verified_at = NULL`

### 2.2 ログイン可能になる条件（FIX）

* **確認リンクを踏んだ後のみ** Magic Linkログイン可能
* 確認前にMagic Linkリクエストしても

  * レスポンス：`未登録です`（扱いを単純化するため）
  * ※「仮登録です」みたいな状態は出さない

---

# 3) Google / X で作成（FIX）

* OAuth完了時点で `oauth_identities` を作成
* 作成直後から **そのプロバイダでログイン可能**（=最低1手段保証）

---

# 4) 解除ガード（再掲FIX）

* 解除操作は「ログイン手段が0になる場合」は禁止

  * 文言：`ログイン方法がなくなるため解除できません。`
* 解除/連携/メール削除は再認証必須（既FIX）

---

了解。Manageは **Magic Link廃止 → メール＋パスワード** に切り替えでFIXする（スマホ前提で正しい）。

以下、いままでのFIX（Cookieセッション、勝手に連携しない、新規作成はボタンから等）を崩さずに、Magic Link関連だけ差し替える。

---

## ✅FIX：Manage認証を「Email + Password」に変更（Magic Link廃止）

### 0) 置き換え範囲（FIX）

* Manageログインの **Email（Magic Link）を廃止**
* Manageログイン：**Email + Password / Google / X**
* セッション方式は維持：

  * **DBセッション（HttpOnly Cookie）**
  * Cookie：`manage_session`（SameSite=Lax、Secure本番ON）
  * セッション保存：`manage_sessions`（tokenはsha256で保存）

---

## 1) 画面構成（FIX）

ログイン画面に以下を配置：

* `メールアドレス`
* `パスワード`
* ボタン：`ログイン`
* ボタン：`新規作成`
* リンク：`パスワードを忘れた`
* ボタン：`Googleでログイン`
* ボタン：`Xでログイン`

※ 「連携は勝手にやらない」は維持（後述）

---

## 2) 新規作成（Email）（FIX）

### 入力

* email（必須）
* password（必須）

### emailの扱い（FIX）

* 前後トリム、case-insensitiveで正規化
* emailが既に使われている場合：作成不可

  * 文言：`このメールアドレスは使用されています。`

### passwordルール（FIX）

* 最少 **8文字**（あなたの指定どおり）
* 最大 72文字（bcrypt等の上限に合わせるため。実装都合だが仕様として固定でOK）
* 空白のみ不可

### 作成時の挙動（FIX）

* ユーザー作成は **新規作成ボタンからのみ**
* 作成完了後は **そのままログインしてセッション発行**（スマホ前提でUX優先）
* ※ email確認（verification）は **後回し**（必要なら次でFIXできる）

---

## 3) ログイン（Email + Password）（FIX）

### エンドポイント（概念）

* `POST /auth/login`

### 失敗時のメッセージ（FIX）

* email未登録：**`未登録です`**（あなたの方針を維持）
* password不一致：`メールアドレスまたはパスワードが違います。`
* レート制限時：`現在アクセスを制限しています。時間をおいてお試しください。`

---

## 4) パスワードリセット（FIX）

Magic Linkの代わりに必須になるやつ。

### 4.1 リセット要求（FIX）

* `POST /auth/password/reset/request`
* email未登録：**`未登録です`**（方針維持）
* 登録済み：リセットメール送信 → `送信しました`

### 4.2 リセット実行（FIX）

* リセット用tokenは

  * 1回使い切り
  * 有効期限：**30分**
  * 同時に有効なのは **最新1つのみ**
  * DB保存は token平文ではなくsha256 hash

* 新しいパスワードは上のルール（最少8文字）を適用

---

## 5) セキュリティ（最低限）（FIX）

* パスワードはハッシュ化して保存（平文禁止）
* ログイン試行のレート制限（FIX）

  * 1IP：1分20回まで
  * 1アカウント：1分10回まで
* 連携/解除（Google/XやEmail変更等の重大操作）は再認証必須（既方針のまま）

---

## 6) Google / X ログインとの関係（FIX維持）

* **メール一致で自動連携しない**（勝手に連携しない）
* ログインできるのは

  * そのプロバイダを **連携済みのユーザーのみ**
* 未連携の場合：`未連携です`

---

## 7) 既存FIXとの整合（変更点だけ）

* ✅維持：Cookieセッション、DBセッション、manage_session
* ✅維持：「未登録です」と返す方針
* ✅維持：「連携は勝手にやらない」
* ✅維持：「ユーザー作成は新規作成ボタンから」
* ❌廃止：Magic Link request/consume、verification前提の一連

---

次はこの変更に合わせて、**（1）メールアドレス変更を許可するか**、**（2）パスワード変更画面**、**（3）ログアウト/全端末ログアウト**を順にFIXしていこう。

# Vistia Manage 仕様（FIX / v1.3）

## 1. ドメイン/URL
- Manage：`https://manage.vistia.studio/`
- 初期画面：ダッシュボード

---

## 2. 認証/ログイン
### 2.1 ログイン方式
- メール＋パスワード
- ソーシャルログイン

### 2.2 ソーシャルログイン対応
- Google
- X（Twitter）
- TikTok

### 2.3 アカウント統合（リンク/マージ）
- 提供しない（別アカウント同士を統合しない）
- 既に複数アカウントがある場合：
  - どちらかのアカウントを削除して運用する
  - 削除した側のデータ移行：しない（移せない）

---

## 3. Manage メニュー（MVP）
- ダッシュボード（初期）
- 作品（投稿）管理
- 限定URL（UNLISTED）管理
- コレクション（Proのみ）
- ピン画像（Proのみ）
- プロフィール
- テーマ
- プラン/課金
- アカウント
- 通知（通知センター）

---

## 4. ダッシュボード（計測なし）
表示内容：
- 投稿数（PUBLIC / UNLISTED / PRIVATE の内訳）
- UNLISTED枠（使用数 / 上限）
- Pro要素（コレクション/ピン画像）の利用可否
- ストレージ使用量
- 公開URL（プロフィールURL / ギャラリーURL）

---

## 5. BAN中の挙動（Admin停止）
前提：BAN中でもログインは可能、Publicは404。

- Manage：ログイン可能
- Public：404
- BAN中に許可する操作：
  - 課金の解約
  - 退会（アカウント削除）
- 上記以外（投稿/プロフィール/テーマ/リンク/フリーページ/コレクション等）は全て禁止

---

## 6. 作品（post）
### 6.1 基本
- 1作品 = 1枚画像
- タイトル/説明：なし
- オリジナル画像の差し替え：不可

### 6.2 アップロード
- 1回に最大5枚
- 同時アップロード：可能
- サイズ上限：50MB/枚
- 入力許可形式：JPEG / PNG / WebP / HEIC / HEIF
- HEIC/HEIF：サーバー側で変換して受け付ける

### 6.3 重複判定
- 範囲：同一ユーザー内のみ
- 基準：完全一致（バイト一致）→ 画像内容ハッシュ
- 重複検知時：該当画像のみエラー、他はアップロード継続
- 重複はアップロード不可（postを作成しない）

### 6.4 デフォルトVisibility
- アップロード直後：PUBLIC

### 6.5 編集可能項目
- Visibility（PUBLIC / UNLISTED / PRIVATE）
- サムネのトリミング（再生成）
- コレクションへの追加/並び（Proのみ、コレクションのルールに従う）
- 削除

### 6.6 UNLISTED（作品）
- UNLISTEDへ切り替えた瞬間に token を自動発行
- token：1作品=1token / 無期限 / 再発行可（ボタン）
- token再発行：旧tokenは無効化
- UNLISTED → PUBLIC：token無効化（404）
- UNLISTED枠の消費：`visibility = UNLISTED` の作品数

### 6.7 削除
- 論理削除 → 30日後に物理削除
- Public：削除作品は 404

---

## 7. コレクション（Proのみ）
### 7.1 基本
- コレクション数：無制限（Pro）
- Visibility：PUBLIC / UNLISTED / PRIVATE
- 並び順：
  - コレクション一覧：ユーザー指定順
  - コレクション内作品：ユーザー指定順

### 7.2 デフォルトVisibility
- 作成直後：PUBLIC

### 7.3 作品追加ルール（コレクションVisibility別）
- PUBLICコレクション：PUBLIC作品のみ追加可能
- UNLISTEDコレクション：PUBLIC + UNLISTED作品のみ追加可能
- PRIVATEコレクション：PRIVATE作品のみ追加可能

### 7.4 Public URL（コレクション）
- PUBLIC：`/@{handle}/gallery/collections/{collectionId}`
- UNLISTED：`/@{handle}/c/{token}`

### 7.5 UNLISTED（コレクション）
- UNLISTEDへ切り替えた瞬間に token を自動発行
- token：1コレクション=1token / 無期限 / 再発行可（ボタン）
- token再発行：旧tokenは無効化
- UNLISTED → PUBLIC：token無効化（404）

---

## 8. ピン画像（Proのみ）
### 8.1 上限
- Pro：最大3枚
- Free：0枚

### 8.2 指定対象
- 作品（post）から選択
- ピンに設定できる作品：PUBLICのみ

---

## 9. プラン（課金要素）
### 9.1 プラン
- Free
- Pro

### 9.2 機能差
- ピン画像：Freeなし / Proあり（最大3枚）
- コレクション：Freeなし / Proあり（無制限）
- UNLISTED枠：
  - Free：3
  - Pro：無制限

### 9.3 降格（Pro → Free）
- 超過分は自動でPRIVATE化
- 優先順位：createdAt 新しい順を残す
  - UNLISTED：新しい順に3件まで維持、残りはPRIVATE化
  - コレクション：すべてPRIVATE化
  - ピン画像：すべて解除（0枚）

---

## 10. プロフィール（Manageで編集）
編集対象：
- 表示名
- アイコン
- ひとこと
- YouTube動画URL（1本）
- 外部リンク（label/url/description/icon、並び替え）
- フリーページ本文（WYSIWYG）
- フリーページ画像（postから選択 / 専用アップロード）
- テーマ（背景/アクセント/フォント/カード質感）
- ピン画像（Proのみ、最大3枚）

---

## 11. 外部リンク（Manage）
### 11.1 フィールド
- label
- url
- description
- icon

### 11.2 アイコン
- 指定方法：アップロード画像（正方形）
- 仕様：256x256 PNG（透過維持）
- アップロード上限：5MB

---

## 12. フリーページ（Manage）
### 12.1 本文（WYSIWYG）
- 文字数上限：10,000文字
- 許可要素（サニタイズ許可リスト）：
  - p, br
  - h2, h3
  - strong, em, s
  - ul, ol, li
  - blockquote
  - code, pre
  - hr

### 12.2 リンク
- `http/https` のみ許可（危険スキーム拒否）
- `target="_blank"` + `rel="noopener noreferrer"`

### 12.3 画像
- 埋め込み可（Vistiaにアップロードした画像のみ）
- 画像ソース：
  - post画像から選択して貼り付け可能
  - フリーページ専用画像のアップロードも可能
- フリーページ専用画像の仕様：postと同じ
  - 上限：50MB
  - 最適化：長辺1280 JPEG quality 80
  - EXIF削除
  - 向き補正（焼き込み）

### 12.4 外部埋め込み
- 許可サービス：YouTube / X（Twitter）/ TikTok / Twitch
- 許可URL：許可ドメインのみに限定（short/旧ドメイン含む）
  - YouTube：`youtube.com` / `youtu.be`
  - X：`x.com` / `twitter.com`
  - TikTok：`tiktok.com`（共有/短縮URL含む）
  - Twitch：`twitch.tv`
- 入力形式：URL貼り付け → 自動埋め込み

---

## 13. 通知（Manage内）
### 13.1 UI
- 通知センター（ベル）
- 未読数
- 通知一覧

### 13.2 通知イベント（Admin連動）
- 対象をHIDE（非表示）した
- HIDEを解除した
- アカウント停止（BAN）
- 停止解除
- 対象削除（論理削除）
- チケットの最終結論（RESOLVED/CLOSED）

---

## 14. 課金（Stripe）
### 14.1 決済プロバイダ
- Stripe

### 14.2 課金モデル
- 月額 + 年額

### 14.3 無料トライアル
- 30日
- トライアル中：Pro扱い（広告なし・全機能解放）

### 14.4 トライアル終了時
- 課金されない場合：Freeへ戻す（降格ルール適用）

### 14.5 解約
- 期間満了までPro維持（次回更新日まで）

### 14.6 支払い失敗
- 猶予：3日
- 猶予中：Pro維持

### 14.7 Webhook
- Stripe推奨イベントを網羅（全て購読・処理）

### 14.8 価格表示
- Manageのみ（Publicには出さない）

### 14.9 購入導線
- ダッシュボードに表示
- 設定（プラン/課金）ページにも表示

---

## 15. アカウント/退会
### 15.1 退会（アカウント削除）
- 実行者：ユーザー本人 / Admin の(どちらも可)
- 論理削除 → 30日後に物理削除
- 退会前の確認表示：最小（handle と「30日後に物理削除される」旨）
- 誤操作防止：パスワード再入力必須

### 15.2 退会の取り消し（復元）
- 30日以内は取り消し（復元）可能
- 復元方法：Manageにログインして復元操作を行う

### 15.3 退会状態（猶予中）の挙動
- Public：404
- Manage：ログイン可能
- Manage：復元操作のみ可能

---

## 16. メール未登録ユーザー
### 16.1 許可
- メール未登録を許可（ソーシャルのみで利用開始OK）

### 16.2 メール送信
- メール未登録ユーザーにはメール送信しない（Manage内通知のみ）

### 16.3 パスワードリセット
- メール＋パスワードで登録したユーザーは、メールでパスワードリセット可能

### 16.4 後からメール＋パスの追加
- ソーシャルのみユーザーは、後からメール登録＋パス設定を追加できる
- メール追加は確認メール（OTPリンク）でverified後に有効化する

### 16.5 ソーシャル喪失時の扱い
- 救済なし（ログインできなくなったら復旧不可）
- ただし、メール未登録状態にはUIで警告し、メール追加を促す

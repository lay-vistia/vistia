# Vistia Manage 仕様（FIX / v1.4）

## 1. ドメイン/URL
- Manage：`https://manage.vistia.studio/`
- 初期画面：ダッシュボード

---

## 2. 認証/ログイン
- メール＋パスワード
- ソーシャル：Google / X / TikTok

### 2.1 アカウント統合（リンク/マージ）
- 提供しない
- 既に複数アカウントがある場合：どちらかを削除して運用
- データ移行：しない

---

## 3. Manage メニュー（MVP）
- ダッシュボード
- 作品（投稿）管理
- 限定URL（UNLISTED）管理
- コレクション（Proのみ）
- ピン画像（Proのみ）
- プロフィール
- テーマ
- プラン/課金
- アカウント
- 通知（通知センター）

---

## 4. BAN中の挙動（Admin停止）
- ログイン：可能
- Public：404
- BAN中に許可する操作：
  - 課金の解約
  - 退会（アカウント削除）
- 上記以外（投稿/プロフィール/テーマ/リンク/フリーページ/コレクション等）は全て禁止

---

## 5. 画像資産（asset）前提
- 画像はすべて共通の画像資産として `assetId` を持つ
- Public/Manageで表示するのは最適化画像/サムネのみ（オリジナルは絶対に表示しない）

---

## 6. 作品（post）
### 6.1 基本
- 1作品 = 1枚画像
- タイトル/説明：なし
- オリジナル画像の差し替え：不可

### 6.2 アップロード
- 1回に最大5枚
- 同時アップロード：可能
- サイズ上限：50MB/枚
- 許可形式：JPEG / PNG / WebP / HEIC / HEIF
- HEIC/HEIF：サーバー側で変換して受け付ける
- アップロード後、サーバー変換が成功したものだけ表示可能

### 6.3 重複判定
- 範囲：同一ユーザー内のみ
- 基準：完全一致（バイト一致）→ 画像内容ハッシュ
- 重複検知時：該当画像のみエラー、他はアップロード継続
- 重複はアップロード不可（postを作成しない）

### 6.4 デフォルトVisibility
- アップロード直後：PUBLIC

### 6.5 編集可能項目
- Visibility（PUBLIC / UNLISTED / PRIVATE）
- サムネのトリミング（再生成）
- コレクションへの追加/並び（Proのみ、コレクションのルールに従う）
- 削除

### 6.6 UNLISTED（作品）
- UNLISTEDへ切り替えた瞬間に token を自動発行
- token：1作品=1token / 無期限 / 再発行可（ボタン）
- token再発行：旧tokenは無効化
- UNLISTED → PUBLIC：token無効化（404）
- UNLISTED枠の消費：`visibility = UNLISTED` の作品数

### 6.7 削除
- 論理削除 → 30日後に物理削除
- Public：削除作品は 404
- 30日猶予中、S3の実体は残す（参照は404）

---

## 7. コレクション（Proのみ）
- コレクション数：無制限（Pro）
- Visibility：PUBLIC / UNLISTED / PRIVATE
- 並び順：
  - コレクション一覧：ユーザー指定順
  - コレクション内作品：ユーザー指定順
- デフォルトVisibility：PUBLIC

### 7.1 作品追加ルール（コレクションVisibility別）
- PUBLICコレクション：PUBLIC作品のみ追加可能
- UNLISTEDコレクション：PUBLIC + UNLISTED作品のみ追加可能
- PRIVATEコレクション：PRIVATE作品のみ追加可能

### 7.2 URL
- PUBLIC：`/@{handle}/gallery/collections/{collectionId}`
- UNLISTED：`/@{handle}/c/{token}`

### 7.3 UNLISTED（コレクション）
- UNLISTEDへ切り替えた瞬間に token を自動発行
- token：1コレクション=1token / 無期限 / 再発行可（ボタン）
- token再発行：旧tokenは無効化
- UNLISTED → PUBLIC：token無効化（404）

---

## 8. ピン画像（Proのみ）
- Pro：最大3枚
- Free：0枚
- 指定対象：作品（post）から選択
- ピンに設定できる作品：PUBLICのみ

---

## 9. プラン（課金要素）
- Free / Pro
- 差分：
  - ピン画像：Freeなし / Proあり（最大3枚）
  - コレクション：Freeなし / Proあり（無制限）
  - UNLISTED枠：Free 3 / Pro 無制限

### 9.1 降格（Pro → Free）
- 超過分は自動でPRIVATE化（createdAt 新しい順を残す）
  - UNLISTED：新しい順に3件まで維持、残りはPRIVATE化
  - コレクション：すべてPRIVATE化
  - ピン画像：すべて解除

---

## 10. プロフィール（Manageで編集）
編集対象：
- 表示名
- アイコン
- ひとこと
- YouTube動画URL（1本）
- 外部リンク（label/url/description/icon、並び替え）
- フリーページ本文（WYSIWYG）
- フリーページ画像（postから選択 / 専用アップロード）
- テーマ（背景/アクセント/フォント/カード質感）
- ピン画像（Proのみ、最大3枚）

---

## 11. 外部リンク（Manage）
- フィールド：label / url / description / icon
- icon：
  - アップロード画像（正方形）
  - 256x256 PNG（透過維持）
  - 5MB上限

---

## 12. フリーページ（Manage）
### 12.1 本文（WYSIWYG）
- 文字数上限：10,000文字
- 許可要素（サニタイズ許可リスト）：
  - p, br
  - h2, h3
  - strong, em, s
  - ul, ol, li
  - blockquote
  - code, pre
  - hr

### 12.2 リンク
- `http/https` のみ許可（危険スキーム拒否）
- `target="_blank"` + `rel="noopener noreferrer"`

### 12.3 画像
- 埋め込み可（Vistiaにアップロードした画像のみ）
- 画像ソース：
  - post画像から選択して貼り付け可能
  - フリーページ専用画像のアップロードも可能（仕様はpostと同じ）
- フリーページ専用画像（postと同一仕様）：
  - 50MB
  - 最適化：長辺1280 JPEG q80
  - EXIF削除、向き焼き込み

### 12.4 外部埋め込み
- 許可サービス：YouTube / X / TikTok / Twitch
- 許可URL：許可ドメインのみ（short/旧ドメイン含む）
- 入力形式：URL貼り付け → 自動埋め込み

---

## 13. 通知（Manage内）
- 通知センター（ベル）/ 未読数 / 通知一覧
- 通知イベント（Admin連動）：
  - 対象をHIDEした / 解除した
  - アカウント停止（BAN）/ 解除
  - 対象削除（論理削除）
  - チケットの最終結論（RESOLVED/CLOSED）

---

## 14. 課金（Stripe）
- 決済：Stripe
- 月額 + 年額
- 無料トライアル：30日（トライアル中はPro扱い）
- トライアル終了：
  - 課金されない場合：Freeへ戻す（降格ルール適用）
- 解約：期間満了までPro維持
- 支払い失敗：猶予3日（猶予中Pro維持）
- Webhook：推奨イベント網羅（全て購読・処理）
- 価格表示：Manageのみ（Publicには出さない）
- 購入導線：ダッシュボード＋設定（プラン/課金）

---

## 15. 退会（アカウント削除）
- 実行者：本人 / Admin（どちらも可）
- 論理削除 → 30日後に物理削除
- 退会前確認：handle + 30日後物理削除の説明のみ
- 誤操作防止：パスワード再入力必須
- 30日以内は取り消し（復元）可能
- 退会猶予中：
  - Public：404
  - Manage：ログイン可（復元操作のみ）

---

## 16. メール未登録ユーザー
- メール未登録：許可（ソーシャルのみで利用開始OK）
- メール未登録ユーザー：メール送信しない（Manage内通知のみ）
- パスワードリセット：メール＋パス登録者はメールで可能
- 後からメール＋パス追加：可能（OTPリンクでverified後に有効化）
- ソーシャル喪失時：救済なし（復旧不可）
- ただし、メール未登録状態にはUIで警告し、メール追加を促す
